<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-24 Mon 11:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=1024, initial-scale=1" />
<title>RPI Tools</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Mitch Richling" />
<meta name="description" content="Software to integrate RPI cameras with ImageJ"
 />
<meta name="keywords" content="fiji imagej rpi raspberry pi hq camera" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style>body { width: 95%; margin: 2% auto; font-size: 18px; line-height: 1.4em; font-family: Georgia, serif; color: black; background-color: white; }</style>
<style>body { min-width: 500px; max-width: 1024px; }</style>
<style>h1,h2,h3,h4,h5,h6 { color: #A5573E; line-height: 1em; font-family: Helvetica, sans-serif; }</style>
<style>h1,h2,h3 { line-height: 1.4em; }</style>
<style>h1.title { font-size: 3em; }</style>
<style>h4,h5,h6 { font-size: 1em; }</style>
<style>.org-src-container { border: 1px solid #ccc; box-shadow: 3px 3px 3px #eee; font-family: Lucida Console, monospace; font-size: 80%; margin: 0px; padding: 0px 0px; position: relative; }</style>
<style>.org-src-container>pre { line-height: 1.2em; padding-top: 1.5em; margin: 0.5em; background-color: #404040; color: white; overflow: auto; }</style>
<style>.org-src-container>pre:before { display: block; position: absolute; background-color: #b3b3b3; top: 0; right: 0; padding: 0 0.2em 0 0.4em; border-bottom-left-radius: 8px; border: 0; color: white; font-size: 100%; font-family: Helvetica, sans-serif;}</style>
<style>pre.example { white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -o-pre-wrap; font-family: Lucida Console, monospace; font-size: 80%; background: #404040; color: white; display: block; padding: 0em; border: 2px solid black; }</style>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://github.com/richmit/microscope"> UP </a>
 |
 <a accesskey="H" href="https://www.mitchr.me/"> HOME </a>
</div><div id="content">
<h1 class="title">RPI Tools</h1>
<table border="2 solid #ccc" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" align="center">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right"><b>Author:</b></td>
<td class="org-left"><i>Mitch Richling</i></td>
</tr>

<tr>
<td class="org-right"><b>Updated:</b></td>
<td class="org-left"><i>2022-01-24</i></td>
</tr>
</tbody>
</table>
<p align="center">
Copyright 2022 Mitch Richling. All rights reserved.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#rpi-soft">1. RPI Software</a>
<ul>
<li><a href="#rpi-pisnap">1.1. RPI Image Capture Script</a></li>
<li><a href="#rpi-imagej">1.2. ImageJ/Fiji Toolset/Macros</a></li>
</ul>
</li>
</ul>
</div>
</div>

<p>
Check out my home page for more stuff: <a href="https://www.mitchr.me/">https://www.mitchr.me/</a>
</p>

<div id="outline-container-rpi-soft" class="outline-2">
<h2 id="rpi-soft"><span class="section-number-2">1</span> RPI Software</h2>
<div class="outline-text-2" id="text-rpi-soft">
<p>
My goals:
</p>

<ul class="org-ul">
<li>Capture images directly from ImageJ/Fiji so I could immediately preform an image analysis</li>
<li>My #1 most used image analysis activity is measuring stuff (lengths, etc&#x2026;) so setting image scale needs to be easy</li>
<li>Capture images from the command line as well, but such that it is easy to load them in ImageJ/Fiji later</li>
<li>See a live view from the camera</li>
<li>Simple to sync data between camera and primary workstation</li>
<li>Identical ImageJ/Fiji UI between Windows and RPI</li>
</ul>

<p>
In the end I wrote a command line script and a set of ImageJ/Fiji toolbar macros that work together. I say they work together in that they both save newly
captured images to the same directory using the same file name conventions.  For example, this makes it easy to load the last thing captured by the command
line script into ImageJ/Fiji.
</p>
</div>

<div id="outline-container-rpi-pisnap" class="outline-3">
<h3 id="rpi-pisnap"><span class="section-number-3">1.1</span> RPI Image Capture Script</h3>
<div class="outline-text-3" id="text-rpi-pisnap">
<p>
This script is pretty simple.  It provides a way to capture one or more images outside of ImageJ/Fiji, but in a way compatible with the ImageJ/Fiji macros
provided below.  I use this script quite a lot to provide a live view of the camera feed.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ffa500;">#</span><span style="color: #ff7f24;">!/bin/</span><span style="color: #00ffff;">bash</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">-*- Mode:Shell-script; Coding:us-ascii-unix; fill-column:158 -*-</span>
<span style="color: #ffa500;">################################################################################################################################################################</span>
<span style="color: #ffa500;">##</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@file      piSnap.sh</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@author    Mitch Richling https://www.mitchr.me</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@brief     @EOL</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@keywords  raspberry pi hq camera image capture</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@std       bash</span>
<span style="color: #ffa500;"># </span><span style="color: #ff7f24;">@copyright </span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">@parblock</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">Copyright (c) 2021, Mitchell Jay Richling <a href="https://www.mitchr.me">&lt;https://www.mitchr.me&gt;</a> All rights reserved.</span>
<span style="color: #ffa500;">#</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<span style="color: #ffa500;">#</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">1. Redistributions of source code must retain the above copyright notice, this list of conditions, and the following disclaimer.</span>
<span style="color: #ffa500;">#</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions, and the following disclaimer in the documentation</span>
<span style="color: #ffa500;">#     </span><span style="color: #ff7f24;">and/or other materials provided with the distribution.</span>
<span style="color: #ffa500;">#</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without</span>
<span style="color: #ffa500;">#     </span><span style="color: #ff7f24;">specific prior written permission.</span>
<span style="color: #ffa500;">#</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span style="color: #ffa500;">#  </span><span style="color: #ff7f24;">@endparblock</span>
<span style="color: #ffa500;">################################################################################################################################################################</span>

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #b0c4de;">read</span> -r -d <span style="color: #fa8072;">''</span> HELPT &lt;&lt;EOF

<span style="color: #cdcd00; font-weight: bold;">Take a snapshot using the Raspberry Pi HQ Camera and save it in a standard way</span>

<span style="color: #cdcd00; font-weight: bold;">Use: piSnap.sh [options]</span>
<span style="color: #cdcd00; font-weight: bold;">  Options:</span>
<span style="color: #cdcd00; font-weight: bold;">    -p        Preview!  No images are captured. Other arguments are ignored</span>
<span style="color: #cdcd00; font-weight: bold;">    -k        Show a preview, and capture when [enter] is pressed.  </span>
<span style="color: #cdcd00; font-weight: bold;">              Without -k an image is immediatly captured with no preview</span>
<span style="color: #cdcd00; font-weight: bold;">    -s        Show image after capture with nomacs</span>
<span style="color: #cdcd00; font-weight: bold;">    -a ANNO   Annotation</span>
<span style="color: #cdcd00; font-weight: bold;">    -g GROUP  Group name -- used for grouping similar captures</span>
<span style="color: #cdcd00; font-weight: bold;">              Adds a "_GROUP-NNN" component to the captured filename where</span>
<span style="color: #cdcd00; font-weight: bold;">              GROUP is the group name provided on the command line and NNN</span>
<span style="color: #cdcd00; font-weight: bold;">              is a zero padded integer index.  If the previous capture has</span>
<span style="color: #cdcd00; font-weight: bold;">              a diffrent group name, then the current capture will have a</span>
<span style="color: #cdcd00; font-weight: bold;">              fresh time stamp in the name and an index of 001.  If the</span>
<span style="color: #cdcd00; font-weight: bold;">              previous capture has the same group name, then the current</span>
<span style="color: #cdcd00; font-weight: bold;">              capture will reuse the time stamp in the name and an index</span>
<span style="color: #cdcd00; font-weight: bold;">              incremented by 1.</span>
<span style="color: #cdcd00; font-weight: bold;">    -v        Verbose mode</span>
<span style="color: #cdcd00; font-weight: bold;">    -f        Fake Capture Mode that uses convert instead of libcamera-still</span>
<span style="color: #cdcd00; font-weight: bold;">              Used for debugging.  Most useful when combined with -v.</span>
<span style="color: #cdcd00; font-weight: bold;">    -b BIN    Full path to the libcamera-still binary</span>
<span style="color: #cdcd00; font-weight: bold;">              Default: /usr/bin/libcamera-still</span>
<span style="color: #cdcd00; font-weight: bold;">    -d DIR    Directory to store captured images.  </span>
<span style="color: #cdcd00; font-weight: bold;">              Default: $HOME/Pictures/pi-cam</span>
<span style="color: #cdcd00; font-weight: bold;">              Note: The related ImageJ/Fiji macro expects the default value!</span>
<span style="color: #cdcd00; font-weight: bold;">    -e ENC    File format: jpg, bmp, gif, png, rgb</span>
<span style="color: #cdcd00; font-weight: bold;">              Default: jpg</span>
<span style="color: #cdcd00; font-weight: bold;">  File Names</span>
<span style="color: #cdcd00; font-weight: bold;">    Image names are like: YYYYMMDDHHMMSS_GROUP-ANNOTATION.ENC</span>
<span style="color: #cdcd00; font-weight: bold;">                          |              |     |</span>
<span style="color: #cdcd00; font-weight: bold;">                          |              |     File Annoation</span>
<span style="color: #cdcd00; font-weight: bold;">                          |              Group Name</span>
<span style="color: #cdcd00; font-weight: bold;">                          date/time stamp</span>
<span style="color: #cdcd00; font-weight: bold;">      - The "_GROUP" component of the name will not be pressent </span>
<span style="color: #cdcd00; font-weight: bold;">        if the -g option was not provided.</span>
<span style="color: #cdcd00; font-weight: bold;">      - The "-ANNOTATION" component of the name will not be pressent </span>
<span style="color: #cdcd00; font-weight: bold;">        if the -a option was not provided.</span>
<span style="color: #cdcd00; font-weight: bold;">      - The -a and -g arguments are translated automatically into</span>
<span style="color: #cdcd00; font-weight: bold;">        something suitable:  </span>
<span style="color: #cdcd00; font-weight: bold;">          - Non-alphanumeric characters are converted to underscores.  </span>
<span style="color: #cdcd00; font-weight: bold;">          - Leading underscores and dashes are removed</span>
<span style="color: #cdcd00; font-weight: bold;">          - The -g argument has all dashes removed</span>
<span style="color: #cdcd00; font-weight: bold;">EOF</span>

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #7fffd4;">FAKE_CAP</span>=<span style="color: #fa8072;">'N'</span>
<span style="color: #7fffd4;">SHOW</span>=<span style="color: #fa8072;">'N'</span>
<span style="color: #7fffd4;">WKEY</span>=<span style="color: #fa8072;">'N'</span>
<span style="color: #7fffd4;">VERB</span>=<span style="color: #fa8072;">'N'</span>
<span style="color: #7fffd4;">PREVIEW</span>=<span style="color: #fa8072;">'N'</span>
<span style="color: #7fffd4;">GROUP</span>=<span style="color: #fa8072;">''</span>
<span style="color: #7fffd4;">OGROUP</span>=<span style="color: #fa8072;">''</span>
<span style="color: #7fffd4;">ANNOT</span>=<span style="color: #fa8072;">''</span>
<span style="color: #7fffd4;">OANNOT</span>=<span style="color: #fa8072;">''</span>
<span style="color: #7fffd4;">ODIR</span>=<span style="color: #fa8072;">"$HOME/Pictures/pi-cam"</span>
<span style="color: #7fffd4;">IENC</span>=<span style="color: #fa8072;">'jpg'</span>
<span style="color: #7fffd4;">RASPISP</span>=<span style="color: #fa8072;">'/usr/bin/libcamera-still'</span>
<span style="color: #00ffff;">while</span> [[ <span style="color: #fa8072;">"$1"</span> = -* ]]; <span style="color: #00ffff;">do</span>
   <span style="color: #00ffff;">case</span> <span style="color: #fa8072;">"$1"</span><span style="color: #00ffff;"> in</span>
    -k ) <span style="color: #7fffd4;">WKEY</span>=<span style="color: #fa8072;">'Y'</span>;                                              ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Capture multiple images</span>
    -d ) <span style="color: #7fffd4;">ODIR</span>=<span style="color: #fa8072;">"$2"</span>; <span style="color: #b0c4de;">shift</span>;                                      ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Output directory</span>
    -g ) <span style="color: #7fffd4;">OGROUP</span>=<span style="color: #fa8072;">"$2"</span>; <span style="color: #b0c4de;">shift</span>;                                    ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Group name</span>
    -a ) <span style="color: #7fffd4;">OANNOT</span>=<span style="color: #fa8072;">"$2"</span>; <span style="color: #b0c4de;">shift</span>;                                    ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Annotation</span>
    -v ) <span style="color: #7fffd4;">VERB</span>=<span style="color: #fa8072;">'Y'</span>;                                              ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Verbose mode</span>
    -f ) <span style="color: #7fffd4;">FAKE_CAP</span>=<span style="color: #fa8072;">'Y'</span>;                                          ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Fake Capture mode</span>
    -e ) <span style="color: #7fffd4;">IENC</span>=<span style="color: #fa8072;">"$2"</span>; <span style="color: #b0c4de;">shift</span>;                                      ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Output image format</span>
    -s ) <span style="color: #7fffd4;">SHOW</span>=<span style="color: #fa8072;">'Y'</span>;                                              ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Open captured images</span>
    -p ) <span style="color: #7fffd4;">PREVIEW</span>=<span style="color: #fa8072;">'Y'</span>;                                           ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Preview only</span>
    -b ) <span style="color: #7fffd4;">RASPISP</span>=<span style="color: #fa8072;">"$2"</span>; <span style="color: #b0c4de;">shift</span>;                                   ;; <span style="color: #ffa500;"># </span><span style="color: #ff7f24;">Location of libcamera-still binary</span>
    *  ) <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: Unknown option: $1"</span>; <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"$HELPT"</span>; <span style="color: #00ffff;">exit</span>; ;;
   <span style="color: #00ffff;">esac</span>
   <span style="color: #b0c4de;">shift</span>;
<span style="color: #00ffff;">done</span>
<span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$OANNOT"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #7fffd4;">OANNOT</span>=<span style="color: #fa8072;">"$OANNOT"</span>
  <span style="color: #7fffd4;">ANNOT</span>=<span style="color: #bf3eff; font-weight: bold;">`echo -n "$OANNOT" | tr -sc '[[:graph:]]' '_' |                 sed 's/[-_]*$//' | sed 's/^[-_]*//' `</span>
<span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$OGROUP"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #7fffd4;">GROUP</span>=<span style="color: #bf3eff; font-weight: bold;">`echo -n "$OGROUP" | tr -sc '[[:graph:]]' '_' | tr -s '-' '_' | sed 's/[-_]*$//' | sed 's/^[-_]*//' `</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$VERB"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>                     
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: WKEY     $WKEY     "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: VERB     $VERB     "</span> 
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: PREVIEW  $PREVIEW  "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: ANNOT    $ANNOT    "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: OANNOT   $OANNOT   "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: GROUP    $GROUP    "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: OGROUP   $OGROUP   "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: WIDTH    $WIDTH    "</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: ODIR     $ODIR     "</span> 
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: IENC     $IENC     "</span>
<span style="color: #00ffff;">fi</span>    

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$2"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: Arguments ignored: $@"</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"$HELPT"</span>
  <span style="color: #00ffff;">exit</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #00ffff;">if</span> [[ ! <span style="color: #fa8072;">"$IENC"</span> =~ ^(jpg|bmp|gif|png|rgb)$ ]]; <span style="color: #00ffff;">then</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: Encodeing of '$IENC' is not supported!"</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"$HELPT"</span>
  <span style="color: #00ffff;">exit</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #00ffff;">if</span> [ ! -x <span style="color: #fa8072;">"$RASPISP"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$FAKE_CAP"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$VERB"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>                     
      <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: In FAKE_CAP mode. Didn't find $RASPISP"</span>
    <span style="color: #00ffff;">fi</span>
  <span style="color: #00ffff;">else</span>
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: $RASPISP not found!"</span>
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"$HELPT"</span>
    <span style="color: #00ffff;">exit</span>
  <span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #00ffff;">if</span> [ ! -d <span style="color: #fa8072;">"$ODIR"</span> ]; <span style="color: #00ffff;">then</span>
  mkdir <span style="color: #fa8072;">"$ODIR"</span>
  <span style="color: #00ffff;">if</span> [ -d <span style="color: #fa8072;">"$ODIR"</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"WARNING: Output directory was created: $ODIR"</span>
  <span style="color: #00ffff;">else</span>
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: Output directory not found/created: $ODIR"</span>
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"$HELPT"</span>
    <span style="color: #00ffff;">exit</span>
  <span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$RASPISP"</span>
<span style="color: #7fffd4;">OFILE</span>=<span style="color: #fa8072;">''</span>
<span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$IENC"</span> = <span style="color: #fa8072;">"raw"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -r"</span>
  <span style="color: #7fffd4;">IENC</span>=<span style="color: #fa8072;">'jpg'</span>
<span style="color: #00ffff;">fi</span>

<span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$PREVIEW"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -t 0"</span>
<span style="color: #00ffff;">else</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$WKEY"</span> = <span style="color: #fa8072;">"Y"</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -t 0 -k"</span>
  <span style="color: #00ffff;">else</span>
    <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -t 1 -n"</span>
  <span style="color: #00ffff;">fi</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$IENC"</span> = <span style="color: #fa8072;">"jpg"</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -q 100"</span>
  <span style="color: #00ffff;">fi</span>
  <span style="color: #7fffd4;">OFILE</span>=$<span style="color: #7fffd4;">ODIR</span><span style="color: #fa8072;">'/'</span><span style="color: #bf3eff; font-weight: bold;">`date '+%Y%m%d%H%M%S'`</span>
  <span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$GROUP"</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #7fffd4;">OFILE</span>=${<span style="color: #7fffd4;">OFILE</span>}<span style="color: #fa8072;">'_'</span>${<span style="color: #7fffd4;">GROUP</span>}
  <span style="color: #00ffff;">fi</span>
  <span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$ANNOT"</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #7fffd4;">OFILE</span>=${<span style="color: #7fffd4;">OFILE</span>}<span style="color: #fa8072;">'-'</span>${<span style="color: #7fffd4;">ANNOT</span>}
  <span style="color: #00ffff;">fi</span>
  <span style="color: #7fffd4;">OFILE</span>=${<span style="color: #7fffd4;">OFILE</span>}<span style="color: #fa8072;">'.'</span>$<span style="color: #7fffd4;">IENC</span>
  <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"$DACMD -e $IENC -o $OFILE"</span>
<span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$VERB"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>                     
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: Command to run: $DACMD"</span>
<span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$FAKE_CAP"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$PREVIEW"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">'true'</span>
  <span style="color: #00ffff;">else</span>
    <span style="color: #7fffd4;">DACMD</span>=<span style="color: #fa8072;">"convert -size 1024x1024 xc:white $OFILE"</span>
  <span style="color: #00ffff;">fi</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$VERB"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>                     
    <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"DEBUG: In FAKE_CAP mode. New command to run: $DACMD"</span>
  <span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">fi</span>
$<span style="color: #7fffd4;">DACMD</span>

<span style="color: #ffa500;">#</span><span style="color: #ff7f24;">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span style="color: #00ffff;">if</span> [ -n <span style="color: #fa8072;">"$OFILE"</span> -a -e <span style="color: #fa8072;">"$OFILE"</span> ]; <span style="color: #00ffff;">then</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"INFO: Captured Image File:"</span>
  ls -l <span style="color: #fa8072;">"$OFILE"</span> | sed <span style="color: #fa8072;">'s/^/    /'</span>
  <span style="color: #00ffff;">if</span> [ <span style="color: #fa8072;">"$SHOW"</span> = <span style="color: #fa8072;">'Y'</span> ]; <span style="color: #00ffff;">then</span>
    <span style="color: #00ffff;">if</span> [ -x <span style="color: #fa8072;">'/usr/bin/nomacs'</span> ]; <span style="color: #00ffff;">then</span>
      /usr/bin/nomacs <span style="color: #fa8072;">"$OFILE"</span>
    <span style="color: #00ffff;">else</span>
      <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">'ERROR: Unable to open image (/usr/bin/nomacs) not found.'</span>
    <span style="color: #00ffff;">fi</span>
  <span style="color: #00ffff;">fi</span>
<span style="color: #00ffff;">else</span>
  <span style="color: #b0c4de;">echo</span> <span style="color: #fa8072;">"ERROR: No image captured!"</span>
<span style="color: #00ffff;">fi</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-rpi-imagej" class="outline-3">
<h3 id="rpi-imagej"><span class="section-number-3">1.2</span> ImageJ/Fiji Toolset/Macros</h3>
<div class="outline-text-3" id="text-rpi-imagej">
<p>
The code below provides an ImageJ/Fiji toolset.  You activate the tool set via the toolset menu:
</p>


<div id="orgf2cc5be" class="figure">
<p><img src="RPI_Tools-toolsetmenu.gif" alt="RPI_Tools-toolsetmenu.gif" align="center" width="800" />
</p>
</div>

<p>
Once activated, it will add four buttons to the toolbar:
</p>


<div id="org68004fc" class="figure">
<p><img src="RPI_Tools-toolsetbuttons.gif" alt="RPI_Tools-toolsetbuttons.gif" align="center" width="800" />
</p>
</div>

<p>
Button Functions:
</p>
<dl class="org-dl">
<dt><img src="RPI_Tools-toolsetbutton-capture.gif" alt="RPI_Tools-toolsetbutton-capture.gif" />  </dt><dd>Capture, ssave, and open an image from the camera.  Images are stored in the same location, and with the same file name conventions, used by <code>piSnap.sh</code>.</dd>
<dt><img src="RPI_Tools-toolsetbutton-settings.gif" alt="RPI_Tools-toolsetbutton-settings.gif" /> </dt><dd>Change some configuration options</dd>
</dl>


<div id="org16336b4" class="figure">
<p><img src="RPI_Tools-dialog-settings.gif" alt="RPI_Tools-dialog-settings.gif" align="center" width="400px" />
</p>
</div>

<ul class="org-ul">
<li>Specify a group for the captured image filenames.  See <a href="#rpi-pisnap"><code>piSnap</code></a> for filename details.</li>
<li>Specify an annotation for the captured image filenames.  See <a href="#rpi-pisnap"><code>piSnap</code></a> for filename details.</li>
<li>Set captured image format (jpg or png)</li>
<li>Set captured image scale (100% or 50%)</li>
<li>Set the scale factor for capture preview</li>
<li>Set the scale factor for the live video feed</li>
<li>Turn on/off asking for settings for each capture &#x2013; essentially pops up the settings dialog box everything the capture button is hit</li>
<li>Turn on/off repeated capture mode &#x2013; repeatedly captures images.  Most useful if a group is set.</li>
<li>Turn on/off live video preview before a capture.</li>
<li>Turn on/off loading images after capture.</li>
<li>Turn on/off running the set image scale tool after each capture if the image scale is not already set</li>
<li>Turn on/off debugging</li>
</ul>
<dl class="org-dl">
<dt><img src="RPI_Tools-toolsetbutton-video.gif" alt="RPI_Tools-toolsetbutton-video.gif" />     </dt><dd>Live video feed from camera.  Note the scale setting for the live video feed is diffrent from the capture preview scale.</dd>
</dl>

<p>
If "Change Settings Before Capture" is set, then a simplified settings dialog box will appear before the video feed window.
</p>


<div id="org18176b8" class="figure">
<p><img src="RPI_Tools-dialog-settings-v.gif" alt="RPI_Tools-dialog-settings-v.gif" align="center" width="400px" />
</p>
</div>


<dl class="org-dl">
<dt><img src="RPI_Tools-toolsetbutton-load.gif" alt="RPI_Tools-toolsetbutton-load.gif" />     </dt><dd>Load previous capture(s) from camera using the ImageJ/Fiji macro above or the <code>piSnap.sh</code> script.</dd>
</dl>


<div id="org53e8049" class="figure">
<p><img src="RPI_Tools-dialog-loadOld.gif" alt="RPI_Tools-dialog-loadOld.gif" align="center" width="400px" />
</p>
</div>

<dl class="org-dl">
<dt><img src="RPI_Tools-toolsetbutton-scale.gif" alt="RPI_Tools-toolsetbutton-scale.gif" />    </dt><dd>Set image scale based upon microscope settings.  This script contains hardwired settings for my specific microscope and lenses, and may require modification for your microscope.</dd>
</dl>


<div id="org4bf1942" class="figure">
<p><img src="RPI_Tools-dialog-setscale.gif" alt="RPI_Tools-dialog-setscale.gif" align="center" width="400px" />
</p>
</div>

<ul class="org-ul">
<li>The choice of microscope enables a calibration correction factor in the final computation</li>
<li>The "Adjust for Resolution" option adjusts the scale if the number of horizontal pixels in the image differs from the horizontal resolution of the
sensor.  Most commonly this use used when the sensor is used in 2x2 mode yielding smaller image.  This option also works if the image is resized after
the fact.</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #ffa500;">// </span><span style="color: #ff7f24;">-*- Mode:C++; Coding:us-ascii-unix; fill-column:158 -*-</span>
<span style="color: #ffa500;">//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">@file      RPI_tools.ijm</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">@author    Mitch Richling https://www.mitchr.me</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">@brief     This file is GENERATED from base-code.ijm &amp; RPI_tools-toolset.ijm -- see the source files copyright &amp; other information.</span>
<span style="color: #ffa500;">//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>
<span style="color: #ffa500;">///</span>

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//// </span><span style="color: #ff7f24;">Global Parameters</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_colors</span>    = newArray(<span style="color: #fa8072;">"black"</span>, <span style="color: #fa8072;">"blue"</span>, <span style="color: #fa8072;">"green"</span>, <span style="color: #fa8072;">"red"</span>, <span style="color: #fa8072;">"yellow"</span>, <span style="color: #fa8072;">"white"</span>); <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_lineWidth</span> = newArray(<span style="color: #fa8072;">"1"</span>, <span style="color: #fa8072;">"3"</span>, <span style="color: #fa8072;">"5"</span>, <span style="color: #fa8072;">"11"</span>, <span style="color: #fa8072;">"15"</span>, <span style="color: #fa8072;">"25"</span>, <span style="color: #fa8072;">"35"</span>);              <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_lnUnits</span>   = newArray(<span style="color: #fa8072;">"mm"</span>, <span style="color: #fa8072;">"mil"</span>, <span style="color: #fa8072;">"cm"</span>, <span style="color: #fa8072;">"inch"</span>);                          <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_numPerf</span>   = newArray(<span style="color: #fa8072;">"5"</span>, <span style="color: #fa8072;">"10"</span>, <span style="color: #fa8072;">"15"</span>, <span style="color: #fa8072;">"20"</span>, <span style="color: #fa8072;">"25"</span>);                        <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_p2mdiv</span>    = newArray(<span style="color: #fa8072;">"0.1"</span>, <span style="color: #fa8072;">"0.25"</span>, <span style="color: #fa8072;">"0.5"</span>);                               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_pfGrdCnt</span>  = newArray(<span style="color: #fa8072;">"AUTO"</span>, <span style="color: #fa8072;">"10"</span>, <span style="color: #fa8072;">"20"</span>, <span style="color: #fa8072;">"30"</span>, <span style="color: #fa8072;">"40"</span>, <span style="color: #fa8072;">"50"</span>);               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_pfUnits</span>   = newArray(<span style="color: #fa8072;">"mm"</span>, <span style="color: #fa8072;">"mil"</span>, <span style="color: #fa8072;">"perfs/2cm"</span>);                           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_pviewScl</span>  = newArray(<span style="color: #fa8072;">"1"</span>, <span style="color: #fa8072;">"2"</span>, <span style="color: #fa8072;">"4"</span>, <span style="color: #fa8072;">"8"</span>);                                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List: Microscope preview scale</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_letters</span>   = newArray(<span style="color: #fa8072;">"A"</span>, <span style="color: #fa8072;">"B"</span>, <span style="color: #fa8072;">"C"</span>, <span style="color: #fa8072;">"D"</span>, <span style="color: #fa8072;">"E"</span>, <span style="color: #fa8072;">"F"</span>, <span style="color: #fa8072;">"G"</span>, <span style="color: #fa8072;">"H"</span>, <span style="color: #fa8072;">"I"</span>,         <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Letter sequence -- mostly for lables</span>
                                 <span style="color: #fa8072;">"J"</span>, <span style="color: #fa8072;">"K"</span>, <span style="color: #fa8072;">"L"</span>, <span style="color: #fa8072;">"M"</span>, <span style="color: #fa8072;">"N"</span>, <span style="color: #fa8072;">"O"</span>, <span style="color: #fa8072;">"P"</span>, <span style="color: #fa8072;">"Q"</span>, <span style="color: #fa8072;">"R"</span>,
                                 <span style="color: #fa8072;">"S"</span>, <span style="color: #fa8072;">"T"</span>, <span style="color: #fa8072;">"U"</span>, <span style="color: #fa8072;">"V"</span>, <span style="color: #fa8072;">"W"</span>, <span style="color: #fa8072;">"X"</span>, <span style="color: #fa8072;">"Y"</span>, <span style="color: #fa8072;">"Z"</span>, <span style="color: #fa8072;">"a"</span>,
                                 <span style="color: #fa8072;">"b"</span>, <span style="color: #fa8072;">"c"</span>, <span style="color: #fa8072;">"d"</span>, <span style="color: #fa8072;">"e"</span>, <span style="color: #fa8072;">"f"</span>, <span style="color: #fa8072;">"g"</span>, <span style="color: #fa8072;">"h"</span>, <span style="color: #fa8072;">"i"</span>, <span style="color: #fa8072;">"j"</span>,
                                 <span style="color: #fa8072;">"k"</span>, <span style="color: #fa8072;">"l"</span>, <span style="color: #fa8072;">"m"</span>, <span style="color: #fa8072;">"n"</span>, <span style="color: #fa8072;">"o"</span>, <span style="color: #fa8072;">"p"</span>, <span style="color: #fa8072;">"q"</span>, <span style="color: #fa8072;">"r"</span>, <span style="color: #fa8072;">"s"</span>,
                                 <span style="color: #fa8072;">"t"</span>, <span style="color: #fa8072;">"u"</span>, <span style="color: #fa8072;">"v"</span>, <span style="color: #fa8072;">"w"</span>, <span style="color: #fa8072;">"x"</span>, <span style="color: #fa8072;">"y"</span>, <span style="color: #fa8072;">"z"</span>);
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_sGauges</span>   = newArray(<span style="color: #fa8072;">"Updated Kiusalas Perforation Gauge"</span>,                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List: Known Specialized Gauges</span>
                                 <span style="color: #fa8072;">"Traditional Kiusalas Perforation Gauge"</span>,
                                 <span style="color: #fa8072;">"Liberty Issue Perforation Gauge"</span>,
                                 <span style="color: #fa8072;">"Bari Wolf Issue Perforation Gauge"</span>,
                                 <span style="color: #fa8072;">"Single Line Custom Perforation Gauge"</span>);
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_OLT_fontMag</span>  = newArray(<span style="color: #fa8072;">"25%"</span>, <span style="color: #fa8072;">"50%"</span>, <span style="color: #fa8072;">"75%"</span>, <span style="color: #fa8072;">"100%"</span>, <span style="color: #fa8072;">"150%"</span>, <span style="color: #fa8072;">"200%"</span>, <span style="color: #fa8072;">"300%"</span>);               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Option List: Font size magnfication </span>

<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_color1</span>    = <span style="color: #fa8072;">"yellow"</span>;             <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_color2</span>    = <span style="color: #fa8072;">"blue"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_debug</span>     = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option: Debuging messages</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_doScl</span>     = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option: Set scale after RPI capture/load</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_fMag</span>      = <span style="color: #fa8072;">"100%"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Font size magnification</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_fillDots</span>  = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay: Fill dots in gauges (specialized &amp; dynamic)</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_font</span>      = <span style="color: #fa8072;">"SanSerif"</span>;           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_lastPhOvr</span> = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option: Last PhilaJ Overlay drawn</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_lineWidth</span> = <span style="color: #fa8072;">"3"</span>;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_numPerf</span>   = <span style="color: #fa8072;">"15"</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option: Number of perf holes or lines on gauge overlays -- note it is a string</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ALL_perfOrder</span> = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Multi-Tool Option: Ordering of perf sizes top to bottom</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cer_edges</span>     = <span style="color: #fa8072;">"Vertical"</span>;           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coil Edge Report: Coil Format -- coilEdgeReport</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cer_minTal</span>    = 25.0;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coil Edge Report: minimum paper height -- coilEdgeReport</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cer_minWid</span>    = 22.5;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coil Edge Report: minimum paper width -- coilEdgeReport</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cer_nParThr</span>   =  0.5;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coil Edge Report: Near Parallel Threshold -- coilEdgeReport</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cer_parThr</span>    =  0.1;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coil Edge Report: Parallel Threshold -- coilEdgeReport</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cot_ROItag</span>    = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coordinate Tool: If not empty, then add ROI to ROI Manager</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cot_clickMeas</span> = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coordinate Tool: Measure point ROI for each click</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cot_clickOvr</span>  = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coordinate Tool: Add point ROI to overlay for each click</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_cot_cordIdx</span>   = 0;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Coordinate Tool: Internal counter of how many points have been created so far in this session</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_csg_file</span>      = getDirectory(<span style="color: #fa8072;">"home"</span>); <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">File Based Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_d2p_holes</span>     = 15;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Distance to Perforation: hole count</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_d2p_len</span>       = 20;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Distance to Perforation: length</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_HUDdo</span>     = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Show the perf HUD all the time</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_HUDpx</span>     = NaN;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: X coordinate (in pixels) for perf HUD (NaN means image center)</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_HUDpy</span>     = NaN;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Y coordinate (in pixels) for perf HUD (NaN means image center)</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_autoRep</span>   = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Show dynamic report dialog all the time</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_dotSz</span>     = 1;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Size of dots</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_dotSzMn</span>   = 0.5;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Minimum size of dots</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_dotSzMx</span>   = 1.5;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Maximum size of dots</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_nuGap</span>     = 1.5;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Size of perf gap for newly drawn gauges</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_numPerf</span>   = 15;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Number fo perf holes. Note it is a number, and we do not use gbl_ALL_numPerf</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_rimt</span>      = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: Put results in results table or in new window</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_roiMgrU</span>   = <span style="color: #fa8072;">"NONE"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: How ROI manager is used</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_dyn_roiPfx</span>    = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Dynamic Perforation Gauge: ROI prefix to use for ROI bound ROIs</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_doMGB</span>     = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_doOut</span>     = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_doPbox</span>    = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_doPcross</span>  = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_doPridge</span>  = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_numH</span>      = 14;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template: Number of grill points horizontally</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_numV</span>      = 17;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template: Number of grill points vertically</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_ptype</span>     = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template: Previously selected grill type</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_grl_type</span>      = <span style="color: #fa8072;">"E"</span>;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Grill Template: Selected grill type</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_l2l_len</span>       = 1;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Length Conversion Tool: Length to convert</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_l2l_units</span>     = <span style="color: #fa8072;">"inch"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Length Conversion Tool: Units to convert from</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_lil_group</span>     = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Load Last RPI Image: group name</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_lil_which</span>     = <span style="color: #fa8072;">"Last"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Load Last RPI Image: Which ones (first, last, etc...)</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_nst_mFrc</span>      = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Instanta Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_nst_mdiv</span>      = <span style="color: #fa8072;">"0.1"</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Instanta Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_nst_pMax</span>      = 14;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Instanta Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_nst_pMin</span>      = 9;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Instanta Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pcv_inv</span>       = 0;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Perferation unit conversion: value to convert</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_anno</span>      = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: File annotation for RPI captured images</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_doSet</span>     = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Change settings before RPI capture</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_group</span>     = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: File group name for RPI captured images</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_ifmt</span>      = <span style="color: #fa8072;">"jpg"</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Image Format for RPI captured images</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_loadem</span>    = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Load image after capture</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_pviewDo</span>   = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Video preview before RPI capture</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_pviewScl</span>  = 4;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: RPI Capture Preview Scale (1/n)</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_repeat</span>    = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Repeated RPI capture mode</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_res</span>       = <span style="color: #fa8072;">"100%"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Image Size for RPI captured images</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pic_useCam</span>    = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Image Capture: Use the camera or fake it</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pos_gridSize</span>  = 3;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Position Finder Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pos_numGrids</span>  = <span style="color: #fa8072;">"AUTO"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Position Finder Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pos_origX</span>     = 0;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Position Finder Overlay: x coordinate of the upper left origion of grid in pixels</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_pos_origY</span>     = 0;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Position Finder Overlay: y coordinate of the upper left origion of grid in pixels</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_r2d_targDPI</span>   = 2400;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Resize To DPI:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_rho_angle</span>     = 0;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Rotate to Horizontal: Angle to rotate</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_spl_gName</span>     = gbl_OLT_sGauges[0];   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_spl_perfDiams</span> = newArray();           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_spl_perfGaps</span>  = newArray();           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_spl_perfLabs</span>  = newArray();           <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_spl_useDots</span>   = <span style="color: #8470ff; font-weight: bold;">true</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_aux</span>       = <span style="color: #fa8072;">"0.63"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: Microscope Aux Lens</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_cam</span>       = <span style="color: #fa8072;">"RPI"</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: Camera</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_gbl</span>       = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: When setting RPI image scale, make it global</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_res</span>       = <span style="color: #8470ff; font-weight: bold;">false</span>;                <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: RPI Adjust for Resolution when scaleing images</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_scope</span>     = <span style="color: #fa8072;">"Leica S8API"</span>;        <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: Microscope Model</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_vobj</span>      = <span style="color: #fa8072;">"0.32"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: Microscope Video Objective</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssm_zoom</span>      = <span style="color: #fa8072;">"1.00"</span>;               <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale RPI Image: Microscope Zoom</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssp_gapu</span>      = <span style="color: #fa8072;">"perfs/2cm"</span>;          <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Single Line Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssp_gapv</span>      = 12;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Single Line Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssp_lab</span>       = <span style="color: #fa8072;">""</span>;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Single Line Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssp_sizu</span>      = <span style="color: #fa8072;">"mm"</span>;                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Single Line Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_ssp_sizv</span>      = 1;                    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Single Line Specialized Perforation Gauge Overlay:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_sus_cols</span>      = 10;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Slice Up Sheet:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_sus_rows</span>      = 10;                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Slice Up Sheet:</span>
<span style="color: #63b8ff;">var</span> <span style="color: #7fffd4;">gbl_vid_pviewScl</span>  = <span style="color: #fa8072;">"1"</span>;                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">RPI Live Video Preview: Live RPI Video Scale (1/n)</span>

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//// </span><span style="color: #ff7f24;">Functions</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure an OVERLAY potentially in combination with an existing selection</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philMeausreOverlay</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philMeausreOverlay): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"philMeausreOverlay"</span>);

  <span style="color: #00ffff;">if</span> (selectionType &gt;= 0)
    run(<span style="color: #fa8072;">"Measure"</span>);

  <span style="color: #00ffff;">if</span> (Overlay.size &gt; 0) {
    <span style="color: #00ffff;">if</span> ((gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"philPosFinderAction"</span>) || (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"dynamicPerfDraw"</span>)) {
      theSelType = selectionType;
      <span style="color: #00ffff;">if</span> (theSelType &gt;= 0) {
        theSelName = Roi.getName;
        Roi.getBounds(theSelX, theSelY, theSelWidth, theSelHeight);
        <span style="color: #00ffff;">if</span> (theSelType == 5)
          getLine(theSelX1, theSelY1, theSelX2, theSelY2, theSelLineWidth);
      }
      overlayType = getOverlayCapPointName();

      <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"philPosFinderAction"</span>) {
        posP1 = philPosFinderCoord(              theSelX,                theSelY, <span style="color: #8470ff; font-weight: bold;">true</span>);
        posP2 = philPosFinderCoord(theSelX + theSelWidth, theSelY + theSelHeight, <span style="color: #8470ff; font-weight: bold;">true</span>);
        pos = posP1 + <span style="color: #fa8072;">"-"</span> + posP2;
        <span style="color: #00ffff;">if</span> (gbl_pos_gridSize == 3)
          setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>Thirkell<span style="color: #ffc0cb; font-weight: bold;">'</span>, nResults-1, pos);
        <span style="color: #00ffff;">else</span>
          setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>pos<span style="color: #ffc0cb; font-weight: bold;">'</span>, nResults-1, pos);
        updateResults();
      } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"dynamicPerfDraw"</span>) {
        dynamicPerfMeasure();
      } <span style="color: #00ffff;">else</span> {
        gbl_ALL_lastPhOvr == <span style="color: #fa8072;">""</span>;
      }
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Compute coordinates for point.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philPosFinderCoord</span>(<span style="color: #63b8ff;">x</span>, <span style="color: #63b8ff;">y</span>, <span style="color: #63b8ff;">withOutOfBounds</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philPosFinderCoord): Function Entry: "</span>, x, y);

  ovlOff = getOverlayCapPointPos(<span style="color: #fa8072;">"philPosFinderAction"</span>);
  relX  = x - gbl_pos_origX;
  relY  = y - gbl_pos_origY;
  toScaled(relX, relY);
  relXg = floor(relX / gbl_pos_gridSize);
  relYg = floor(relY / gbl_pos_gridSize);

  <span style="color: #00ffff;">if</span> (relXg &lt; 0)
    <span style="color: #00ffff;">if</span> (withOutOfBounds)
      relXc = <span style="color: #fa8072;">"&lt;1"</span>;
    <span style="color: #00ffff;">else</span>
      <span style="color: #00ffff;">return</span> <span style="color: #fa8072;">"ERROR"</span>;
  <span style="color: #00ffff;">else</span>
    relXc = d2s(relXg + 1, 0);

  <span style="color: #00ffff;">if</span> (relYg &lt; 0)
    <span style="color: #00ffff;">if</span> (withOutOfBounds)
      relYc = <span style="color: #fa8072;">"&lt;A"</span>;
    <span style="color: #00ffff;">else</span>
      <span style="color: #00ffff;">return</span> <span style="color: #fa8072;">"ERROR"</span>;
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (relYg &gt; 51)
    <span style="color: #00ffff;">if</span> (withOutOfBounds)
      relYc = <span style="color: #fa8072;">"&gt;"</span> + gbl_OLT_letters[51];
    <span style="color: #00ffff;">else</span>
      <span style="color: #00ffff;">return</span> <span style="color: #fa8072;">"ERROR"</span>;
  <span style="color: #00ffff;">else</span>
    relYc = gbl_OLT_letters[relYg];

  pos = relYc + relXc;
  <span style="color: #00ffff;">return</span> pos;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Simple tool to compute perfs from distance &amp; hole count</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertDistanceToPerf</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(convertDistanceToPerf): Function Entry"</span>);

  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    <span style="color: #00ffff;">if</span> (selectionType == 5) {
      pixelLengthUnit = getImageScaleUnits(<span style="color: #fa8072;">"NONE"</span>);
      getLine(x1, y1, x2, y2, lineWidth);
      toScaled(x1, y1);
      toScaled(x2, y2);
      tmpLen1 = hypot2(x1, x2, y1, y2);
      tmpLen2 = convertLengthToMM(tmpLen1, pixelLengthUnit);
      <span style="color: #00ffff;">if</span> (isNaN(tmpLen2)) {
        showMessage(<span style="color: #fa8072;">"PhilaJ: convertDistanceToPerf"</span>, <span style="color: #fa8072;">"WARNING: Length measured of line ROI is in an unknown unit ("</span> + pixelLengthUnit + <span style="color: #fa8072;">")!"</span>);
        gbl_d2p_len = tmpLen1;
      } <span style="color: #00ffff;">else</span> {
        gbl_d2p_len = tmpLen2;
      }
    }
  }
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Convert distance to perferation measurement"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Distance:"</span>, gbl_d2p_len, 4, 10, <span style="color: #fa8072;">""</span>);
  Dialog.addToSameRow();
  Dialog.addChoice(<span style="color: #fa8072;">""</span>,          gbl_OLT_lnUnits,<span style="color: #fa8072;">"mm"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Holes:"</span>,    gbl_d2p_holes, 0, 3, <span style="color: #fa8072;">""</span>);
  Dialog.show();
  gbl_d2p_len    = Dialog.getNumber();
  lenUnits       = Dialog.getChoice();
  gbl_d2p_holes  = Dialog.getNumber();

  lenInMM = convertLengthToMM(gbl_d2p_len, lenUnits);

  perfFromDistReport(lenInMM, gbl_d2p_holes, -1, <span style="color: #8470ff; font-weight: bold;">false</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Simple tool to Convert Kiusalas to Perferations per 2cm")</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertKperfAndPerf20</span>(<span style="color: #63b8ff;">k2p</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(convertKperfAndPerf20): Function Entry"</span>);

  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Convert Kiusalas to Perferations per 2cm"</span>);
  <span style="color: #00ffff;">if</span> (k2p)
    Dialog.addNumber(<span style="color: #fa8072;">"Kiusalas:"</span>,    gbl_pcv_inv,   4, 10, <span style="color: #fa8072;">"mil"</span>);
  <span style="color: #00ffff;">else</span>
    Dialog.addNumber(<span style="color: #fa8072;">"Perferation:"</span>, gbl_pcv_inv,   4, 10, <span style="color: #fa8072;">"perf/2cm"</span>);
  Dialog.show();
  gbl_pcv_inv    = Dialog.getNumber();

  outv = 100000.0 / (127.0 * gbl_pcv_inv);

  <span style="color: #00ffff;">if</span> (k2p) {
    perf20 = outv;
    perfk  = gbl_pcv_inv;
  } <span style="color: #00ffff;">else</span> {
    perf20 = gbl_pcv_inv;
    perfk  = outv;
  }

  Quantity = newArray(   <span style="color: #fa8072;">"Perfs"</span>, <span style="color: #fa8072;">"Kiusalas"</span>);
  Value    = newArray(    perf20,      perfk);
  Unit     = newArray(<span style="color: #fa8072;">"perf/2cm"</span>,      <span style="color: #fa8072;">"mil"</span>);
  Array.show(<span style="color: #fa8072;">"PhilaJ: Perforation Report"</span>, Quantity, Value, Unit);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Search for inPat in anArray, and return index of frist element matching pattern.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">indexOfInArray</span>(<span style="color: #63b8ff;">anArray</span>, <span style="color: #63b8ff;">inPat</span>) {
  theIndex = -1;
  <span style="color: #00ffff;">for</span>(i=0; i&lt;anArray.length; i++) {
    <span style="color: #00ffff;">if</span> (matches(anArray[i], inPat)) {
      theIndex = i;
      <span style="color: #00ffff;">break</span>;
    }
  }
  <span style="color: #00ffff;">return</span> theIndex;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get a list of known specialized gauges</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getSpecializedGaugeList</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getSpecializedGaugeList): Function Entry"</span>);
  perfPath = pathJoin(newArray(getDirectory(<span style="color: #fa8072;">"home"</span>), <span style="color: #fa8072;">".philaj"</span>, <span style="color: #fa8072;">"perfs"</span>));
  <span style="color: #00ffff;">if</span> (File.isDirectory(perfPath)) {
    perfFiles = getFileList(perfPath);
    <span style="color: #00ffff;">if</span> (perfFiles.length &gt; 0) {
      perfFiles = Array.filter(perfFiles, <span style="color: #fa8072;">"(^[^ ][^ ]*\\.ijm$)"</span>);
      <span style="color: #00ffff;">if</span> (perfFiles.length &gt; 0) {
        <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
          print(<span style="color: #fa8072;">"DEBUG(getSpecializedGaugeList): Gauges found:: "</span> + String.join(perfFiles, <span style="color: #fa8072;">", "</span>));
        <span style="color: #00ffff;">for</span>(i=0; i&lt;perfFiles.length; i++) {
          perfFiles[i] = substring(replace(perfFiles[i], <span style="color: #fa8072;">"_"</span>, <span style="color: #fa8072;">" "</span>), 0, lengthOf(perfFiles[i])-4);
        }
        <span style="color: #00ffff;">return</span> Array.concat(gbl_OLT_sGauges, perfFiles);
      }
    }
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
      print(<span style="color: #fa8072;">"DEBUG(getSpecializedGaugeList): Custom perf path not found: "</span> + perfPath);
  }
  <span style="color: #00ffff;">return</span> gbl_OLT_sGauges;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Copy bounding box for current selection, and create new image with copied data.  Set scale for new image to the source image scale.  Tries to give the</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">new image a sensable name (something like ROI_from_file or from_file)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">selectionToImage</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(selectionToImage): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"selectionToImage"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  <span style="color: #00ffff;">if</span> (selectionType &lt; 0)
    exit(<span style="color: #fa8072;">"ERROR(selectionToImage): No active selection found!"</span>);

  srcImageTitle = getTitle();
  srcROI = Roi.getName;

  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);

  run(<span style="color: #fa8072;">"To Bounding Box"</span>);
  run(<span style="color: #fa8072;">"Copy"</span>);
  run(<span style="color: #fa8072;">"Internal Clipboard"</span>);

  run(<span style="color: #fa8072;">"Set Scale..."</span>, <span style="color: #fa8072;">" known="</span> + d2s(pixelWidth, 10) + <span style="color: #fa8072;">" unit=mm distance=1 pixel="</span> + d2s(pixelWidth/pixelHeight, 10));

  newTitle = srcROI;
  <span style="color: #00ffff;">if</span> (lengthOf(newTitle) &gt; 0)
    newTitle = newTitle + <span style="color: #fa8072;">"_"</span>;
  newTitle = newTitle + <span style="color: #fa8072;">"from_"</span> + srcImageTitle;
  rename(newTitle);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Spin till the user takes the finger off the mouse button</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">eatClicks</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(eatClicks): Function Entry"</span>);
  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    <span style="color: #00ffff;">do</span> {
      getCursorLoc(x, y, z, flags);
      wait(20);
    } <span style="color: #00ffff;">while</span> (flags != 0);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Delete ROIs related to design/paper measurements.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">deleteDesignAndPaperROIs</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(deleteDesignAndPaperROIs): Function Entry"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"ALL"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"paperBB"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"designBB"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"marginT"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"marginB"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"marginL"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"marginR"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"design"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"^design_..*$"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"paper"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"^paper_..*$"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Delete ROIs related to perforations</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">deletePerfROIs</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(deletePerfROIs): Function Entry"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"^.*_[0-9][0-9]_perfs"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"^.*_[0-9][0-9]_[0-9][0-9]_pHo$"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Delete ROIs related to grill points</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">deleteGrillRelatedROIs</span>() {
  deleteNamedROI(<span style="color: #fa8072;">"^pt_grill_..*$"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"psBB_grill"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"grill"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"^grill_..*$"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process clicks for the "PhilaJ Overlay Interaction Tool" macro</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">moveOverlayClicks</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(moveOverlayClicks): Function Entry"</span>);
  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    ovrSize = Overlay.size;
    <span style="color: #00ffff;">if</span> (ovrSize &gt; 0) {
      getCursorLoc(lastX, lastY, z, flags);
      <span style="color: #00ffff;">while</span> ((flags &amp; 16) &gt; 0) {
        getCursorLoc(curX, curY, z, flags);
        <span style="color: #00ffff;">for</span> (i=0; i&lt;ovrSize; i++) {
          Overlay.activateSelection(i);
          Overlay.getBounds(i, selectionX, selectionY, selectionW, selectionH);
          Overlay.moveSelection(i, selectionX + curX - lastX, selectionY + curY - lastY);
        }
        lastX = curX;
        lastY = curY;
        wait(20);
      }
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If preset is "", then dumps out list of lables.  Otherwise returns an array with gaps, diam, lab</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">perfPresetLookup</span>(<span style="color: #63b8ff;">preset</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(perfPresetLookup): Function Entry: "</span>, preset);

  names  = newArray(<span style="color: #fa8072;">"Kiusalas 95.0  8.29"</span>, <span style="color: #fa8072;">"Kiusalas 81.0  9.72"</span>, <span style="color: #fa8072;">"Kiusalas 80.0  9.84"</span>, <span style="color: #fa8072;">"Kiusalas 79.0  9.97"</span>, <span style="color: #fa8072;">"Kiusalas 75.0 10.50"</span>, <span style="color: #fa8072;">"Kiusalas 73.0 10.79"</span>, <span style="color: #fa8072;">"Kiusalas 72.5 10.86"</span>, <span style="color: #fa8072;">"Kiusalas 72.0 10.94"</span>, <span style="color: #fa8072;">"Kiusalas 70.0 11.25"</span>, <span style="color: #fa8072;">"Kiusalas 67.0 11.75"</span>, <span style="color: #fa8072;">"Kiusalas 66.0 11.93"</span>, <span style="color: #fa8072;">"Kiusalas 63.0 12.50"</span>, <span style="color: #fa8072;">"Kiusalas 51.0 15.44"</span>, <span style="color: #fa8072;">"Liberty Issues Small  9.84"</span>, <span style="color: #fa8072;">"Liberty Issues Large 10.50"</span>, <span style="color: #fa8072;">"Liberty Issues Large 10.94"</span>, <span style="color: #fa8072;">"Liberty Issues Large 11.25"</span>, <span style="color: #fa8072;">"Bari Wolf 10.86"</span>, <span style="color: #fa8072;">"Bari Wolf 10.88"</span>, <span style="color: #fa8072;">"Bari Wolf 11.00"</span>, <span style="color: #fa8072;">"Bari Wolf 11.43"</span>, <span style="color: #fa8072;">"Bari Wolf 11.45"</span>);
  labs   = newArray(         <span style="color: #fa8072;">"95.0  8.29"</span>,          <span style="color: #fa8072;">"81.0  9.72"</span>,          <span style="color: #fa8072;">"80.0  9.84"</span>,          <span style="color: #fa8072;">"79.0  9.97"</span>,          <span style="color: #fa8072;">"75.0 10.50"</span>,          <span style="color: #fa8072;">"73.0 10.79"</span>,          <span style="color: #fa8072;">"72.5 10.86"</span>,          <span style="color: #fa8072;">"72.0 10.94"</span>,          <span style="color: #fa8072;">"70.0 11.25"</span>,          <span style="color: #fa8072;">"67.0 11.75"</span>,          <span style="color: #fa8072;">"66.0 11.93"</span>,          <span style="color: #fa8072;">"63.0 12.50"</span>,          <span style="color: #fa8072;">"51.0 15.44"</span>,                   <span style="color: #fa8072;">"Sm  9.84"</span>,                   <span style="color: #fa8072;">"Lg 10.50"</span>,                   <span style="color: #fa8072;">"Lg 10.94"</span>,                   <span style="color: #fa8072;">"Lg 11.25"</span>,     <span style="color: #fa8072;">"BW Sm 10.86"</span>,     <span style="color: #fa8072;">"BW Md 10.88"</span>,     <span style="color: #fa8072;">"BW Lg 11.00"</span>,     <span style="color: #fa8072;">"BW Lg 11.43"</span>,     <span style="color: #fa8072;">"BW Lg 11.45"</span>);
  gaps   = newArray(          95.0*0.0254,           81.0*0.0254,           80.0*0.0254,           79.0*0.0254,           75.0*0.0254,           73.0*0.0254,           72.5*0.0254,           72.0*0.0254,           70.0*0.0254,           67.0*0.0254,           66.0*0.0254,           63.0*0.0254,           51.0*0.0254,                  80.0*0.0254,                  75.0*0.0254,                  72.0*0.0254,                  70.0*0.0254,          20/10.86,          20/10.88,          20/11.00,          20/11.43,          20/11.45);
  diam   = newArray(                1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 1.000,                 0.850,                 0.700,                        0.950,                        1.100,                        1.100,                        1.100,              0.93,              1.02,              1.06,              1.06,              1.06);

  <span style="color: #00ffff;">if</span> (preset == <span style="color: #fa8072;">""</span>) {
    <span style="color: #00ffff;">return</span> names;
  } <span style="color: #00ffff;">else</span> {
    presetIdx = indexOfInArray(names, preset);
    <span style="color: #00ffff;">return</span> newArray(diam[presetIdx], gaps[presetIdx], labs[presetIdx]);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process option requests from the "Dynamic Perforation Tool" macro</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">dynamicPerfOptions</span>(<span style="color: #63b8ff;">queryForPreset</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(dynamicPerfOptions): Function Entry"</span>);

  <span style="color: #00ffff;">if</span> (queryForPreset) {
    lables = perfPresetLookup(<span style="color: #fa8072;">""</span>);

    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Dynamic Perforation Tool Preset Options"</span>);
    Dialog.addChoice(<span style="color: #fa8072;">"Preset:"</span>, lables, lables[0]);
    Dialog.show();
    presetName = Dialog.getChoice();

    presetData = perfPresetLookup(presetName);

    gbl_dyn_dotSz = presetData[0];
    gbl_dyn_nuGap = presetData[1];
  }

  fontChoiceList = getFavFontList();
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Dynamic Perforation Tool Options"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,                                                                gbl_ALL_color1);
  Dialog.addNumber(<span style="color: #fa8072;">"Dot Count:"</span>,                                                                             gbl_dyn_numPerf, 0, 6, <span style="color: #fa8072;">""</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Dot Size:"</span>,                                                                              gbl_dyn_dotSz, 3, 6, <span style="color: #fa8072;">"mm"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Line Width:"</span>, gbl_OLT_lineWidth,                                                         gbl_ALL_lineWidth);
  Dialog.addChoice(<span style="color: #fa8072;">"Font:"</span>, fontChoiceList,                                                                  gbl_ALL_font);
  Dialog.addChoice(<span style="color: #fa8072;">"Font Size:"</span>, gbl_OLT_fontMag,                                                            gbl_ALL_fMag);
  Dialog.addChoice(<span style="color: #fa8072;">"ROI Manager Use"</span>, newArray(<span style="color: #fa8072;">"NONE"</span>, <span style="color: #fa8072;">"JUST LINE"</span>, <span style="color: #fa8072;">"LINE &amp; END PERFS"</span>, <span style="color: #fa8072;">"LINE &amp; ALL PERFS"</span>), gbl_dyn_roiMgrU);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Results in measure table"</span>,                                                             gbl_dyn_rimt);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Show Perf Readout HUD"</span>,                                                                gbl_dyn_HUDdo);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Always Show Perf Report"</span>,                                                              gbl_dyn_autoRep);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Fill Dots"</span>,                                                                            gbl_ALL_fillDots);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Reset Perf Readout HUD Location"</span>,                                                      <span style="color: #8470ff; font-weight: bold;">false</span>);
  Dialog.show();

  gbl_ALL_color1    = Dialog.getChoice();
  gbl_dyn_numPerf   = round(minOf(50, maxOf(2, Dialog.getNumber())));
  gbl_dyn_dotSz     = minOf(maxOf(Dialog.getNumber(), gbl_dyn_dotSzMn), gbl_dyn_dotSzMx);
  gbl_ALL_lineWidth = Dialog.getChoice();
  old_font          = gbl_ALL_font;
  gbl_ALL_font      = Dialog.getChoice();
  old_fMag          = gbl_ALL_fMag;
  gbl_ALL_fMag      = Dialog.getChoice();
  gbl_dyn_roiMgrU   = Dialog.getChoice();
  gbl_dyn_rimt      = Dialog.getCheckbox();
  old_HUDdo         = gbl_dyn_HUDdo;
  gbl_dyn_HUDdo     = Dialog.getCheckbox();
  gbl_dyn_autoRep   = Dialog.getCheckbox();
  gbl_ALL_fillDots  = Dialog.getCheckbox();
  resetHUDloc       = Dialog.getCheckbox();

  <span style="color: #00ffff;">if</span> (resetHUDloc || (old_font !=gbl_ALL_font) || (old_fMag != gbl_ALL_fMag) || (old_HUDdo != gbl_dyn_HUDdo)) {
    gbl_dyn_HUDpx = NaN;
    gbl_dyn_HUDpy = NaN;
  }

  <span style="color: #00ffff;">if</span>(nImages &gt; 0)
    <span style="color: #00ffff;">if</span> (queryForPreset)
      dynamicPerfDraw(0, 0,  -1,  0, 0, 0);
    <span style="color: #00ffff;">else</span>
      <span style="color: #00ffff;">if</span> (<span style="color: #fa8072;">"dynamicPerfDraw"</span> == getOverlayCapPointName())
        dynamicPerfClicks(<span style="color: #8470ff; font-weight: bold;">true</span>);
      <span style="color: #00ffff;">else</span>
        dynamicPerfDraw(0, 0,  -1,  0, 0, -1);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process clicks from the "Dynamic Perforation Tool" macro</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">dynamicPerfClicks</span>(<span style="color: #63b8ff;">justRedraw</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(dynamicPerfClicks): Function Entry: "</span>, justRedraw);

  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    <span style="color: #00ffff;">if</span> (<span style="color: #fa8072;">"dynamicPerfDraw"</span> == getOverlayCapPointName()) {

      <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Click that activated tool</span>
      <span style="color: #00ffff;">if</span> ( !(justRedraw))
        getCursorLoc(firstX, firstY, firstZ, firstFlags);

      checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

      <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get data from overlay...</span>
      ovrDat    = dynamicPerfOverlayInfo();
      dxF       = ovrDat[0];
      dyF       = ovrDat[1];
      dxO       = ovrDat[2];
      dyO       = ovrDat[3];
      Oidx      = gbl_dyn_numPerf - 1;         <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Set using gbl_dyn_numPerf &amp; not dynamicPerfOverlayInfo() so pick up the new value if it has changed</span>

      <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If justRedraw, then redraw and exit macro</span>
      <span style="color: #00ffff;">if</span> (justRedraw) {
        dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
        exit;
      }

      firstEventClickP = ((firstFlags &amp; 16) != 0);
      firstEventContrP = ((firstFlags &amp;  2) != 0);
      firstEventAltP   = ((firstFlags &amp;  8) != 0);
      firstEventShiftP = ((firstFlags &amp;  1) != 0);

      <span style="color: #00ffff;">if</span> (firstEventClickP) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Got a click, so we do something...</span>
        <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Where was that first click?</span>
        clickedROI = Overlay.indexAt(firstX, firstY);
        <span style="color: #00ffff;">if</span> ( (clickedROI == <span style="color: #fa8072;">""</span>) || (clickedROI &lt; 0) )
          clickedROI = -1;

        <span style="color: #00ffff;">if</span> (clickedROI &lt; gbl_dyn_numPerf)
          clickedDot = clickedROI;
        <span style="color: #00ffff;">else</span>
          clickedDot = -1;

        dotClickedP = (clickedDot &gt;= 0);
        hudClickedP = (clickedROI == gbl_dyn_numPerf);

        <span style="color: #00ffff;">if</span> (firstEventContrP) { <span style="color: #ffa500;">//</span><span style="color: #ff7f24;">-  With a control key -- report perfs</span>
          dynamicPerfMeasure();
          eatClicks();
        } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (firstEventAltP) { <span style="color: #ffa500;">//</span><span style="color: #ff7f24;">- alt key -&gt; delete or add dots</span>
          <span style="color: #00ffff;">if</span> (clickedDot &gt;= 0) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Got a click on a dot</span>
            <span style="color: #00ffff;">if</span> (clickedDot &lt; (gbl_dyn_numPerf-1-clickedDot)) {
              zapDir = -1;
              zapSpt = 0;
            } <span style="color: #00ffff;">else</span> {
              zapDir = 1;
              zapSpt = clickedDot+1;
            }
            <span style="color: #00ffff;">for</span>(i=clickedDot+zapDir; (i&gt;=0)&amp;&amp;(i&lt;gbl_dyn_numPerf); i=i+zapDir)
              Overlay.removeSelection(zapSpt);
            gbl_dyn_numPerf = Overlay.size-2;
          } <span style="color: #00ffff;">else</span> {
            gbl_dyn_numPerf++;
            tmp1 = hypot2(firstX, dxF, firstY, dyF);
            tmp2 = hypot2(firstX, dxO, firstY, dyO);
            <span style="color: #00ffff;">if</span> (tmp1 &lt; tmp2)
              dynamicPerfDraw(dxF, dyF, 1, dxO, dyO, Oidx+1);
            <span style="color: #00ffff;">else</span>
              dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
          }
          eatClicks();
        } <span style="color: #00ffff;">else</span> { <span style="color: #ffa500;">//</span><span style="color: #ff7f24;">- No modifier or shift -&gt; one of: move all dots, move hud, move dot, resize dots</span>
          lastX = firstX;
          lastY = firstY;
          <span style="color: #00ffff;">do</span> {
            getCursorLoc(x, y, z, flags);
            <span style="color: #00ffff;">if</span> ((flags &amp; 16) != 0) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Got another click</span>
              <span style="color: #00ffff;">if</span> (firstEventShiftP) {                                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">shift -&gt; resize dots</span>
                <span style="color: #00ffff;">if</span> ((lastX != x) || (lastY != y)) {
                  tmp2 = distPtLine(lastX, lastY, dxF, dyF, dxO, dyO);
                  tmp1 = distPtLine(    x,     y, dxF, dyF, dxO, dyO);
                  <span style="color: #00ffff;">if</span> (tmp1 &lt; tmp2)
                    gbl_dyn_dotSz = minOf(maxOf(gbl_dyn_dotSz - 0.01, gbl_dyn_dotSzMn), gbl_dyn_dotSzMx);
                  <span style="color: #00ffff;">else</span>
                    gbl_dyn_dotSz = minOf(maxOf(gbl_dyn_dotSz + 0.01, gbl_dyn_dotSzMn), gbl_dyn_dotSzMx);
                  dotSzX = gbl_dyn_dotSz;
                  dotSzY = gbl_dyn_dotSz;
                  toUnscaled(dotSzX, dotSzY);
                  dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
                }
              } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_dyn_HUDdo &amp;&amp; hudClickedP) {              <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Clicked on perf HUD -&gt; move hud</span>
                gbl_dyn_HUDpx += (x-lastX);
                gbl_dyn_HUDpy += (y-lastY);
                dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
              } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (dotClickedP) {                              <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Clicked on a dot -&gt; move dot</span>
                <span style="color: #00ffff;">if</span> (clickedDot &gt;= floor(gbl_dyn_numPerf / 2)) {
                  dxO = x;
                  dyO = y;
                  Oidx = clickedDot;
                  dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
                } <span style="color: #00ffff;">else</span> {
                  dxF = x;
                  dyF = y;
                  Fidx = clickedDot;
                  dynamicPerfDraw(dxF, dyF, Fidx, dxO, dyO, Oidx);
                }
              } <span style="color: #00ffff;">else</span> {                                              <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">No dot, hud, or shift -&gt; Translate ALL dots</span>
                dxF += (x - lastX);
                dyF += (y - lastY);
                dxO += (x - lastX);
                dyO += (y - lastY);
                dynamicPerfDraw(dxF, dyF, 0, dxO, dyO, Oidx);
              }
              lastX=x;
              lastY=y;
            }
            wait(20);
          } <span style="color: #00ffff;">while</span> ((flags &amp; 16) != 0);
        }
      }
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Produce a perfeation report for existing overlay -- assumes overlay is active so check that before calling this.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">dynamicPerfMeasure</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(dynamicPerfMeasure): Function Entry"</span>);

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get data from overlay...</span>
  ovrDat  = dynamicPerfOverlayInfo();
  dxF     = ovrDat[0];
  dyF     = ovrDat[1];
  dxO     = ovrDat[2];
  dyO     = ovrDat[3];
  szX     = ovrDat[4];
  szY     = ovrDat[5];
  numPerf = ovrDat[6];
  dotSize = (szX+szY)/2.0;

  roiPfx  = <span style="color: #fa8072;">"dynPf"</span>;

  <span style="color: #00ffff;">if</span> (gbl_dyn_roiMgrU != <span style="color: #fa8072;">"NONE"</span>) {
    <span style="color: #00ffff;">do</span> {
      needPfx = <span style="color: #8470ff; font-weight: bold;">false</span>;
      Dialog.create(<span style="color: #fa8072;">"PhilaJ: Dynamic Perforation Tool"</span>);
      Dialog.addString(<span style="color: #fa8072;">"ROI Name Prefix:"</span>, gbl_dyn_roiPfx, 5);
      Dialog.show();
      gbl_dyn_roiPfx = Dialog.getString();
      <span style="color: #00ffff;">if</span> (gbl_dyn_roiPfx == <span style="color: #fa8072;">""</span>) {
        showMessage(<span style="color: #fa8072;">"PhilaJ: dynamicPerfClicks"</span>, <span style="color: #fa8072;">"ERROR: The ROI prefix must be set!"</span>);
        needPfx = <span style="color: #8470ff; font-weight: bold;">true</span>;
      }
      <span style="color: #00ffff;">if</span> (indexOf(gbl_dyn_roiPfx, <span style="color: #fa8072;">"_"</span>) &gt;= 0) {
        showMessage(<span style="color: #fa8072;">"PhilaJ: dynamicPerfClicks"</span>, <span style="color: #fa8072;">"ERROR: The ROI prefix must not contain an underscore (_) character!"</span>);
        needPfx = <span style="color: #8470ff; font-weight: bold;">true</span>;
      }
    } <span style="color: #00ffff;">while</span> (needPfx);
    roiPfx = gbl_dyn_roiPfx;
    deleteNamedROI(roiPfx + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(numPerf, 2) + <span style="color: #fa8072;">"_perfs"</span>);
    deleteNamedROI(<span style="color: #fa8072;">"(^"</span> + roiPfx + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(numPerf, 2) + <span style="color: #fa8072;">"_[0-9][0-9]_pHo$)"</span>);
    <span style="color: #00ffff;">if</span> (gbl_dyn_roiMgrU != <span style="color: #fa8072;">"JUST LINE"</span>)
      <span style="color: #00ffff;">for</span>(i=0; i&lt;numPerf; i++)
        <span style="color: #00ffff;">if</span> ((gbl_dyn_roiMgrU == <span style="color: #fa8072;">"LINE &amp; ALL PERFS"</span>) || (i == 0) || (i == (numPerf-1))) {
          Overlay.activateSelection(i);
          Roi.setName(roiPfx + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(numPerf, 2) + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(i+1, 2) + <span style="color: #fa8072;">"_pHo"</span>);
          roiManager(<span style="color: #fa8072;">"add"</span>);
        }
  }

  <span style="color: #00ffff;">if</span> (gbl_dyn_rimt || (gbl_dyn_roiMgrU != <span style="color: #fa8072;">"NONE"</span>)) {
    makeLine(dxF, dyF, dxO, dyO, parseInt(gbl_ALL_lineWidth));
    Roi.setName(roiPfx + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(numPerf, 2) + <span style="color: #fa8072;">"_perfs"</span>);
    Roi.setStrokeColor(gbl_ALL_color1);
    <span style="color: #00ffff;">if</span> (gbl_dyn_roiMgrU != <span style="color: #fa8072;">"NONE"</span>)
      roiManager(<span style="color: #fa8072;">"add"</span>);

    <span style="color: #00ffff;">if</span> (gbl_dyn_rimt)
      run(<span style="color: #fa8072;">"Measure"</span>);
  }

  toScaled(dxF, dyF);
  toScaled(dxO, dyO);
  leng = hypot2(dxF, dxO, dyF, dyO);

  perfFromDistReport(leng, numPerf, dotSize, gbl_dyn_rimt);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get data from existing "Dynamic Perforation Tool" overlay</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">dynamicPerfOverlayInfo</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(dynamicPerfOverlayInfo): Function Entry"</span>);

  Overlay.activateSelection(0);
  lineWidth = Roi.getStrokeWidth;
  Roi.getBounds(dxF, dyF, szXF, szYF);
  szXF += lineWidth;
  szYF += lineWidth;
  dxF  += szXF / 2 - lineWidth / 2;
  dyF  += szYF / 2 - lineWidth / 2;
  run(<span style="color: #fa8072;">"Select None"</span>);
  Overlay.getBounds(Overlay.size-3, dxO, dyO, tmpXO, tmpYO);
  dxO  += szXF / 2 - lineWidth / 2;
  dyO  += szYF / 2 - lineWidth / 2;

  toScaled(szXF, szYF);

  <span style="color: #00ffff;">return</span> newArray(dxF, dyF, dxO, dyO, szXF, szYF, Overlay.size-2);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw Dynamic Perforation gauge utility.  If firstDotIndex or otherDotIndex is less than zero, then all arguments are ignored and approprate values</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">are 1) pulled from teh current ROI, or 2) are defaulted.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">dynamicPerfDraw</span>(<span style="color: #63b8ff;">firstDotX</span>, <span style="color: #63b8ff;">firstDotY</span>, <span style="color: #63b8ff;">firstDotIndex</span>, <span style="color: #63b8ff;">otherDotX</span>, <span style="color: #63b8ff;">otherDotY</span>, <span style="color: #63b8ff;">otherDotIndex</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(dynamicPerfDraw): Function Entry: "</span>, firstDotX, firstDotY, firstDotIndex, otherDotX, otherDotY, otherDotIndex);
  exitIfNoImages(<span style="color: #fa8072;">"dynamicPerfDrawOnLine"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  <span style="color: #00ffff;">if</span> (firstDotIndex &lt; 0) {
    numDots   = -1;
    dotSize   = -1;
    prefix    = <span style="color: #fa8072;">""</span>;
    colr      = <span style="color: #fa8072;">"none"</span>;
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If we have an active perf hole ROI, then find the line ROI</span>
    <span style="color: #00ffff;">if</span> (selectionType == 1)
      <span style="color: #00ffff;">if</span> (endsWith(Roi.getName, <span style="color: #fa8072;">"_pHo"</span>)) {
        roi_parts = split(Roi.getName, <span style="color: #fa8072;">"_"</span>);
        activateNamedROI(String.join(newArray(roi_parts[0], roi_parts[1], <span style="color: #fa8072;">"perfs"</span>), <span style="color: #fa8072;">"_"</span>));
      }
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Extract info from our line selection</span>
    <span style="color: #00ffff;">if</span> (selectionType == 5) {
      getLine(firstDotX, firstDotY, tmpSelEndX, tmpSelEndY, tmpSelWidth);
      lineROIname = Roi.getName;
      roi_parts = split(lineROIname, <span style="color: #fa8072;">"_"</span>);
      <span style="color: #00ffff;">if</span> (roi_parts.length == 3) {
        <span style="color: #00ffff;">if</span> (roi_parts[2] == <span style="color: #fa8072;">"perfs"</span>) {
          tmp = parseInt(roi_parts[1]);
          <span style="color: #00ffff;">if</span> ( !(isNaN(tmp)) &amp;&amp; (tmp&gt;0) ) {
            prefix = roi_parts[0];
            numDots = tmp;
            colr = Roi.getStrokeColor;
            dotROIname = replace(Roi.getName, <span style="color: #fa8072;">"_perfs"</span>, <span style="color: #fa8072;">"_01_pHo"</span>);
            <span style="color: #00ffff;">if</span> ((existsInROImanagerEqual(lineROIname) &gt;= 0) &amp;&amp; (existsInROImanagerEqual(dotROIname) &gt;= 0)) {
              tmpRC = activateNamedROI(dotROIname);
              <span style="color: #00ffff;">if</span> (tmpRC &gt;= 0) {
                Roi.getBounds(tmpX, tmpX, tmpW, tmpH);
                dotSize = maxOf(tmpW, tmpH);
                toScaled(dotSize);
                activateNamedROI(lineROIname);
              }
            }
          }
        }
      }
      <span style="color: #00ffff;">if</span> (indexOfInArray(gbl_OLT_colors, colr) &gt;= 0)
        gbl_ALL_color1 = colr;
      <span style="color: #00ffff;">if</span> (numDots &gt; 0)
        gbl_dyn_numPerf = numDots;
      <span style="color: #00ffff;">if</span> (dotSize &gt; 0)
        gbl_dyn_dotSz   = dotSize;
      <span style="color: #00ffff;">if</span> (prefix.length &gt; 0)
        gbl_dyn_roiPfx  = prefix;
      firstDotIndex = 0;

      <span style="color: #00ffff;">if</span> (otherDotIndex &lt; 0) {
        otherDotX = tmpSelEndX;
        otherDotY = tmpSelEndY;
        otherDotIndex = gbl_dyn_numPerf-1;
      } <span style="color: #00ffff;">else</span> {
        xDelta = tmpSelEndX - firstDotX;
        yDelta = tmpSelEndY - firstDotY;
        deltaL = hypot1(xDelta, yDelta);
        tmpX = gbl_dyn_nuGap;
        tmpY = gbl_dyn_nuGap;
        toUnscaled(tmpX, tmpY);
        otherDotX = firstDotX + tmpX * xDelta / deltaL;
        otherDotY = firstDotY + tmpY * yDelta / deltaL;
        otherDotIndex = 1;
      }
    } <span style="color: #00ffff;">else</span> {
      dotSzX = gbl_dyn_dotSz;
      dotSzY = gbl_dyn_dotSz;
      toUnscaled(dotSzX, dotSzY);
      firstDotX = minOf(dotSzX * 2, getWidth  / 4);
      firstDotY = minOf(dotSzY * 2, getHeight / 4);
      otherDotX = firstDotX + toUnscaledX(gbl_dyn_nuGap);
      otherDotY = firstDotY;
      firstDotIndex = 0;
      otherDotIndex = 1;
    }
  }

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Finally, it's time to draw something...</span>
  run(<span style="color: #fa8072;">"Select None"</span>);

  dotSzX = gbl_dyn_dotSz;
  dotSzY = gbl_dyn_dotSz;
  toUnscaled(dotSzX, dotSzY);

  setColor(gbl_ALL_color1);
  lineWidth = parseInt(gbl_ALL_lineWidth)-1; <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">We use -1 to get an even number because we divide it by two later and don't want rounding errors</span>
  setLineWidth(lineWidth);

  xDelta = otherDotX - firstDotX;
  yDelta = otherDotY - firstDotY;

  xDelta = xDelta / (gbl_dyn_numPerf - 1) * ((gbl_dyn_numPerf-1) / (otherDotIndex - firstDotIndex));
  yDelta = yDelta / (gbl_dyn_numPerf - 1) * ((gbl_dyn_numPerf-1) / (otherDotIndex - firstDotIndex));

  clearOverlay();

  <span style="color: #00ffff;">for</span>(n=0; n&lt;gbl_dyn_numPerf; n++) {
    xc = firstDotX + xDelta * (n - firstDotIndex) - dotSzX / 2;
    yc = firstDotY + yDelta * (n - firstDotIndex) - dotSzY / 2;
    <span style="color: #00ffff;">if</span> (gbl_ALL_fillDots) {
      makeOval(xc, yc, dotSzX, dotSzY);
      Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, gbl_ALL_color1);
    } <span style="color: #00ffff;">else</span> {
      makeOval(xc+lineWidth/2, yc+lineWidth/2, dotSzX-lineWidth, dotSzY-lineWidth);
      Overlay.addSelection(gbl_ALL_color1, lineWidth);
    }
  }

  <span style="color: #00ffff;">if</span> (gbl_dyn_HUDdo) {
    setFontHeight(maxOf(100, getHeight()/10), <span style="color: #8470ff; font-weight: bold;">true</span>);
    x1 = firstDotX;
    y1 = firstDotY;
    toScaled(x1, y1);
    x2 = otherDotX;
    y2 = otherDotY;
    toScaled(x2, y2);
    pfv = round(20000.0 * (otherDotIndex-firstDotIndex) / hypot2(x1, x2, y1, y2)) / 1000;
    msgS = <span style="color: #fa8072;">"Perfs: "</span> + d2s(pfv, 3);
    <span style="color: #00ffff;">if</span> (isNaN(gbl_dyn_HUDpy))
      gbl_dyn_HUDpy = getHeight() / 2;
    <span style="color: #00ffff;">if</span> (isNaN(gbl_dyn_HUDpx))
      gbl_dyn_HUDpx = (getWidth() - getStringWidth(<span style="color: #fa8072;">"Perfs: 0.00000"</span>)) / 2;
    makeText(msgS, gbl_dyn_HUDpx, gbl_dyn_HUDpy);
    Overlay.addSelection(gbl_ALL_color1);
  } <span style="color: #00ffff;">else</span> {
    makePoint(0, 0);
    Overlay.addSelection(gbl_ALL_color1);
  }

  <span style="color: #00ffff;">if</span> (gbl_dyn_autoRep) {
    x1 = firstDotX;
    y1 = firstDotY;
    toScaled(x1, y1);
    x2 = otherDotX;
    y2 = otherDotY;
    toScaled(x2, y2);
    perfFromDistReport(hypot2(x1, x2, y1, y2), otherDotIndex-firstDotIndex, gbl_dyn_dotSz, <span style="color: #8470ff; font-weight: bold;">false</span>);
  }

  addCapPointToOverlay(<span style="color: #fa8072;">"dynamicPerfDraw"</span>, 0, 0);
  Overlay.selectable(<span style="color: #8470ff; font-weight: bold;">false</span>);
  Overlay.show;

  run(<span style="color: #fa8072;">"Select None"</span>);
  setTool(16);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process clicks from the "Coordinate Tool" macro</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">coordToolClicks</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(coordToolClicks): Function Entry"</span>);

  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If the config was bad, then we get a good config now and exit for the next click.</span>
    <span style="color: #00ffff;">if</span> (coordToolOptions(<span style="color: #8470ff; font-weight: bold;">true</span>))
      exit;

    getCursorLoc(x, y, z, flags);
    <span style="color: #00ffff;">if</span> ((flags &amp; 16) &gt; 0) {
      run(<span style="color: #fa8072;">"Select None"</span>);
      gbl_cot_cordIdx++;
      makePoint(x, y);
      <span style="color: #00ffff;">if</span> (gbl_cot_ROItag == <span style="color: #fa8072;">""</span>)
        Roi.setName(<span style="color: #fa8072;">"pt_"</span>                        + intToZeroPadString(gbl_cot_cordIdx, 3));
      <span style="color: #00ffff;">else</span>
        Roi.setName(<span style="color: #fa8072;">"pt_"</span> + gbl_cot_ROItag + <span style="color: #fa8072;">"_"</span> + intToZeroPadString(gbl_cot_cordIdx, 3));
      <span style="color: #00ffff;">if</span> (gbl_cot_clickOvr)
        Overlay.addSelection(gbl_ALL_color1);
      <span style="color: #00ffff;">if</span> (gbl_cot_ROItag != <span style="color: #fa8072;">""</span>)
        roiManager(<span style="color: #fa8072;">"add"</span>);
      <span style="color: #00ffff;">if</span> (gbl_cot_clickMeas)
        run(<span style="color: #fa8072;">"Measure"</span>);
      eatClicks(); <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Consume clicks till the user takes the finger off the mouse button</span>
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process configuration requests for the "Coordinate Tool" macro</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Configure coordinate tool if justChecking is false.  Otherwise check config, and ask for data if the config is bad.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Returns true if we ask for data.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">coordToolOptions</span>(<span style="color: #63b8ff;">justChecking</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(coordToolOptions): Function Entry: "</span>, justChecking);
  didWeAsk = <span style="color: #8470ff; font-weight: bold;">false</span>;
  askForData = !(justChecking);
  needMoreData = <span style="color: #8470ff; font-weight: bold;">true</span>;
  <span style="color: #00ffff;">do</span> {
    needMoreData = <span style="color: #8470ff; font-weight: bold;">false</span>;
    <span style="color: #00ffff;">if</span> (askForData) {
      didWeAsk = <span style="color: #8470ff; font-weight: bold;">true</span>;
      Dialog.create(<span style="color: #fa8072;">"PhilaJ: Coordinate Tool Options"</span>);
      Dialog.addString(<span style="color: #fa8072;">"Name tag for ROI Manager"</span>,  gbl_cot_ROItag);
      Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,   gbl_ALL_color1);
      Dialog.addCheckbox(<span style="color: #fa8072;">"Add points to overlay"</span>,   gbl_cot_clickOvr);
      Dialog.addCheckbox(<span style="color: #fa8072;">"Measure points"</span>,          gbl_cot_clickMeas);
      Dialog.show();
      gbl_cot_ROItag    = Dialog.getString();
      gbl_ALL_color1    = Dialog.getChoice();
      gbl_cot_clickOvr  = Dialog.getCheckbox();
      gbl_cot_clickMeas = Dialog.getCheckbox();
    }
    <span style="color: #00ffff;">if</span> ( !(gbl_cot_clickOvr || gbl_cot_clickMeas || (gbl_cot_ROItag != <span style="color: #fa8072;">""</span>))) {
      showMessage(<span style="color: #fa8072;">"PhilaJ: coordToolOptions"</span>, <span style="color: #fa8072;">"ERROR: At least one coordinate action must be set!"</span>);
      needMoreData = <span style="color: #8470ff; font-weight: bold;">true</span>;
    }
    <span style="color: #00ffff;">if</span> (needMoreData)
      askForData = <span style="color: #8470ff; font-weight: bold;">true</span>;
  } <span style="color: #00ffff;">while</span> (needMoreData);
  <span style="color: #00ffff;">return</span> didWeAsk;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Display data table with Kiusalas conversion info</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">kiusalasTable</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(kiusalasTable): Function Entry"</span>);
  Kiusalas = newArray(  95.0,    81.0,    80.0,     79.0,     75.0,     73.0,     72.5,     72.0,     70.0,     67.0,     66.0,     63.0,    51.0);
  Scott    = newArray(     8,      10,      10,       10,     10.5,       11,       11,       11,       11,       12,       12,     12.5,      15);
  Standard = newArray(8.2884,  9.7210,  9.8425,   9.9671,  10.4987,  10.7863,  10.8607,  10.9361,  11.2486,  11.7523,  11.9303,  12.4984, 15.4392);
  Array.show(<span style="color: #fa8072;">"PhilaJ: KSP"</span>, Kiusalas, Scott, Standard);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillToUse == "KEEP", then use the previously selected grill.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillToUse == "ASK", then ask for a type via a dialog box</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Otherwise, use grillToUse as the grill letter.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philGrillOptions</span>(<span style="color: #63b8ff;">grillToUse</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philGrillOptions): Function Entry: "</span>, grillToUse);

  <span style="color: #00ffff;">if</span> (grillToUse == <span style="color: #fa8072;">"ASK"</span>) {
    grillLetters = grillDataLookup(<span style="color: #fa8072;">""</span>, <span style="color: #fa8072;">""</span>);
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Grill Type"</span>);
    Dialog.addChoice(<span style="color: #fa8072;">"Grill:"</span>, grillLetters, gbl_grl_type);
    Dialog.show();
    gbl_grl_type = Dialog.getChoice();
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (grillToUse != <span style="color: #fa8072;">"KEEP"</span>) {
    gbl_grl_type = grillToUse;
  }

  minH = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"minH"</span>);
  maxH = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"maxH"</span>);
  minV = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"minV"</span>);
  maxV = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"maxV"</span>);

  <span style="color: #00ffff;">if</span> (gbl_grl_ptype != gbl_grl_type) {
    gbl_grl_numH = maxH;
    gbl_grl_numV = maxV;
    gbl_grl_ptype = gbl_grl_type;
  }

  fontChoiceList = getFavFontList();
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: "</span> + gbl_grl_type + <span style="color: #fa8072;">" Grill"</span>);
  <span style="color: #00ffff;">if</span> ((maxH-minH)&gt;0)
    Dialog.addSlider(<span style="color: #fa8072;">"Points Horizontal:"</span>, minH, maxH, gbl_grl_numH);
  <span style="color: #00ffff;">if</span> ((maxV-minV)&gt;0)
    Dialog.addSlider(<span style="color: #fa8072;">"Points Vertical:"</span>, minV, maxV,   gbl_grl_numV);
  Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,          gbl_ALL_color1);
  Dialog.addChoice(<span style="color: #fa8072;">"color2:"</span>, gbl_OLT_colors,          gbl_ALL_color2);
  Dialog.addChoice(<span style="color: #fa8072;">"Line Width:"</span>, gbl_OLT_lineWidth,   gbl_ALL_lineWidth);
  Dialog.addChoice(<span style="color: #fa8072;">"Font:"</span>, fontChoiceList,            gbl_ALL_font);
  Dialog.addChoice(<span style="color: #fa8072;">"Font Size:"</span>, gbl_OLT_fontMag,      gbl_ALL_fMag);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Draw Point Boxes"</span>,               gbl_grl_doPbox);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Draw Point Crosses"</span>,             gbl_grl_doPcross);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Draw Point Ridges"</span>,              gbl_grl_doPridge);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Draw Point Box Boundary"</span>,        gbl_grl_doOut);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Draw Max Grill Box"</span>,             gbl_grl_doMGB);
  Dialog.show();

  <span style="color: #00ffff;">if</span> ((maxH-minH)&gt;0)
    gbl_grl_numH = Dialog.getNumber();
  <span style="color: #00ffff;">if</span> ((maxV-minV)&gt;0)
    gbl_grl_numV = Dialog.getNumber();
  gbl_ALL_color1    = Dialog.getChoice();
  gbl_ALL_color2    = Dialog.getChoice();
  gbl_ALL_lineWidth = Dialog.getChoice();
  gbl_ALL_font      = Dialog.getChoice();
  gbl_ALL_fMag      = Dialog.getChoice();
  gbl_grl_doPbox    = Dialog.getCheckbox();
  gbl_grl_doPcross  = Dialog.getCheckbox();
  gbl_grl_doPridge  = Dialog.getCheckbox();
  gbl_grl_doOut     = Dialog.getCheckbox();
  gbl_grl_doMGB     = Dialog.getCheckbox();

  <span style="color: #00ffff;">if</span> (nImages &gt; 0)
    philGrillAction();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw Grill Grid Action</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philGrillAction</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philGrillAction): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"philGrillAction"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  boxW   = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxW"</span>);
  boxH   = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxH"</span>);
  boxGx  = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxGx"</span>);
  boxGy  = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxGy"</span>);
  ridges = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"ridges"</span>);
  tMaxW  = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxMaxTotW"</span>);
  tMaxH  = grillDataLookup(gbl_grl_type, <span style="color: #fa8072;">"boxMaxTotH"</span>);

  activateOrCreateNamedROI(<span style="color: #fa8072;">"grill"</span>, <span style="color: #fa8072;">"Identify Grill Edges"</span>, <span style="color: #fa8072;">"Select the grill boundary"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
  Roi.getBounds(grillX, grillY, grillWidth, grillHeight);

  setFontHeight(5, <span style="color: #8470ff; font-weight: bold;">false</span>);
  fontHeight = getValue(<span style="color: #fa8072;">"font.height"</span>);
  setLineWidth(parseInt(gbl_ALL_lineWidth));

  toUnscaled(boxW, boxH);

  setColor(gbl_ALL_color1);
  clearOverlay();
  Overlay.drawString(gbl_grl_type, grillX-getStringWidth(gbl_grl_type)-boxW, grillY+fontHeight/2);

  setColor(gbl_ALL_color1);
  <span style="color: #00ffff;">if</span> (gbl_grl_doPbox || gbl_grl_doPridge || gbl_grl_doPcross) {
    <span style="color: #00ffff;">for</span>(xi=0; xi&lt;gbl_grl_numH; xi++) {
      <span style="color: #00ffff;">for</span>(yi=0; yi&lt;gbl_grl_numV; yi++) {
        pxUL = xi * boxGx;
        pyUL = yi * boxGy;
        toUnscaled(pxUL, pyUL);
        <span style="color: #00ffff;">if</span> (gbl_grl_doPridge)  {
          <span style="color: #00ffff;">if</span> (ridges == <span style="color: #fa8072;">"V"</span>) {
            Overlay.drawLine(grillX+pxUL+boxW/2,     grillY+pyUL+boxH/4, grillX+pxUL+boxW/2,   grillY+pyUL+3*boxH/4);
            Overlay.add;
          } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (ridges == <span style="color: #fa8072;">"N"</span>) {
            <span style="color: #00ffff;">if</span> ( !(gbl_grl_doPcross)) {
              Overlay.drawLine(grillX+pxUL+boxW/4,   grillY+pyUL+boxH/4, grillX+pxUL+3*boxW/4, grillY+pyUL+3*boxH/4);
              Overlay.add;
              Overlay.drawLine(grillX+pxUL+3*boxW/4, grillY+pyUL+boxH/4, grillX+pxUL+boxW/4,   grillY+pyUL+3*boxH/4);
              Overlay.add;
            }
          } <span style="color: #00ffff;">else</span> { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">"H"</span>
            Overlay.drawLine(grillX+pxUL+boxW/4,     grillY+pyUL+boxH/4, grillX+pxUL+3*boxW/4, grillY+pyUL+boxH/2);
            Overlay.add;
          }
        }
        <span style="color: #00ffff;">if</span> (gbl_grl_doPbox)
          Overlay.drawRect(grillX+pxUL,              grillY+pyUL,        boxW,                 boxH);
        <span style="color: #00ffff;">if</span> (gbl_grl_doPcross)  {
          Overlay.drawLine(grillX+pxUL,              grillY+pyUL,        grillX+pxUL+boxW,     grillY+pyUL+boxH);
          Overlay.add;
          Overlay.drawLine(grillX+pxUL+boxW,         grillY+pyUL,        grillX+pxUL,          grillY+pyUL+boxH);
          Overlay.add;
        }
      }
    }
  }

  <span style="color: #00ffff;">if</span> (gbl_grl_doOut) {
    pxUL = (gbl_grl_numH - 1) * boxGx;
    pyUL = (gbl_grl_numV - 1) * boxGy;
    toUnscaled(pxUL, pyUL);
    Overlay.drawRect(grillX,                         grillY,             pxUL+boxW,            pyUL+boxH);
  }

  <span style="color: #00ffff;">if</span> (gbl_grl_doMGB) {
    pxUL = tMaxW;
    pyUL = tMaxH;
    toUnscaled(pxUL, pyUL);
    setColor(gbl_ALL_color2);
    Overlay.drawRect(grillX,                         grillY,             pxUL+boxW,            pyUL+boxH);
  }

  addCapPointToOverlay(<span style="color: #fa8072;">"philGrillAction"</span>, 0, 0);
  Overlay.show;

  run(<span style="color: #fa8072;">"Select None"</span>);
  setTool(16);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Add one last point to the overlay so that when we move the overlay around that's what gets highlighted.  nameForROI must not be "ERROR"</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">addCapPointToOverlay</span>(<span style="color: #63b8ff;">nameForROI</span>, <span style="color: #63b8ff;">origX</span>, <span style="color: #63b8ff;">origY</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(addCapPointToOverlay): Function Entry: "</span>, nameForROI);
  <span style="color: #00ffff;">if</span> (lengthOf(nameForROI) &lt;= 0)
    exit(<span style="color: #fa8072;">"PROGRAM_ERROR(addCapPointToOverlay): Invalid nameForROI argument!"</span>);
  makePoint(origX, origY);
  Roi.setName(nameForROI);
  Overlay.addSelection(gbl_ALL_color1);
  gbl_ALL_lastPhOvr = nameForROI;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get overlay cap point name.  Returns "" if no cap ponit found.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getOverlayCapPointName</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getOverlayCapPointName): Function Entry"</span>);
  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">if (nImages &gt; 0)</span>
  <span style="color: #ffa500;">//   </span><span style="color: #ff7f24;">if (Overlay.size &gt; 1)</span>
  <span style="color: #ffa500;">//     </span><span style="color: #ff7f24;">return eval("js", "var overlay = Packages.ij.IJ.getImage().getOverlay(); overlay.get(overlay.size()-1).getName();");</span>
  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">return "";</span>

  ret = <span style="color: #fa8072;">""</span>;
  <span style="color: #00ffff;">if</span> (Overlay.size &gt; 1) {
    Overlay.activateSelection(Overlay.size-1);
    <span style="color: #00ffff;">if</span> (selectionType == 10)
      ret = Roi.getName;
  }
  run(<span style="color: #fa8072;">"Select None"</span>);
  <span style="color: #00ffff;">return</span> ret;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get overlay cap point coordinates as an array for the named ROI.  Returns (0, 0) if we don't find a cap point or if the ROI name is a mismatch.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getOverlayCapPointPos</span>(<span style="color: #63b8ff;">nameOfROI</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getOverlayCapPointPos): Function Entry"</span>);
  ret = newArray(0, 0);
  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    <span style="color: #00ffff;">if</span> (Overlay.size &gt; 1) {
      Overlay.activateSelection(Overlay.size-1);
      <span style="color: #00ffff;">if</span> (selectionType == 10) {
        <span style="color: #00ffff;">if</span> (Roi.getName == nameOfROI) {
          Roi.getBounds(x, y, width, height);
          ret[0] = x;
          ret[1] = y;
        }
      }
    }
  }
  run(<span style="color: #fa8072;">"Select None"</span>);
  <span style="color: #00ffff;">return</span> ret;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return various facts about grills.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">factType: minH maxH .............. Number of points horizontal</span>
<span style="color: #ffa500;">//           </span><span style="color: #ff7f24;">minV maxV .............. Number of points vertically</span>
<span style="color: #ffa500;">//           </span><span style="color: #ff7f24;">boxW boxH .............. Grill point box width/height</span>
<span style="color: #ffa500;">//           </span><span style="color: #ff7f24;">minGx boxGy ............ Grill point box gap</span>
<span style="color: #ffa500;">//           </span><span style="color: #ff7f24;">ridges ................. Direction of ridges</span>
<span style="color: #ffa500;">//           </span><span style="color: #ff7f24;">boxMaxTotW boxMaxTotH .. Total width/height of grill</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">grillType: "B", "C", "D", "E", "Z", "F", "G", "H", "I", "J"</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillType == "", then an array of all grill letters is returned.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillType == "ALL", then an array display windo is produced showing all grill data -- nothing is returned.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillType is a valid grill letter &amp; factType == "ALL", then an array with all daa for the grill is returned -- in the order in the factType list above.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If grillType or factType is invalid, then the function will exit</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">grillDataLookup</span>(<span style="color: #63b8ff;">grillType</span>, <span style="color: #63b8ff;">factType</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(grillDataLookup): Function Entry: "</span>, grillType, factType);

  grill_letter    = newArray(  <span style="color: #fa8072;">"B"</span>,   <span style="color: #fa8072;">"C"</span>,   <span style="color: #fa8072;">"D"</span>,   <span style="color: #fa8072;">"E"</span>,   <span style="color: #fa8072;">"Z"</span>,   <span style="color: #fa8072;">"F"</span>,   <span style="color: #fa8072;">"G"</span>,   <span style="color: #fa8072;">"H"</span>,   <span style="color: #fa8072;">"I"</span>,   <span style="color: #fa8072;">"J"</span>);
  min_horz_points = newArray(   22,    16,    15,    14,    13,    11,    12,    11,    10,     9);
  max_horz_points = newArray(   22,    17,    15,    14,    14,    12,    12,    13,    11,    10);
  min_vert_points = newArray(   18,    18,    17,    15,    17,    15,    11,    14,    10,    12);
  max_vert_points = newArray(   18,    21,    18,    17,    18,    17,    12,    16,    13,    12);
  boxW            = newArray(0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645);
  boxH            = newArray(0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645, 0.645);
  boxGx           = newArray(0.789, 0.789, 0.794, 0.789, 0.789, 0.785, 0.789, 0.789, 0.793, 0.800);
  boxGy           = newArray(0.792, 0.792, 0.792, 0.797, 0.792, 0.799, 0.798, 0.795, 0.795, 0.793);
  ridge_direction = newArray(  <span style="color: #fa8072;">"N"</span>,   <span style="color: #fa8072;">"N"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"H"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"V"</span>,   <span style="color: #fa8072;">"V"</span>);
  max_width       = newArray(   18,    13,    12,    11,    11,     9,   9.5,    10,   8.5,     7);
  max_height      = newArray(   15,    16,    14,    13,    14,    13,   9.5,    12,   10,    9.5);

  <span style="color: #00ffff;">if</span> (grillType == <span style="color: #fa8072;">""</span>) {
    <span style="color: #00ffff;">return</span> grill_letter;
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (grillType == <span style="color: #fa8072;">"ALL"</span>) {
    Array.show(<span style="color: #fa8072;">"PhilaJ: Grill Data"</span>, grill_letter, min_horz_points, max_horz_points, min_vert_points, max_vert_points, ridge_direction, max_width, max_height);
  } <span style="color: #00ffff;">else</span> {
    datIdx = indexOfInArray(grill_letter, grillType);
    <span style="color: #00ffff;">if</span> (datIdx &lt; 0) {
      exit(<span style="color: #fa8072;">"ERROR(grillDataLookup): Unknown grillType: "</span> + grillType);
    } <span style="color: #00ffff;">else</span> {
      <span style="color: #00ffff;">if</span>      (factType == <span style="color: #fa8072;">"ALL"</span>)
        <span style="color: #00ffff;">return</span> newArray(min_horz_points[datIdx], max_horz_points[datIdx],
                        min_vert_points[datIdx], max_vert_points[datIdx],
                        boxW[datIdx], boxH[datIdx],
                        boxGx[datIdx], boxGy[datIdx],
                        ridge_direction[datIdx],
                        max_width[datIdx], max_height[datIdx]);
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"minH"</span>)
        <span style="color: #00ffff;">return</span> min_horz_points[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"maxH"</span>)
        <span style="color: #00ffff;">return</span> max_horz_points[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"minV"</span>)
        <span style="color: #00ffff;">return</span> min_vert_points[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"maxV"</span>)
        <span style="color: #00ffff;">return</span> max_vert_points[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxW"</span>)
        <span style="color: #00ffff;">return</span> boxW[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxH"</span>)
        <span style="color: #00ffff;">return</span> boxH[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxGx"</span>)
        <span style="color: #00ffff;">return</span> boxGx[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxGy"</span>)
        <span style="color: #00ffff;">return</span> boxGy[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"ridges"</span>)
        <span style="color: #00ffff;">return</span> ridge_direction[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxMaxTotW"</span>)
        <span style="color: #00ffff;">return</span> max_width[datIdx];
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (factType == <span style="color: #fa8072;">"boxMaxTotH"</span>)
        <span style="color: #00ffff;">return</span> max_height[datIdx];
      <span style="color: #00ffff;">else</span>
        exit(<span style="color: #fa8072;">"ERROR(grillDataLookup): Unknown factType: "</span> + factType);
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Perforation report</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">perfFromDistReport</span>(<span style="color: #63b8ff;">dist</span>, <span style="color: #63b8ff;">holes</span>, <span style="color: #63b8ff;">holeSz</span>, <span style="color: #63b8ff;">putInResults</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(perfFromDistReport): Function Entry: "</span>, dist, holes, holeSz, putInResults);
  perf20 = 20.0 * (holes - 1.0) / dist;
  perfk  = 100000.0 / (127.0 * perf20);
  <span style="color: #00ffff;">if</span> (putInResults &amp;&amp; (nResults&gt;0)) {
    close(<span style="color: #fa8072;">"PhilaJ: Perforation Report"</span>);  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Just in case it's open, close it if we put results in the results window</span>
    setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>PHoles<span style="color: #ffc0cb; font-weight: bold;">'</span>,     nResults-1, holes);
    <span style="color: #00ffff;">if</span> (holeSz &gt; 0)
      setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>PHolesSz<span style="color: #ffc0cb; font-weight: bold;">'</span>, nResults-1, holeSz);
    setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>Perf20<span style="color: #ffc0cb; font-weight: bold;">'</span>,     nResults-1, perf20);
    setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>PerfK<span style="color: #ffc0cb; font-weight: bold;">'</span>,      nResults-1, perfk);
    updateResults();
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> (holeSz &gt; 0) {
      Quantity = newArray(    <span style="color: #fa8072;">"Distance"</span>,         <span style="color: #fa8072;">"Holes"</span>,   <span style="color: #fa8072;">"Hole Sz"</span>,      <span style="color: #fa8072;">"Hole Sz"</span>,    <span style="color: #fa8072;">"Perfs"</span>, <span style="color: #fa8072;">"Kiusalas"</span>);
      Value    = newArray(          dist,           holes,      holeSz,  holeSz/0.0254,     perf20,      perfk);
      Unit     = newArray(          <span style="color: #fa8072;">"mm"</span>,             <span style="color: #fa8072;">"#"</span>,        <span style="color: #fa8072;">"mm"</span>,          <span style="color: #fa8072;">"mil"</span>, <span style="color: #fa8072;">"perf/2cm"</span>,      <span style="color: #fa8072;">"mil"</span>);
    } <span style="color: #00ffff;">else</span> {
      Quantity = newArray(    <span style="color: #fa8072;">"Distance"</span>,         <span style="color: #fa8072;">"Holes"</span>,      <span style="color: #fa8072;">"Perfs"</span>, <span style="color: #fa8072;">"Kiusalas"</span>);
      Value    = newArray(          dist,           holes,       perf20,      perfk);
      Unit     = newArray(          <span style="color: #fa8072;">"mm"</span>,             <span style="color: #fa8072;">"#"</span>,   <span style="color: #fa8072;">"perf/2cm"</span>,      <span style="color: #fa8072;">"mil"</span>);
    }
    Array.show(<span style="color: #fa8072;">"PhilaJ: Perforation Report"</span>, Quantity, Value, Unit);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure design size</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">measureDesign</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(measureDesign): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"measureDesign"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  activateOrCreateNamedROI(<span style="color: #fa8072;">"design"</span>, <span style="color: #fa8072;">"Identify Design Edges"</span>, <span style="color: #fa8072;">"Select the design edges"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"paperBB"</span>);
  run(<span style="color: #fa8072;">"To Bounding Box"</span>);
  Roi.setName(<span style="color: #fa8072;">"designBB"</span>);
  roiManager(<span style="color: #fa8072;">"add"</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure paper size</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">measurePaper</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(measurePaper): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"measurePaper"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  activateOrCreateNamedROI(<span style="color: #fa8072;">"paper"</span>, <span style="color: #fa8072;">"Identify Paper Edges"</span>, <span style="color: #fa8072;">"Select the paper boundary"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"paperBB"</span>);
  run(<span style="color: #fa8072;">"To Bounding Box"</span>);
  Roi.setName(<span style="color: #fa8072;">"paperBB"</span>);
  roiManager(<span style="color: #fa8072;">"add"</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get the image scale units.  actionIfNotMM: "ERROR"      -- exit the macro</span>
<span style="color: #ffa500;">//                                            </span><span style="color: #ff7f24;">"WARN"       -- print a warning message</span>
<span style="color: #ffa500;">//                                            </span><span style="color: #ff7f24;">"NONE"       -- do nothing</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getImageScaleUnits</span>(<span style="color: #63b8ff;">actionIfNotMM</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getImageScaleUnits): Function Entry: "</span>, actionIfNotMM);
  exitIfNoImages(<span style="color: #fa8072;">"getImageScaleUnits"</span>);
  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);
  <span style="color: #00ffff;">if</span> (pixelLengthUnit == <span style="color: #fa8072;">""</span>)
    pixelLengthUnit = <span style="color: #fa8072;">"UNKNOWN"</span>;
  <span style="color: #00ffff;">if</span> (pixelLengthUnit != <span style="color: #fa8072;">"mm"</span>)
    <span style="color: #00ffff;">if</span> (actionIfNotMM == <span style="color: #fa8072;">"WARN"</span>)
      showMessage(<span style="color: #fa8072;">"PhilaJ: getImageScaleUnits"</span>, <span style="color: #fa8072;">"WARNING: Image scale is not set to millimeters."</span>);
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (actionIfNotMM == <span style="color: #fa8072;">"WARN"</span>)
      exit(<span style="color: #fa8072;">"ERROR(getImageScaleUnits): Image scale is not set to millimeters!"</span>);
  <span style="color: #00ffff;">return</span> pixelLengthUnit;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Check if image has scale.  If not, try to set it or query if RPI iamge.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">checkImageScalePhil</span>(<span style="color: #63b8ff;">showScaleSetWarning</span>, <span style="color: #63b8ff;">showScaleSetFailWarning</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(checkImageScalePhil): Function Entry: "</span>, showScaleSetWarning, showScaleSetFailWarning);
  exitIfNoImages(<span style="color: #fa8072;">"checkImageScalePhil"</span>);

  <span style="color: #00ffff;">if</span> (convertImageScaleUnits(showScaleSetWarning, <span style="color: #8470ff; font-weight: bold;">false</span>) == 0) {                  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Try to convert existing scale to mm</span>
    <span style="color: #00ffff;">if</span> ( !(setScaleFromFileName(showScaleSetWarning, <span style="color: #8470ff; font-weight: bold;">false</span>))) {                   <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Try to set via DPI in filename</span>
      <span style="color: #00ffff;">if</span> ( !(setScaleFromROI(showScaleSetWarning, <span style="color: #8470ff; font-weight: bold;">false</span>))) {                      <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Try to set via ROI</span>
        <span style="color: #00ffff;">if</span> (matches(getInfo(<span style="color: #fa8072;">"image.directory"</span>), <span style="color: #fa8072;">".*Pictures.pi-cam.*$"</span>)) {        <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If it's in the micrograph directory, then try that</span>
          setScaleForMicrograph(<span style="color: #8470ff; font-weight: bold;">false</span>);
        }
      }
    }
  }
  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);
  <span style="color: #00ffff;">if</span> (showScaleSetFailWarning &amp;&amp; (pixelLengthUnit != <span style="color: #fa8072;">"mm"</span>))
    exit(<span style="color: #fa8072;">"ERROR(checkImageScalePhil): Image scale units must be millimeters (mm)"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure margins and compute centering stats</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">centeringReport</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(centeringReport): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"centeringReport"</span>);

  plu = getImageScaleUnits(<span style="color: #fa8072;">"WARN"</span>);

  activateOrCreateNamedROI(<span style="color: #fa8072;">"paper"</span>, <span style="color: #fa8072;">"Identify Paper Edges"</span>, <span style="color: #fa8072;">"Select the paper boundary"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  paperROI = Roi.getName;

  designMultiName = <span style="color: #fa8072;">""</span>;
  <span style="color: #00ffff;">if</span> (startsWith(paperROI, <span style="color: #fa8072;">"paper_"</span>)) {
    designMultiName = <span style="color: #fa8072;">"design_"</span> + substring(paperROI, indexOf(paperROI, <span style="color: #fa8072;">"_"</span>) + 1);
    <span style="color: #00ffff;">if</span> (existsInROImanagerEqual(designMultiName) &lt; 0)
      exit(<span style="color: #fa8072;">"ERROR(centeringReport): No "</span> + designMultiName + <span style="color: #fa8072;">" ROI exists to pair with paper ROI ("</span> + paperROI + <span style="color: #fa8072;">")!"</span>);
  }

  Roi.getBounds(paperX, paperY, paperWidth, paperHeight);
  run(<span style="color: #fa8072;">"Measure"</span>);

  <span style="color: #00ffff;">if</span> (designMultiName != <span style="color: #fa8072;">""</span>)
    activateNamedROI(designMultiName);
  <span style="color: #00ffff;">else</span>
    activateOrCreateNamedROI(<span style="color: #fa8072;">"design"</span>, <span style="color: #fa8072;">"Identify Design Edges"</span>, <span style="color: #fa8072;">"Select the design edges"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  designROI = Roi.getName;

  Roi.getBounds(designX, designY, designWidth, designHeight);
  run(<span style="color: #fa8072;">"Measure"</span>);

  designX2 = designX + designWidth;
  designY2 = designY + designHeight;
  paperX2  = paperX  + paperWidth;
  paperY2  = paperY  + paperHeight;

  paperX_mm       = paperX;
  paperY_mm       = paperY;
  paperWidth_mm   = paperWidth;
  paperHeight_mm  = paperHeight;
  designX_mm      = designX;
  designY_mm      = designY;
  designWidth_mm  = designWidth;
  designHeight_mm = designHeight;

  toScaled(paperX_mm, paperY_mm);
  toScaled(paperWidth_mm, paperHeight_mm);
  toScaled(designX_mm, designY_mm);
  toScaled(designWidth_mm, designHeight_mm);

  areaPaper  = paperWidth_mm  * paperHeight_mm;
  areaDesign = designWidth_mm * designHeight_mm;

  marginL = designX_mm-paperX_mm;
  marginT = designY_mm-paperY_mm;
  marginR = (paperWidth_mm  + paperX_mm) - (designWidth_mm  + designX_mm);
  marginB = (paperHeight_mm + paperY_mm) - (designHeight_mm + designY_mm);

  marginMax = maxOf(maxOf(marginT,  marginB), maxOf(marginL,  marginR));
  marginMin = minOf(minOf(marginT,  marginB), minOf(marginL,  marginR));

  marginRatioL = 100.0 * marginL / marginMax;
  marginRatioT = 100.0 * marginT / marginMax;
  marginRatioR = 100.0 * marginR / marginMax;
  marginRatioB = 100.0 * marginB / marginMax;

  areaLR = (marginL + marginR) * paperHeight_mm;
  areaTB = (marginT + marginB) * paperWidth_mm;

  balLR  = 100.0 * minOf(marginL, marginR)  / maxOf(marginL, marginR);
  balTB  = 100.0 * minOf(marginT,  marginB) / maxOf(marginT,  marginB);
  sumLR  = marginL + marginR;
  sumTB  = marginT  + marginB;
  sumAll = marginL + marginR + marginT  + marginB;
  balHV  = 100.0 * minOf(sumLR,  sumTB) / maxOf(sumLR,  sumTB);
  balALL = 100.0 * marginMin / marginMax;

  avgLR  = sumLR / 2.0;
  avgTB  = sumTB / 2.0;
  avgAll = sumAll / 4.0;

  areaRatioDesign = 100.0 * areaDesign / areaPaper;
  areaRatioTB     = 100.0 * areaTB     / areaPaper;
  areaRatioLR     = 100.0 * areaLR     / areaPaper;

  labMarginMin = <span style="color: #fa8072;">'L'</span>;
  <span style="color: #00ffff;">if</span> (marginT &lt;= marginMin)
    labMarginMin = <span style="color: #fa8072;">'T'</span>;
  <span style="color: #00ffff;">if</span> (marginR &lt;= marginMin)
    labMarginMin = <span style="color: #fa8072;">'R'</span>;
  <span style="color: #00ffff;">if</span> (marginB &lt;= marginMin)
    labMarginMin = <span style="color: #fa8072;">'B'</span>;

  labMarginMax = <span style="color: #fa8072;">'L'</span>;
  <span style="color: #00ffff;">if</span> (marginT &gt;= marginMax)
    labMarginMax = <span style="color: #fa8072;">'T'</span>;
  <span style="color: #00ffff;">if</span> (marginR &gt;= marginMax)
    labMarginMax = <span style="color: #fa8072;">'R'</span>;
  <span style="color: #00ffff;">if</span> (marginB &gt;= marginMax)
    labMarginMax = <span style="color: #fa8072;">'B'</span>;

  balLabALL = <span style="color: #fa8072;">"Balance: Max vs Min ("</span> + labMarginMax + <span style="color: #fa8072;">"&gt;"</span> + labMarginMin + <span style="color: #fa8072;">")"</span>;

  balLabLR = <span style="color: #fa8072;">"Balance: Left vs Right (L&gt;R)"</span>;
  <span style="color: #00ffff;">if</span> (marginL &lt; marginR)
    balLabLR = <span style="color: #fa8072;">"Balance: Left vs Right (R&gt;L)"</span>;
  balLabTB = <span style="color: #fa8072;">"Balance: Top vs Bottom (T&gt;B)"</span>;
  <span style="color: #00ffff;">if</span> (marginT &lt; marginB)
    balLabTB = <span style="color: #fa8072;">"Balance: Top vs Bottom (B&gt;T)"</span>;
  balLabHV = <span style="color: #fa8072;">"Balance: Vert vs Horiz (H&gt;V)"</span>;
  <span style="color: #00ffff;">if</span> (sumTB &lt; sumLR)
    balLabHV = <span style="color: #fa8072;">"Balance: Vert vs Horiz (V&gt;H)"</span>;

  deleteNamedROI(<span style="color: #fa8072;">"paperBB"</span>);
  makeRectangle(paperX,   paperY, paperWidth, paperHeight);
  Roi.setName(<span style="color: #fa8072;">"paperBB"</span>);
  roiManager(<span style="color: #fa8072;">"add"</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);

  deleteNamedROI(<span style="color: #fa8072;">"designBB"</span>);
  makeRectangle(designX,   designY, designWidth, designHeight);
  Roi.setName(<span style="color: #fa8072;">"designBB"</span>);
  roiManager(<span style="color: #fa8072;">"add"</span>);
  run(<span style="color: #fa8072;">"Measure"</span>);

  run(<span style="color: #fa8072;">"Select None"</span>);
  clearOverlay();

  deleteNamedROI(<span style="color: #fa8072;">"marginT"</span>);
  <span style="color: #00ffff;">if</span> (marginT &gt; 0) {
    makeRectangle(paperX,   paperY, paperWidth,    designY - paperY);
    Roi.setName(<span style="color: #fa8072;">"marginT"</span>);
    roiManager(<span style="color: #fa8072;">"add"</span>);
    run(<span style="color: #fa8072;">"Measure"</span>);
    Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, <span style="color: #fa8072;">"yellow"</span>);
  }

  deleteNamedROI(<span style="color: #fa8072;">"marginB"</span>);
  <span style="color: #00ffff;">if</span> (marginB &gt; 0) {
    makeRectangle(paperX,   designY2, paperWidth, paperY2 - designY2);
    Roi.setName(<span style="color: #fa8072;">"marginB"</span>);
    roiManager(<span style="color: #fa8072;">"add"</span>);
    run(<span style="color: #fa8072;">"Measure"</span>);
    Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, <span style="color: #fa8072;">"yellow"</span>);
  }

  deleteNamedROI(<span style="color: #fa8072;">"marginL"</span>);
  <span style="color: #00ffff;">if</span> (marginL &gt; 0) {
    makeRectangle(paperX,   paperY, designX-paperX,   paperHeight);
    Roi.setName(<span style="color: #fa8072;">"marginL"</span>);
    roiManager(<span style="color: #fa8072;">"add"</span>);
    run(<span style="color: #fa8072;">"Measure"</span>);
    Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, <span style="color: #fa8072;">"yellow"</span>);
  }

  deleteNamedROI(<span style="color: #fa8072;">"marginR"</span>);
  <span style="color: #00ffff;">if</span> (marginR &gt; 0) {
    makeRectangle(designX2, paperY, paperX2-designX2, paperHeight);
    Roi.setName(<span style="color: #fa8072;">"marginR"</span>);
    roiManager(<span style="color: #fa8072;">"add"</span>);
    run(<span style="color: #fa8072;">"Measure"</span>);
    Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, <span style="color: #fa8072;">"yellow"</span>);
  }

  activateNamedROI(paperROI);
  Overlay.addSelection(<span style="color: #fa8072;">"blue"</span>);

  activateNamedROI(designROI);
  Overlay.addSelection(<span style="color: #fa8072;">"blue"</span>);

  Overlay.show;
  run(<span style="color: #fa8072;">"Select None"</span>);

  Quantity = newArray(balLabLR, balLabTB, balLabHV,   balLabALL, <span style="color: #fa8072;">"Margin: Left"</span>, <span style="color: #fa8072;">"Margin: Right"</span>, <span style="color: #fa8072;">"Margin: Top"</span>, <span style="color: #fa8072;">"Margin: Bottom"</span>, <span style="color: #fa8072;">"Margin Ratio: Left"</span>, <span style="color: #fa8072;">"Margin Ratio: Right"</span>, <span style="color: #fa8072;">"Margin Ratio: Top"</span>, <span style="color: #fa8072;">"Margin Ratio: Bottom"</span>, <span style="color: #fa8072;">"Average Vert (L&amp;R)"</span>, <span style="color: #fa8072;">"Average Horiz (T&amp;B)"</span>, <span style="color: #fa8072;">"Average Margin"</span>, <span style="color: #fa8072;">"Margin Area Ratio: Vert (L&amp;R)"</span>, <span style="color: #fa8072;">"Margin Area Ratio: Horiz (T&amp;B)"</span>, <span style="color: #fa8072;">"Area Ratio: Design Box"</span>, <span style="color: #fa8072;">"Area Design Box"</span>, <span style="color: #fa8072;">"Area Paper Box"</span>, <span style="color: #fa8072;">"Area Horiz (T&amp;B) Margins"</span>, <span style="color: #fa8072;">"Area Vert (L&amp;R) Margins"</span>);
  Value    = newArray(   balLR,    balTB,    balHV,      balALL,        marginL,         marginR,       marginT,          marginB,         marginRatioL,          marginRatioR,        marginRatioT,           marginRatioB,                avgLR,                 avgTB,           avgAll,                     areaRatioLR,                      areaRatioTB,          areaRatioDesign,        areaDesign,        areaPaper,                     areaTB,                    areaLR);
  Unit     = newArray(     <span style="color: #fa8072;">"%"</span>,      <span style="color: #fa8072;">"%"</span>,      <span style="color: #fa8072;">"%"</span>,         <span style="color: #fa8072;">"%"</span>,            plu,             plu,           plu,              plu,                  <span style="color: #fa8072;">"%"</span>,                   <span style="color: #fa8072;">"%"</span>,                 <span style="color: #fa8072;">"%"</span>,                    <span style="color: #fa8072;">"%"</span>,                  plu,                   plu,              plu,                             <span style="color: #fa8072;">"%"</span>,                              <span style="color: #fa8072;">"%"</span>,                      <span style="color: #fa8072;">"%"</span>,          plu+<span style="color: #fa8072;">"^2"</span>,         plu+<span style="color: #fa8072;">"^2"</span>,                   plu+<span style="color: #fa8072;">"^2"</span>,                  plu+<span style="color: #fa8072;">"^2"</span>);
  Array.show(<span style="color: #fa8072;">"PhilaJ: Centering Report"</span>, Quantity, Value, Unit);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw a traditional (holes/2cm) perf gauge on the overlay.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">instaPerfGaugeOptions</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(instaPerfGaugeOptions): Function Entry"</span>);

  fontChoiceList = getFavFontList();
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Perforation Meter"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Min:"</span>,                           gbl_nst_pMin, 0, 4, <span style="color: #fa8072;">"perfs/2cm"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Max:"</span>,                           gbl_nst_pMax, 0, 4, <span style="color: #fa8072;">"perfs/2cm"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Minor Div:"</span>, gbl_OLT_p2mdiv,     gbl_nst_mdiv);
  Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,        gbl_ALL_color1);
  Dialog.addChoice(<span style="color: #fa8072;">"color2:"</span>, gbl_OLT_colors,        gbl_ALL_color2);
  Dialog.addChoice(<span style="color: #fa8072;">"Perfs:"</span>, gbl_OLT_numPerf,        gbl_ALL_numPerf);
  Dialog.addChoice(<span style="color: #fa8072;">"Line Width:"</span>, gbl_OLT_lineWidth, gbl_ALL_lineWidth);
  Dialog.addChoice(<span style="color: #fa8072;">"Font:"</span>, fontChoiceList,          gbl_ALL_font);
  Dialog.addChoice(<span style="color: #fa8072;">"Font Size:"</span>, gbl_OLT_fontMag,    gbl_ALL_fMag);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Force Minor Div"</span>,              gbl_nst_mFrc);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Reverse Order"</span>,                gbl_ALL_perfOrder);
  Dialog.show();

  gbl_nst_pMin      = Math.floor(Dialog.getNumber());
  gbl_nst_pMax      = Math.ceil(Dialog.getNumber());
  gbl_nst_mdiv      = Dialog.getChoice();
  gbl_ALL_color1    = Dialog.getChoice();
  gbl_ALL_color2    = Dialog.getChoice();
  gbl_ALL_numPerf   = parseInt(Dialog.getChoice());
  gbl_ALL_lineWidth = Dialog.getChoice();
  gbl_ALL_font      = Dialog.getChoice();
  gbl_ALL_fMag      = Dialog.getChoice();
  gbl_nst_mFrc      = Dialog.getCheckbox();
  gbl_ALL_perfOrder = Dialog.getCheckbox();

  <span style="color: #00ffff;">if</span>(nImages &gt; 0)
    instaPerfGaugeAction();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Unscale a length parallel to x axis -- a y coordinate</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">toUnscaledY</span>(<span style="color: #63b8ff;">y</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(toUnscaledY): Function Entry: "</span>, y);
  tmpX = y;
  tmpY = y;
  toUnscaled(tmpX, tmpY);
  <span style="color: #00ffff;">return</span> tmpY;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Unscale a length parallel to y axis -- a x coordinate</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">toUnscaledX</span>(<span style="color: #63b8ff;">x</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(toUnscaledX): Function Entry: "</span>, x);
  tmpX = x;
  tmpY = x;
  toUnscaled(tmpX, tmpY);
  <span style="color: #00ffff;">return</span> tmpX;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale a length parallel to x axis -- a y coordinate</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">toScaledY</span>(<span style="color: #63b8ff;">y</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(toScaledY): Function Entry: "</span>, y);
  tmpX = y;
  tmpY = y;
  toScaled(tmpX, tmpY);
  <span style="color: #00ffff;">return</span> tmpY;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Scale a length parallel to y axis -- a x coordinate</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">toScaledX</span>(<span style="color: #63b8ff;">x</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(toScaledX): Function Entry: "</span>, x);
  tmpX = x;
  tmpY = x;
  toScaled(tmpX, tmpY);
  <span style="color: #00ffff;">return</span> tmpX;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Helper function to compute y coordinate for Insta perf gauge</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">instaPerfGaugeYcompute</span>(<span style="color: #63b8ff;">gaugeLLy</span>, <span style="color: #63b8ff;">gaugeULy</span>, <span style="color: #63b8ff;">n</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(instaPerfGaugeYcompute): Function Entry: "</span>, gaugeLLy, gaugeULy, n);
  <span style="color: #00ffff;">if</span> (gbl_ALL_perfOrder)
    y = (gaugeLLy-gaugeULy)*(1.0/n - 1.0/gbl_nst_pMax)/(1.0/gbl_nst_pMin-1.0/gbl_nst_pMax) + gaugeULy;
  <span style="color: #00ffff;">else</span>
    y = (gaugeULy-gaugeLLy)*(1.0/n - 1.0/gbl_nst_pMax)/(1.0/gbl_nst_pMin-1.0/gbl_nst_pMax) + gaugeLLy;
  <span style="color: #00ffff;">return</span> toUnscaledY(y);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw a traditional (holes/2cm) perf gauge on the overlay Action.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">instaPerfGaugeAction</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(instaPerfGaugeAction): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"instaPerfGaugeAction"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  <span style="color: #00ffff;">if</span> (gbl_nst_pMin &gt;= gbl_nst_pMax)
    exit(<span style="color: #fa8072;">"ERROR(instaPerfGaugeAction): Minimum must be strictly less than maximum!"</span>);

  maxy = getHeight();
  maxx = getWidth();

  minorDiv = parseFloat(gbl_nst_mdiv);

  nPfLines = parseInt(gbl_ALL_numPerf);

  lineWidth = parseInt(gbl_ALL_lineWidth);

  gaugeULyi = maxy / 10;
  gaugeULy  = toScaledY(gaugeULyi);
  gaugeLLyi = maxy - maxy / 10;
  gaugeLLy  = toScaledY(gaugeLLyi);

  setFontHeight(1, <span style="color: #8470ff; font-weight: bold;">false</span>);
  fontHeight = getValue(<span style="color: #fa8072;">"font.height"</span>);

  ovlOff = getOverlayCapPointPos(<span style="color: #fa8072;">"instaPerfGaugeAction"</span>);
  origX = ovlOff[0];
  origY = ovlOff[1];

  clearOverlay();

  tikm = getStringWidth(<span style="color: #fa8072;">"X"</span>);
  gapm = getStringWidth(<span style="color: #fa8072;">":"</span>);
  marg = 0;
  <span style="color: #00ffff;">for</span> (n=gbl_nst_pMax; n&gt;=(gbl_nst_pMin-0.05); n=n-minorDiv) {
    tmp = getStringWidth(d2s(n, 1));
    marg = maxOf(marg, tmp);
  }
  marg = marg + tikm;

  gaugeULxi = marg;
  gaugeULx  = toScaledX(gaugeULxi);
  gaugeLLxi = marg;
  gaugeLLx  = toScaledX(gaugeLLxi);

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Vertical lines</span>
  setColor(gbl_ALL_color1);
  setLineWidth(lineWidth);
  <span style="color: #00ffff;">for</span> (n=0; n&lt;nPfLines; n++) {
    X0 = gaugeULx + n*20/gbl_nst_pMax;
    X1 = gaugeLLx + n*20/gbl_nst_pMin;
    <span style="color: #00ffff;">if</span> (gbl_ALL_perfOrder) {
      Y0 = gaugeULy;
      Y1 = gaugeLLy;
    } <span style="color: #00ffff;">else</span> {
      Y0 = gaugeLLy;
      Y1 = gaugeULy;
    }
    toUnscaled(X0, Y0);
    toUnscaled(X1, Y1);
    Overlay.drawLine(X0+origX, Y0+origY, X1+origX, Y1+origY);
    Overlay.add;
  }

  lstY = instaPerfGaugeYcompute(gaugeLLy, gaugeULy, n) + 10000;
  <span style="color: #00ffff;">for</span> (n=gbl_nst_pMax; n&gt;=gbl_nst_pMin; n--) {
    curY = instaPerfGaugeYcompute(gaugeLLy, gaugeULy, n);
    gaugeLineEnd = toUnscaledX((nPfLines-1)*20/n);
    setColor(gbl_ALL_color1);
    <span style="color: #00ffff;">if</span> ( (lstY-curY) &gt; fontHeight) {
      Overlay.drawString(n, 0+origX, curY-lineWidth*3+fontHeight/4+origY);
      lstY = curY;
      Overlay.drawLine(gaugeULxi+origX-marg+getStringWidth(n)+gapm, curY+origY, gaugeULxi+gaugeLineEnd+origX, curY+origY);
      Overlay.add;
    } <span style="color: #00ffff;">else</span> {
      Overlay.drawLine(gaugeULxi+origX,                             curY+origY, gaugeULxi+gaugeLineEnd+origX, curY+origY);
      Overlay.add;
    }

    <span style="color: #00ffff;">if</span> (n &gt; gbl_nst_pMin) {
      minGap = curY - instaPerfGaugeYcompute(gaugeLLy, gaugeULy, n-minorDiv);
      <span style="color: #00ffff;">if</span> ( minGap &gt; (2*lineWidth)) {
        doAll = minGap &gt; (1.6*fontHeight);
        doHalf = (curY - instaPerfGaugeYcompute(gaugeLLy, gaugeULy, n-1)) &gt; (1.6*fontHeight);
        setColor(gbl_ALL_color2);
        <span style="color: #00ffff;">for</span> (m=n-minorDiv; m&gt;=(n-1+minorDiv-0.01); m=m-minorDiv) {
          curY = instaPerfGaugeYcompute(gaugeLLy, gaugeULy, m);
          gaugeLineEnd = toUnscaledX((nPfLines-1)*20/m);
          <span style="color: #00ffff;">if</span> (doAll || ((abs(m-n+0.5) &lt; 0.01) &amp;&amp; doHalf)) {
            lab = d2s(m, 1);
            Overlay.drawString(lab, 0+origX, curY-lineWidth*3+fontHeight/4+origY);
            Overlay.drawLine(gaugeULxi+origX-marg+getStringWidth(lab)+gapm, curY+origY, gaugeULxi+gaugeLineEnd+origX, curY+origY);
            Overlay.add;
          } <span style="color: #00ffff;">else</span> {
            Overlay.drawLine(gaugeULxi+origX,                               curY+origY, gaugeULxi+gaugeLineEnd+origX, curY+origY);
            Overlay.add;
          }
        }
      }
    }
  }

  addCapPointToOverlay(<span style="color: #fa8072;">"instaPerfGaugeAction"</span>, origX, origY);
  Overlay.show;

  run(<span style="color: #fa8072;">"Select None"</span>);
  setTool(16);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philPosFinderOptions</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philPosFinderOptions): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"philPosFinderOptions"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  fontChoiceList = getFavFontList();
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Position Finder"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,         gbl_ALL_color1);
  Dialog.addChoice(<span style="color: #fa8072;">"color2:"</span>, gbl_OLT_colors,         gbl_ALL_color2);
  Dialog.addNumber(<span style="color: #fa8072;">"Grid Size:"</span>,                      gbl_pos_gridSize, 0, 3, <span style="color: #fa8072;">"mm"</span>);
  Dialog.addMessage(<span style="color: #fa8072;">"  The Thirkell uses 3mm"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Grid Count:"</span>, gbl_OLT_pfGrdCnt,   gbl_pos_numGrids);
  Dialog.addChoice(<span style="color: #fa8072;">"Line Width:"</span>, gbl_OLT_lineWidth,  gbl_ALL_lineWidth);
  Dialog.addChoice(<span style="color: #fa8072;">"Font:"</span>, fontChoiceList,           gbl_ALL_font);
  Dialog.addChoice(<span style="color: #fa8072;">"Font Size:"</span>, gbl_OLT_fontMag,    gbl_ALL_fMag);
  Dialog.show();

  gbl_ALL_color1    = Dialog.getChoice();
  gbl_ALL_color2    = Dialog.getChoice();
  gbl_pos_gridSize  = round(Dialog.getNumber());
  gbl_pos_numGrids  = Dialog.getChoice();
  gbl_ALL_lineWidth = Dialog.getChoice();
  gbl_ALL_font      = Dialog.getChoice();
  gbl_ALL_fMag      = Dialog.getChoice();

  <span style="color: #00ffff;">if</span> (gbl_pos_gridSize &lt; 1) {
    gbl_pos_gridSize = 1;
  }

  <span style="color: #00ffff;">if</span> (nImages &gt; 0)
    philPosFinderAction();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw a position finder grid</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philPosFinderAction</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philPosFinderAction): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"philPosFinderAction"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  setTool(0);
  activateOrCreateNamedROI(<span style="color: #fa8072;">"design"</span>, <span style="color: #fa8072;">"Identify stamp design ROI for position finder"</span>, <span style="color: #fa8072;">"Select DesignROI"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  gbl_pos_origROI = Roi.getName;
  Roi.getBounds(designX, designY, designWidth, designHeight);
  gbl_pos_origX = designX;
  gbl_pos_origY = designY;
  toScaled(designX, designY);
  toScaled(designWidth, designHeight);
  run(<span style="color: #fa8072;">"Select None"</span>);

  lineWidth = parseInt(gbl_ALL_lineWidth);

  numGrids = parseInt(gbl_pos_numGrids);
  <span style="color: #00ffff;">if</span> ( isNaN(numGrids) || (numGrids &lt; 1)) {
    numGridsX = minOf(Math.ceil(designWidth  / gbl_pos_gridSize), 50);
    numGridsY = minOf(Math.ceil(designHeight / gbl_pos_gridSize), 50);
  } <span style="color: #00ffff;">else</span> {
    numGridsX = numGrids;
    numGridsY = numGrids;
  }

  setFontHeight(maxOf(30, getHeight()/maxOf(10, numGridsY+5)), <span style="color: #8470ff; font-weight: bold;">true</span>);
  fontHeight = getValue(<span style="color: #fa8072;">"font.height"</span>);

  setColor(gbl_ALL_color1);
  setLineWidth(lineWidth);

  clearOverlay();

  <span style="color: #00ffff;">for</span> (y=0; y&lt;=numGridsY; y++) {
    vlab = gbl_OLT_letters[y];
    X0 = designX;
    Y0 = designY + y*gbl_pos_gridSize;
    toUnscaled(X0, Y0);
    X1 = designX+numGridsX*gbl_pos_gridSize;
    Y1 = designY + y*gbl_pos_gridSize;
    toUnscaled(X1, Y1);

    Overlay.drawLine(X0, Y0, X1, Y1);
    Overlay.add;
    tmp = 0;
    YF = toUnscaledY(designY + (y+0.5)*gbl_pos_gridSize);
    <span style="color: #00ffff;">if</span> (y&lt;numGridsY)
      Overlay.drawString(vlab, X0-getStringWidth(<span style="color: #fa8072;">"M"</span>)*1.2, YF+fontHeight/4);
  }

  <span style="color: #00ffff;">for</span> (x=0; x&lt;=numGridsX; x++) {
    X0 = designX+x*gbl_pos_gridSize;
    Y0 = designY;
    toUnscaled(X0, Y0);
    X1 = designX+x*gbl_pos_gridSize;
    Y1 = designY + numGridsY*gbl_pos_gridSize;
    toUnscaled(X1, Y1);
    Overlay.drawLine(X0, Y0, X1, Y1);
    Overlay.add;
    tmp = 0;
    XF = toUnscaledX(designX + (x+0.5)*gbl_pos_gridSize);
    <span style="color: #00ffff;">if</span> (x&lt;numGridsX)
      Overlay.drawString(x+1, XF-getStringWidth(x+1)/2, Y0-fontHeight/4);
  }

  addCapPointToOverlay(<span style="color: #fa8072;">"philPosFinderAction"</span>, 0, 0);
  Overlay.selectable(<span style="color: #8470ff; font-weight: bold;">false</span>);
  Overlay.show;

  run(<span style="color: #fa8072;">"Select None"</span>);

  setTool(16);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">philPosFinderClicks</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(philPosFinderClicks): Function Entry"</span>);
  <span style="color: #00ffff;">if</span> (nImages &gt; 0) {
    <span style="color: #00ffff;">if</span> (<span style="color: #fa8072;">"philPosFinderAction"</span> == getOverlayCapPointName()) {
      getCursorLoc(firstX, firstY, firstZ, firstFlags);
      firstEventClickP = ((firstFlags &amp; 16) != 0);

      checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
      <span style="color: #00ffff;">if</span> (firstEventClickP) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Got a click, so we do something...</span>
        pos = philPosFinderCoord(firstX, firstY, <span style="color: #8470ff; font-weight: bold;">false</span>);
        makePoint(firstX, firstY);
        run(<span style="color: #fa8072;">"Measure"</span>);
        <span style="color: #00ffff;">if</span> (gbl_pos_gridSize == 3)
          setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>Thirkell<span style="color: #ffc0cb; font-weight: bold;">'</span>, nResults-1, pos);
        <span style="color: #00ffff;">else</span>
          setResult(<span style="color: #ffc0cb; font-weight: bold;">'</span>pos<span style="color: #ffc0cb; font-weight: bold;">'</span>, nResults-1, pos);
        updateResults();
      }
      eatClicks(); <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Consume clicks till the user takes the finger off the mouse button</span>
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Set image scale based on a DPI value.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">inHDPI &lt; 0 =&gt; interactively prompt for Horizontal DPI</span>
<span style="color: #ffa500;">//   </span><span style="color: #ff7f24;">If inVDPI is &lt; 0, then assume VDPI=HDPI (it will not be queries)</span>
<span style="color: #ffa500;">//   </span><span style="color: #ff7f24;">If inVDPI is &gt; 0, then query for VDPI as well</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">inHDPI &gt;= 0 =&gt; simply use given values of inHDPI &amp; inVDPI</span>
<span style="color: #ffa500;">//   </span><span style="color: #ff7f24;">If inVDPI &lt; 0, then VDPI will be set to inHDPI.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">setScaleFromDPI</span>(<span style="color: #63b8ff;">inHDPI</span>, <span style="color: #63b8ff;">inVDPI</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(setScaleFromDPI): Function Entry: "</span>, inHDPI, inVDPI);
  exitIfNoImages(<span style="color: #fa8072;">"setScaleFromDPI"</span>);
  <span style="color: #00ffff;">if</span> (inHDPI &lt; 0) {
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Set Scale Via DPI"</span>);
    Dialog.addNumber(<span style="color: #fa8072;">"Horz DPI:"</span>, 2400, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
    <span style="color: #00ffff;">if</span> (inVDPI &gt; 0)
      Dialog.addNumber(<span style="color: #fa8072;">"Vert DPI:"</span>, 2400, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Global Scale"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    Dialog.addMessage(<span style="color: #fa8072;">"Fixed Parameters:"</span>);
    Dialog.addMessage(<span style="color: #fa8072;">"  - Units: mm"</span>);
    <span style="color: #00ffff;">if</span> (inVDPI &lt; 0)
      Dialog.addMessage(<span style="color: #fa8072;">"  - Pixel Aspect Ratio: 1.0"</span>);
    Dialog.show();
    hdpi    = Dialog.getNumber();
    <span style="color: #00ffff;">if</span> (inVDPI &gt; 0)
      vdpi  = Dialog.getNumber();
    <span style="color: #00ffff;">else</span>
      vdpi  = -1;
    global = Dialog.getCheckbox();
  } <span style="color: #00ffff;">else</span> {
    hdpi    = inHDPI;
    vdpi    = inVDPI;
    global = <span style="color: #8470ff; font-weight: bold;">false</span>;
  }

  <span style="color: #00ffff;">if</span> ((vdpi &lt; 0) || floatEqualish(hdpi, vdpi))
    setScaleOptions = <span style="color: #fa8072;">" known=25.4 unit=mm distance="</span> + d2s(hdpi, 10) + <span style="color: #fa8072;">" pixel=1"</span>;
  <span style="color: #00ffff;">else</span>
    setScaleOptions = <span style="color: #fa8072;">" known=25.4 unit=mm distance="</span> + d2s(hdpi, 10) + <span style="color: #fa8072;">" pixel="</span> + d2s(hdpi/vdpi, 10);
  <span style="color: #00ffff;">if</span> (global) {
    setScaleOptions = setScaleOptions + <span style="color: #fa8072;">" global"</span>;
  }

  run(<span style="color: #fa8072;">"Set Scale..."</span>, setScaleOptions);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Rotate an image so that the current line selection is horizontal.  If no selection, then invert the last rotatetion done by this function.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">rotateToHorizontal</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(rotateToHorizontal): Function Entry"</span>);

  exitIfNoImages(<span style="color: #fa8072;">"rotateToHorizontal"</span>);

  <span style="color: #00ffff;">if</span>(selectionType == 5) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">straight line selection =&gt; rotate</span>
    clearOverlay();
    getLine(x1, y1, x2, y2, lineWidth);
    gbl_rho_angle = lineAngle(x1, y1, x2, y2);
    <span style="color: #00ffff;">if</span> (isNaN(gbl_rho_angle)) {
      gbl_rho_angle = 0;
      exit(<span style="color: #fa8072;">"ERROR(rotateToHorizontal): Line angle measurement failed"</span>);
    } <span style="color: #00ffff;">else</span> {
      <span style="color: #00ffff;">if</span> (gbl_rho_angle &lt; -90) {
        gbl_rho_angle = gbl_rho_angle + 180;
      } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_rho_angle &gt; 90) {
        gbl_rho_angle = gbl_rho_angle - 180;
      }
    }
  } <span style="color: #00ffff;">else</span> {                 <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">not a line selection =&gt; rotate last</span>
    gbl_rho_angle = - gbl_rho_angle;
  }

  <span style="color: #00ffff;">if</span> ( !(floatEqualish(gbl_rho_angle, 0)))
    run(<span style="color: #fa8072;">"Rotate... "</span>, <span style="color: #fa8072;">"angle="</span> + gbl_rho_angle + <span style="color: #fa8072;">" grid=1 interpolation=Bilinear enlarge"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">specializedGaugeOptions</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(specializedGaugeOptions): Function Entry"</span>);

  fontChoiceList = getFavFontList();
  gaugeChoiceList = getSpecializedGaugeList();
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Specialized Gauge"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Gauge:"</span>, gaugeChoiceList,        gbl_spl_gName);
  Dialog.addChoice(<span style="color: #fa8072;">"color1:"</span>, gbl_OLT_colors,        gbl_ALL_color1);
  Dialog.addChoice(<span style="color: #fa8072;">"Marker Count:"</span>, gbl_OLT_numPerf, gbl_ALL_numPerf);
  Dialog.addChoice(<span style="color: #fa8072;">"Line Width:"</span>, gbl_OLT_lineWidth, gbl_ALL_lineWidth);
  Dialog.addChoice(<span style="color: #fa8072;">"Font:"</span>, fontChoiceList,          gbl_ALL_font);
  Dialog.addChoice(<span style="color: #fa8072;">"Font Size:"</span>, gbl_OLT_fontMag,    gbl_ALL_fMag);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Fill Dots"</span>,                    gbl_ALL_fillDots);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Use Dots"</span>,                     gbl_spl_useDots);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Reverse Order"</span>,                gbl_ALL_perfOrder);
  Dialog.show();

  gbl_spl_gName     = Dialog.getChoice();
  gbl_ALL_color1    = Dialog.getChoice();
  gbl_ALL_numPerf   = Dialog.getChoice();
  gbl_ALL_lineWidth = Dialog.getChoice();
  gbl_ALL_font      = Dialog.getChoice();
  gbl_ALL_fMag      = Dialog.getChoice();
  gbl_ALL_fillDots  = Dialog.getCheckbox();
  gbl_spl_useDots   = Dialog.getCheckbox();
  gbl_ALL_perfOrder = Dialog.getCheckbox();

  <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Single Line Custom Perforation Gauge"</span>)
    specializedGaugeSingleOptions(<span style="color: #8470ff; font-weight: bold;">false</span>);
  <span style="color: #00ffff;">else</span>
    <span style="color: #00ffff;">if</span>(nImages &gt; 0)
      specializedGaugeAction();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">specializedGaugeSingleOptions</span>(<span style="color: #63b8ff;">queryForPreset</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(specializedGaugeSingleOptions): Function Entry"</span>);

  <span style="color: #00ffff;">if</span> (queryForPreset) {
    lables = perfPresetLookup(<span style="color: #fa8072;">""</span>);

    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Single Line Custom Perforation Gauge Preset Options"</span>);
    Dialog.addChoice(<span style="color: #fa8072;">"Preset:"</span>, lables, lables[0]);
    Dialog.show();
    presetName = Dialog.getChoice();

    presetData = perfPresetLookup(presetName);

    gbl_ssp_sizv = presetData[0];
    gbl_ssp_gapv = presetData[1];
    gbl_ssp_sizu = <span style="color: #fa8072;">"mm"</span>;
    gbl_ssp_gapu = <span style="color: #fa8072;">"mm"</span>;
    gbl_ssp_lab  = presetData[2];
  }

  <span style="color: #00ffff;">do</span> {
    needGoodData = <span style="color: #8470ff; font-weight: bold;">false</span>;
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Single Line Custom Perforation Gauge"</span>);
    Dialog.addString(<span style="color: #fa8072;">"Label:"</span>,                           gbl_ssp_lab, 25);
    Dialog.addMessage(<span style="color: #fa8072;">"Perf value used if label empty"</span>);
    Dialog.addNumber(<span style="color: #fa8072;">"Dot Sizes:"</span>,                       gbl_ssp_sizv, 5, 10, <span style="color: #fa8072;">""</span>);
    Dialog.addToSameRow();
    Dialog.addChoice(<span style="color: #fa8072;">""</span>, gbl_OLT_lnUnits,                gbl_ssp_sizu);
    Dialog.addNumber(<span style="color: #fa8072;">"Perf Gauge:"</span>,                      gbl_ssp_gapv, 5, 10, <span style="color: #fa8072;">""</span>);
    Dialog.addToSameRow();
    Dialog.addChoice(<span style="color: #fa8072;">""</span>, gbl_OLT_pfUnits,                gbl_ssp_gapu);
    Dialog.show();

    gbl_ssp_lab  = Dialog.getString();
    gbl_ssp_sizv = Dialog.getNumber();
    gbl_ssp_sizu = Dialog.getChoice();
    gbl_ssp_gapv = Dialog.getNumber();
    gbl_ssp_gapu = Dialog.getChoice();

    <span style="color: #00ffff;">if</span> ((isNaN(gbl_ssp_sizv)) || (gbl_ssp_sizv &lt;= 0)) {
      needGoodData = <span style="color: #8470ff; font-weight: bold;">true</span>;
      gbl_ssp_sizv = 1;
      showMessage(<span style="color: #fa8072;">"PhilaJ: specializedGaugeSingleOptions"</span>, <span style="color: #fa8072;">"ERROR: Dot size was invalid!"</span>);
    }

    <span style="color: #00ffff;">if</span> ((isNaN(gbl_ssp_gapv)) || (gbl_ssp_gapv &lt;= 0)) {
      needGoodData = <span style="color: #8470ff; font-weight: bold;">true</span>;
      gbl_ssp_gapv = 12;
      showMessage(<span style="color: #fa8072;">"PhilaJ: specializedGaugeSingleOptions"</span>, <span style="color: #fa8072;">"ERROR: Perf value invalid!"</span>);
    }
  } <span style="color: #00ffff;">while</span>(needGoodData);

  <span style="color: #00ffff;">if</span> (gbl_ssp_lab == <span style="color: #fa8072;">""</span>) {
    gbl_ssp_lab = d2s(gbl_ssp_gapv, 2);
    <span style="color: #00ffff;">if</span> (gbl_ssp_gapu != <span style="color: #fa8072;">"perfs/2cm"</span>)
      gbl_ssp_lab = gbl_ssp_lab + <span style="color: #fa8072;">" "</span> + gbl_ssp_gapu;
  }

  gbl_spl_gName = <span style="color: #fa8072;">"Single Line Custom Perforation Gauge"</span>;

  <span style="color: #00ffff;">if</span>(nImages &gt; 0)
    specializedGaugeAction();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Draw Specialized Perf Gauge</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">specializedGaugeAction</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(specializedGaugeAction): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"specializedGaugeAction"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Traditional Kiusalas Perforation Gauge"</span>) {
    gbl_spl_perfGaps  = newArray(   95.0*0.0254,    81.0*0.0254,    80.0*0.0254,    79.0*0.0254,    75.0*0.0254,    73.0*0.0254,    72.0*0.0254,    70.0*0.0254,    67.0*0.0254,    66.0*0.0254,    63.0*0.0254,   51.0*0.0254);
    gbl_spl_perfDiams = newArray(         1.000,          1.000,          1.000,          1.000,          1.000,          1.000,          1.000,          1.000,          1.000,          1.000,          0.850,         0.700);
    gbl_spl_perfLabs  = newArray(  <span style="color: #fa8072;">"95.0  8.29"</span>,   <span style="color: #fa8072;">"81.0  9.72"</span>,   <span style="color: #fa8072;">"80.0  9.84"</span>,   <span style="color: #fa8072;">"79.0  9.97"</span>,   <span style="color: #fa8072;">"75.0 10.50"</span>,   <span style="color: #fa8072;">"73.0 10.79"</span>,   <span style="color: #fa8072;">"72.0 10.94"</span>,   <span style="color: #fa8072;">"70.0 11.25"</span>,   <span style="color: #fa8072;">"67.0 11.75"</span>,   <span style="color: #fa8072;">"66.0 11.93"</span>,   <span style="color: #fa8072;">"63.0 12.50"</span>,  <span style="color: #fa8072;">"51.0 15.44"</span>);
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Updated Kiusalas Perforation Gauge"</span>) {
    gbl_spl_perfGaps  = newArray(   95.0*0.0254,    81.0*0.0254,    80.0*0.0254,    79.0*0.0254,    75.0*0.0254,    73.0*0.0254,    72.5*0.0254,    72.0*0.0254,    70.0*0.0254,    67.0*0.0254,    66.0*0.0254,    63.0*0.0254,   51.0*0.0254);
    gbl_spl_perfDiams = newArray(    0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,     0.042*25.4,          0.850,         0.700);
    gbl_spl_perfLabs  = newArray(  <span style="color: #fa8072;">"95.0  8.29"</span>,   <span style="color: #fa8072;">"81.0  9.72"</span>,   <span style="color: #fa8072;">"80.0  9.84"</span>,   <span style="color: #fa8072;">"79.0  9.97"</span>,   <span style="color: #fa8072;">"75.0 10.50"</span>,   <span style="color: #fa8072;">"73.0 10.79"</span>,   <span style="color: #fa8072;">"72.5 10.86"</span>,   <span style="color: #fa8072;">"72.0 10.94"</span>,   <span style="color: #fa8072;">"70.0 11.25"</span>,   <span style="color: #fa8072;">"67.0 11.75"</span>,   <span style="color: #fa8072;">"66.0 11.93"</span>,   <span style="color: #fa8072;">"63.0 12.50"</span>,  <span style="color: #fa8072;">"51.0 15.44"</span>);
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Liberty Issue Perforation Gauge"</span>) {
    gbl_spl_perfGaps  = newArray(  80.0*0.0254,   75.0*0.0254,   72.0*0.0254,   70.0*0.0254);
    gbl_spl_perfDiams = newArray(        0.950,         1.100,         1.100,         1.100);
    gbl_spl_perfLabs  = newArray(   <span style="color: #fa8072;">"Sm  9.84"</span>,    <span style="color: #fa8072;">"Lg 10.50"</span>,    <span style="color: #fa8072;">"Lg 10.94"</span>,    <span style="color: #fa8072;">"Lg 11.25"</span>);
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Bari Wolf Issue Perforation Gauge"</span>) {
    gbl_spl_perfGaps  = newArray(20/10.86, 20/10.88, 20/11.00, 20/11.43, 20/11.45);
    gbl_spl_perfDiams = newArray(    0.93,     1.02,     1.06,     1.06,     1.06);
    gbl_spl_perfLabs  = newArray( <span style="color: #fa8072;">"10.86"</span>,  <span style="color: #fa8072;">"10.88"</span>,  <span style="color: #fa8072;">"11.00"</span>,  <span style="color: #fa8072;">"11.43"</span>,  <span style="color: #fa8072;">"11.45"</span>);
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_spl_gName == <span style="color: #fa8072;">"Single Line Custom Perforation Gauge"</span>) {
    gbl_spl_perfGaps  = newArray(1);
    gbl_spl_perfDiams = newArray(1);
    gbl_spl_perfLabs  = newArray(1);
    gbl_spl_perfGaps[0]  = convertPerfToMM(gbl_ssp_gapv, gbl_ssp_gapu);
    gbl_spl_perfDiams[0] = convertLengthToMM(gbl_ssp_sizv, gbl_ssp_sizu);
    gbl_spl_perfLabs[0]  = gbl_ssp_lab;
  } <span style="color: #00ffff;">else</span> {
    perfFileName = replace(gbl_spl_gName, <span style="color: #fa8072;">" "</span>, <span style="color: #fa8072;">"_"</span>) + <span style="color: #fa8072;">".ijm"</span>;
    perfFullPath = pathJoin(newArray(getDirectory(<span style="color: #fa8072;">"home"</span>), <span style="color: #fa8072;">".philaj"</span>, <span style="color: #fa8072;">"perfs"</span>, perfFileName));
    <span style="color: #00ffff;">if</span> ( !(File.exists(perfFullPath)))
      exit(<span style="color: #fa8072;">"ERROR(specializedGaugeAction): Perf file is missing: "</span> + perfFileName);
    perfString = File.openAsString(perfFullPath);
    perfLines  = split(perfString, <span style="color: #fa8072;">"\n"</span>);
    numLines = perfLines.length;
    gbl_spl_perfGaps  = newArray(numLines);
    gbl_spl_perfDiams = newArray(numLines);
    gbl_spl_perfLabs  = newArray(numLines);
    <span style="color: #00ffff;">for</span>(i=0; i&lt;numLines; i++) {
      perfFields = split(perfLines[i], <span style="color: #fa8072;">";"</span>);
      <span style="color: #00ffff;">if</span> (perfFields.length != 3)
        exit(<span style="color: #fa8072;">"ERROR(specializedGaugeAction): Malformed line ("</span> + d2s(i+1, 0) + <span style="color: #fa8072;">") in perf file ("</span> +  perfFileName + <span style="color: #fa8072;">")"</span>);
      gbl_spl_perfGaps[i]  = parseFloat(perfFields[0]);
      gbl_spl_perfDiams[i] = parseFloat(perfFields[1]);
      gbl_spl_perfLabs[i]  = perfFields[2];
    }
  }

  <span style="color: #00ffff;">if</span> (gbl_spl_perfLabs.length &gt; 0) {
    exitIfNoImages(<span style="color: #fa8072;">"specializedGaugeAction"</span>);
    checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

    numDots = parseInt(gbl_ALL_numPerf);

    <span style="color: #00ffff;">if</span> (gbl_ALL_fillDots &amp;&amp; gbl_spl_useDots)
      lineWidth = 0;
    <span style="color: #00ffff;">else</span>
      lineWidth = parseInt(gbl_ALL_lineWidth);

    minFontSz = maxOf(2.5, 2*arrayMaxValue(gbl_spl_perfDiams));
    setFontHeight(minFontSz, <span style="color: #8470ff; font-weight: bold;">false</span>);
    fontHeight = getValue(<span style="color: #fa8072;">"font.height"</span>);

    setColor(gbl_ALL_color1);
    setLineWidth(lineWidth);

    ovlOff = getOverlayCapPointPos(<span style="color: #fa8072;">"specializedGaugeAction"</span>);
    origX = ovlOff[0];
    origY = ovlOff[1];

    clearOverlay();

    gaugeULxi = 0;
    <span style="color: #00ffff;">for</span>(n=0; n&lt;gbl_spl_perfGaps.length; n++) {
      <span style="color: #00ffff;">if</span> (getStringWidth(gbl_spl_perfLabs[n]) &gt; gaugeULxi) {
        gaugeULxi = getStringWidth(gbl_spl_perfLabs[n]);
      }
    }
    gaugeULxi = gaugeULxi + getStringWidth(<span style="color: #fa8072;">"M"</span>);
    gaugeULyi = fontHeight;

    <span style="color: #00ffff;">for</span>(i=0; i&lt;gbl_spl_perfGaps.length; i++) {
      <span style="color: #00ffff;">if</span> (gbl_ALL_perfOrder)
        n = gbl_spl_perfGaps.length - i - 1;
      <span style="color: #00ffff;">else</span>
        n = i;
      Overlay.drawString(gbl_spl_perfLabs[n], 1+origX, gaugeULyi+i*fontHeight+fontHeight/4+origY);
      perfDiamX = gbl_spl_perfDiams[n];
      perfDiamY = gbl_spl_perfDiams[n];
      toUnscaled(perfDiamX, perfDiamY);
      <span style="color: #00ffff;">for</span>(m=0; m&lt;numDots; m++) {
        totalGap = toUnscaledX(m*gbl_spl_perfGaps[n]);
        <span style="color: #00ffff;">if</span> (gbl_spl_useDots) {
          <span style="color: #00ffff;">if</span> (gbl_ALL_fillDots) {
            makeOval(gaugeULxi+totalGap+origX, gaugeULyi-perfDiamY/2+i*fontHeight+origY, perfDiamX, perfDiamY);
            Overlay.addSelection(<span style="color: #fa8072;">""</span>, 0, gbl_ALL_color1);
          } <span style="color: #00ffff;">else</span> {
            Overlay.drawEllipse(gaugeULxi+totalGap+origX, gaugeULyi-perfDiamY/2+i*fontHeight+origY, perfDiamX-lineWidth, perfDiamY-lineWidth);
          }
        } <span style="color: #00ffff;">else</span> {
          Overlay.drawLine(gaugeULxi+totalGap+origX, gaugeULyi-perfDiamY/2+i*fontHeight+origY, gaugeULxi+totalGap+origX, gaugeULyi+perfDiamY/2+i*fontHeight+origY);
          Overlay.add;
        }
      }
    }

    addCapPointToOverlay(<span style="color: #fa8072;">"specializedGaugeAction"</span>, origX, origY);
    Overlay.show;

    setTool(16);
    run(<span style="color: #fa8072;">"Select None"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Open a file and set scale based on DPI information embedded in file name.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">magicImageOpenROIDPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(magicImageOpenROIDPI): Function Entry"</span>);
  open();
  loadAssociatedROIs(<span style="color: #fa8072;">""</span>, <span style="color: #fa8072;">"Clear existing ROIs before loading ROIs from disk?"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Open a file and set scale based on DPI information embedded in file name.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">magicImageSaveROI</span>(<span style="color: #63b8ff;">doSaveAs</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(magicImageOpenROIDPI): Function Entry: "</span>, doSaveAs);
  exitIfNoImages(<span style="color: #fa8072;">"magicImageOpenROIDPI"</span>);

  <span style="color: #00ffff;">if</span> (doSaveAs) {
    saveAs(<span style="color: #fa8072;">"PNG"</span>);
  } <span style="color: #00ffff;">else</span> {
    fileName = getInfo(<span style="color: #fa8072;">"image.filename"</span>);
    dirName  = getInfo(<span style="color: #fa8072;">"image.directory"</span>);

    <span style="color: #00ffff;">if</span> (matches(fileName, <span style="color: #fa8072;">"^.*\\.[Pp][Nn][Gg]$"</span>)) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">PNG already</span>
      newFileName = fileName;
    <span style="color: #00ffff;">else</span>
      newFileName = File.getNameWithoutExtension(fileName) + <span style="color: #fa8072;">".png"</span>;
    savePath = pathJoin(newArray(dirName, newFileName));

    <span style="color: #00ffff;">if</span> (File.exists(savePath))
      saveIt = getBoolean(<span style="color: #fa8072;">"Image file already exists! \nOverwrite '"</span> + newFileName + <span style="color: #fa8072;">"'?"</span>);
    <span style="color: #00ffff;">else</span>
      saveIt = <span style="color: #8470ff; font-weight: bold;">true</span>;

    <span style="color: #00ffff;">if</span> (saveIt)
      saveAs(<span style="color: #fa8072;">"PNG"</span>, savePath);
  }
  saveAssociatedROIs(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct a list of nice fonts</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getFavFontList</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getFavFontList): Function Entry"</span>);
  fontChooseList = newArray(<span style="color: #fa8072;">"SanSerif"</span>, <span style="color: #fa8072;">"Serif"</span>, <span style="color: #fa8072;">"Monospaced"</span>);
  favoriteFonts = newArray(<span style="color: #fa8072;">"Consolas"</span>, <span style="color: #fa8072;">"DejaVu Sans Mono"</span>);
  sysFonts = getFontList();
  <span style="color: #00ffff;">for</span>(i=0;i&lt;favoriteFonts.length;i++) {
    tmp = Array.filter(sysFonts, <span style="color: #fa8072;">"(^"</span> + favoriteFonts[i] + <span style="color: #fa8072;">"$)"</span>);
    <span style="color: #00ffff;">if</span> (tmp.length == 1)
      fontChooseList = Array.concat(tmp, fontChooseList);
  }
  <span style="color: #00ffff;">return</span> fontChooseList;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">setFontHeight</span>(<span style="color: #63b8ff;">targetHeight</span>, <span style="color: #63b8ff;">inPixels</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(setFontHeight): Function Entry: "</span>, targetHeight);
  <span style="color: #00ffff;">if</span> ( !(inPixels))
    targetHeight = toUnscaledY(targetHeight);
  targetHeight *=parseFloat(substring(gbl_ALL_fMag, 0, indexOf(gbl_ALL_fMag, <span style="color: #fa8072;">"%"</span>)))/100.0;
  setFont(gbl_ALL_font, 100, <span style="color: #fa8072;">"antialiased"</span>);
  fontHeightAt100 = getValue(<span style="color: #fa8072;">"font.height"</span>);
  goodFontSize = round(100*targetHeight/fontHeightAt100);
  setFont(gbl_ALL_font, goodFontSize, <span style="color: #fa8072;">"antialiased"</span>);
  setJustification(<span style="color: #fa8072;">"left"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Set the scale from a scale ROI.  Return true if scale was set.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">setScaleFromROI</span>(<span style="color: #63b8ff;">showScaleSetWarning</span>, <span style="color: #63b8ff;">showFailWarning</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(setScaleFromROI): Function Entry"</span>);
  lengthMM  = 0;
  lengthPXx = 0;
  lengthPXy = 0;
  <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>) &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiManager(<span style="color: #fa8072;">"count"</span>); i++) {
      roiManager(<span style="color: #fa8072;">"select"</span>, i);
      <span style="color: #00ffff;">if</span> (selectionType == 0) {
        roiName = Roi.getName;
        <span style="color: #00ffff;">if</span> ((startsWith(roiName, <span style="color: #fa8072;">"scale_"</span>)) &amp;&amp; (endsWith(roiName, <span style="color: #fa8072;">"mm"</span>))) {
          Roi.getBounds(x, y, lengthPXx, lengthPXy);
          lengthMM = substring(roiName, indexOf(roiName, <span style="color: #fa8072;">"_"</span>) + 1, lengthOf(roiName) - 2);
          setScaleOptions = <span style="color: #fa8072;">" known="</span> + lengthMM + <span style="color: #fa8072;">" unit=mm distance="</span> + d2s(lengthPXx, 10) + <span style="color: #fa8072;">" pixel="</span> + d2s(lengthPXx/lengthPXy, 10);
          run(<span style="color: #fa8072;">"Set Scale..."</span>, setScaleOptions);
          run(<span style="color: #fa8072;">"Select None"</span>);
          <span style="color: #00ffff;">if</span>(showScaleSetWarning)
            showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromROI"</span>, <span style="color: #fa8072;">"Image scale was set via scale ROI!"</span>);
          <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">true</span>;
        }
      }
    }
  }
  <span style="color: #00ffff;">if</span>(showFailWarning)
    showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromROI"</span>, <span style="color: #fa8072;">"WARNING: Image scale could not be set via scale ROI!"</span>);
  <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">false</span>;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If the image has a scale with known units, then convert the scale units to mm</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return 1 if we converted to mm, return 2 if it was in mm already, return 0 if no scale was set or units were unknown</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertImageScaleUnits</span>(<span style="color: #63b8ff;">showScaleSetWarning</span>, <span style="color: #63b8ff;">showFailWarning</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(convertImageScaleUnits): Function Entry: "</span>, showScaleSetWarning, showFailWarning);
  exitIfNoImages(<span style="color: #fa8072;">"convertImageScaleUnits"</span>);

  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);
  <span style="color: #00ffff;">if</span> (pixelLengthUnit == <span style="color: #fa8072;">"mm"</span>) {
    <span style="color: #00ffff;">return</span> 2;
  } <span style="color: #00ffff;">else</span> {
    newPixelWidth = convertLengthToMM(pixelWidth, pixelLengthUnit);
    <span style="color: #00ffff;">if</span> (isNaN(newPixelWidth)) {
      <span style="color: #00ffff;">if</span>(showFailWarning)
        showMessage(<span style="color: #fa8072;">"PhilaJ: convertImageScaleUnits"</span>, <span style="color: #fa8072;">"WARNING: Image scale units were unknown ("</span> + pixelLengthUnit + <span style="color: #fa8072;">").  Unable to convert to millimeters for PhilaJ."</span>);
      <span style="color: #00ffff;">return</span> 0;
    } <span style="color: #00ffff;">else</span> {
      run(<span style="color: #fa8072;">"Set Scale..."</span>, <span style="color: #fa8072;">" known="</span> + d2s(newPixelWidth, 10) + <span style="color: #fa8072;">" unit=mm distance=1 pixel="</span> + d2s(pixelWidth/pixelHeight, 10));
      <span style="color: #00ffff;">if</span>(showScaleSetWarning)
        showMessage(<span style="color: #fa8072;">"PhilaJ: convertImageScaleUnits"</span>, <span style="color: #fa8072;">"WARNING: Image scale was in "</span> + pixelLengthUnit + <span style="color: #fa8072;">", and has been converted to millimeters for PhilaJ."</span>);
      <span style="color: #00ffff;">return</span> 1;
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Set Scale based on filename.  Return true if we set the DPI.  foo_2400dpi.jpg    foo_2390hdpi_2400vdpi.jpg</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">setScaleFromFileName</span>(<span style="color: #63b8ff;">showScaleSetWarning</span>, <span style="color: #63b8ff;">showFailWarning</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(setScaleFromFileName): Function Entry: "</span>, showFailWarning);
  exitIfNoImages(<span style="color: #fa8072;">"setScaleFromFileName"</span>);
  fileName = getInfo(<span style="color: #fa8072;">"image.filename"</span>);
  fileNameParts = split(toUpperCase(fileName), <span style="color: #fa8072;">"_"</span>);
  dpiAll = <span style="color: #fa8072;">""</span>;
  dpiH   = <span style="color: #fa8072;">""</span>;
  dpiV   = <span style="color: #fa8072;">""</span>;
  <span style="color: #00ffff;">for</span>(i=0;i&lt;fileNameParts.length;i++) {
    dpiIdx = indexOf(fileNameParts[i], <span style="color: #fa8072;">"DPI"</span>);
    <span style="color: #00ffff;">if</span> (dpiIdx&gt;0) {
      dpiStr = substring(fileNameParts[i], 0, dpiIdx);
      <span style="color: #00ffff;">if</span> (endsWith(dpiStr, <span style="color: #fa8072;">"H"</span>)) {
        <span style="color: #00ffff;">if</span> (lengthOf(dpiH)&gt;0)
          showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Multiple HDPI values encoded in filename!"</span>);
        dpiH = substring(dpiStr, 0, lengthOf(dpiStr)-1);
      } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (endsWith(dpiStr, <span style="color: #fa8072;">"V"</span>)) {
        <span style="color: #00ffff;">if</span> (lengthOf(dpiV)&gt;0)
          showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Multiple VDPI values encoded in filename!"</span>);
        dpiV = substring(dpiStr, 0, lengthOf(dpiStr)-1);
      } <span style="color: #00ffff;">else</span> {
        <span style="color: #00ffff;">if</span> (lengthOf(dpiAll)&gt;0)
          showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Multiple DPI values encoded in filename!"</span>);
        dpiAll = dpiStr;
      }
    }
  }

  <span style="color: #00ffff;">if</span> ((lengthOf(dpiAll)&gt;0) &amp;&amp; (maxOf(lengthOf(dpiH), lengthOf(dpiV))==0)) {
    tmp = parseFloat(dpiAll);
    <span style="color: #00ffff;">if</span> (tmp &gt; 0) {
      setScaleFromDPI(dpiAll, -1);
      <span style="color: #00ffff;">if</span> (showScaleSetWarning)
        showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Image scale has been set from DPI information embedded in image name!"</span>);
      <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">true</span>;
    } <span style="color: #00ffff;">else</span> {
      showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Malformed DPI encoded in filename!"</span>);
    }
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ((lengthOf(dpiAll)==0) &amp;&amp; (lengthOf(dpiH)&gt;0) &amp;&amp; (lengthOf(dpiH)&gt;0)) {
    tmpH = parseFloat(dpiH);
    tmpV = parseFloat(dpiV);
    <span style="color: #00ffff;">if</span> ((tmpH &gt; 0) &amp;&amp; (tmpV &gt; 0)) {
      setScaleFromDPI(tmpH, tmpV);
      <span style="color: #00ffff;">if</span> (showScaleSetWarning)
        showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Image scale has been set from HDPI/VDPI information embedded in image name!"</span>);
      <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">true</span>;
    } <span style="color: #00ffff;">else</span> {
      showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Malformed HDPI/VDPI encoded in filename!"</span>);
    }
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> ((lengthOf(dpiAll)&gt;0) || (lengthOf(dpiH)&gt;0) || (lengthOf(dpiH)&gt;0)) {
    showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Malformed DPI/HDPI/VDPI encoded in filename!"</span>);
  }
  <span style="color: #00ffff;">if</span>(showFailWarning)
    showMessage(<span style="color: #fa8072;">"PhilaJ: setScaleFromFileName"</span>, <span style="color: #fa8072;">"WARNING: Could not set DPI from filename!"</span>);
  <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">false</span>;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">arrayMaxValue</span>(<span style="color: #63b8ff;">a</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(arrayMaxValue): Function Entry: ("</span> + String.join(a, <span style="color: #fa8072;">","</span>) + <span style="color: #fa8072;">")"</span>);
  max = Array.findMinima(a, 0.1);
  <span style="color: #00ffff;">if</span> (max.length &lt; 1)
    <span style="color: #00ffff;">return</span> a[0];
  <span style="color: #00ffff;">else</span>
    <span style="color: #00ffff;">return</span> a[max[0]];
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for an ROIs by name.  Delete all that match the pattern.  Return number of ROIs deleted.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">deleteNamedROI</span>(<span style="color: #63b8ff;">strPattern</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(deleteNamedROI): Function Entry: "</span>, strPattern);
  numDeleted = selectNamedROIsInManager(strPattern);
  <span style="color: #00ffff;">if</span> (numDeleted &gt; 0)
    roiManager(<span style="color: #fa8072;">"delete"</span>);
  <span style="color: #00ffff;">return</span> numDeleted;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Save ROIs in ROI manager to PhilaJ ROI sidecar file</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">makeALLroi</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(makeALLroi): Function Entry"</span>);
  deleteNamedROI(<span style="color: #fa8072;">"ALL"</span>);
  run(<span style="color: #fa8072;">"Select None"</span>);
  run(<span style="color: #fa8072;">"Select All"</span>);
  <span style="color: #ffa500;">//</span><span style="color: #ff7f24;">makeRectangle(0, 0, getWidth(), getHeight());</span>
  Roi.setName(<span style="color: #fa8072;">"ALL"</span>);
  roiManager(<span style="color: #fa8072;">"add"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Save ROIs in ROI manager to PhilaJ ROI sidecar file</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">saveAssociatedROIs</span>(<span style="color: #63b8ff;">showEmptyListError</span>, <span style="color: #63b8ff;">askBeforeOverwrite</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(saveAssociatedROIs): Function Entry: "</span>, showEmptyListError, askBeforeOverwrite);
  exitIfNoImages(<span style="color: #fa8072;">"saveAssociatedROIs"</span>);

  <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>) &gt; 0) {
    makeALLroi();

    fileName = getInfo(<span style="color: #fa8072;">"image.filename"</span>);
    tmp = lastIndexOf(fileName, <span style="color: #fa8072;">"."</span>);
    <span style="color: #00ffff;">if</span>(tmp &gt; 0)
      fileName = substring(fileName, 0, tmp);
    fileName = fileName + <span style="color: #fa8072;">".roi.zip"</span>;
    roiFileName = getInfo(<span style="color: #fa8072;">"image.directory"</span>) + fileName;

    <span style="color: #00ffff;">if</span> (askBeforeOverwrite &amp;&amp; File.exists(roiFileName))
      saveIt = getBoolean(<span style="color: #fa8072;">"PhilaJ ROI sidecar file already exists! \nOverwrite '"</span> + fileName + <span style="color: #fa8072;">"'?"</span>);
    <span style="color: #00ffff;">else</span>
      saveIt = <span style="color: #8470ff; font-weight: bold;">true</span>;
    <span style="color: #00ffff;">if</span> (saveIt)
      roiManager(<span style="color: #fa8072;">"Save"</span>, roiFileName);
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> (showEmptyListError)
      showMessage(<span style="color: #fa8072;">"PhilaJ: saveAssociatedROIs"</span>, <span style="color: #fa8072;">"ERROR: ROI Manager is empty -- nothing to save!"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Load PhilaJ ROI sidecar file and populate ROI manager</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">loadAssociatedROIs</span>(<span style="color: #63b8ff;">loadMessage</span>, <span style="color: #63b8ff;">zapMessage</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(loadAssociatedROIs): Function Entry: "</span>, loadMessage, zapMessage);
  exitIfNoImages(<span style="color: #fa8072;">"loadAssociatedROIs"</span>);

  fileName = getInfo(<span style="color: #fa8072;">"image.filename"</span>);
  dirPath  = getInfo(<span style="color: #fa8072;">"image.directory"</span>);
  roiFileName = dirPath + fileName;
  tmp = lastIndexOf(roiFileName, <span style="color: #fa8072;">"."</span>);
  <span style="color: #00ffff;">if</span>(tmp &gt; 0)
    roiFileName = substring(roiFileName, 0, tmp);
  roiFileName = roiFileName + <span style="color: #fa8072;">".roi.zip"</span>;
  <span style="color: #00ffff;">if</span> (File.exists(roiFileName)) {
    <span style="color: #00ffff;">if</span> (lengthOf(loadMessage) &gt; 0)
      loadIt = (getBoolean(loadMessage + <span style="color: #fa8072;">"\nLoad ROIs from disk?"</span>));
    <span style="color: #00ffff;">else</span>
      loadIt = <span style="color: #8470ff; font-weight: bold;">true</span>;
    <span style="color: #00ffff;">if</span> (loadIt) {
      <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>)&gt;0) {
        <span style="color: #00ffff;">if</span> (lengthOf(zapMessage) &gt; 0)
          zapIt = getBoolean(zapMessage +
                             <span style="color: #fa8072;">"\n    No: Keeps current ROIs and loads new ones"</span>  +
                             <span style="color: #fa8072;">"\n    Cancel: Keeps current ROIs and will not load new ones"</span>);
        <span style="color: #00ffff;">else</span>
          zapIt = <span style="color: #8470ff; font-weight: bold;">true</span>;
        <span style="color: #00ffff;">if</span> (zapIt)
          roiManager(<span style="color: #fa8072;">"reset"</span>);
      }
      open(roiFileName);
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Create a scale ROI</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">makeScaleROI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(makeScaleROI): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"makeScaleROI"</span>);
  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);
  <span style="color: #00ffff;">if</span> (pixelLengthUnit == <span style="color: #fa8072;">"mm"</span>) {
    <span style="color: #00ffff;">if</span> (floatEqualish(pixelHeight, pixelWidth)) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">square</span>
      roiSize = minOf(getWidth, getHeight) - 1;
      makeRectangle(0, 0, roiSize, roiSize);
      Roi.setName(<span style="color: #fa8072;">"scale_"</span> + d2s(pixelWidth * roiSize, 10) + <span style="color: #fa8072;">"mm"</span>);
      roiManager(<span style="color: #fa8072;">"add"</span>);
    } <span style="color: #00ffff;">else</span> {
      roiWide   = getWidth - 1;
      roiHeight = getHeight - 1;
      <span style="color: #00ffff;">if</span> ((roiWide * pixelWidth) &gt; (roiHeight * pixelHeight))
        roiWidth = (roiHeight * pixelHeight) / roiWide;
      <span style="color: #00ffff;">else</span>
        roiHeight = (roiWide * pixelWidth) / pixelHeight;
      makeRectangle(0, 0, roiWide, roiHeight);
      Roi.setName(<span style="color: #fa8072;">"scale_"</span> + d2s(pixelWidth * roiWide, 10) + <span style="color: #fa8072;">"mm"</span>);
      roiManager(<span style="color: #fa8072;">"add"</span>);
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return index of ROI if it exists, and -1 if it doesn't</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">existsInROImanagerEqual</span>(<span style="color: #63b8ff;">name</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(existsInROImanagerEqual): Function Entry: "</span>, name);
  <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>) &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiManager(<span style="color: #fa8072;">"count"</span>); i++)
      <span style="color: #00ffff;">if</span> (RoiManager.getName(i) == name)
        <span style="color: #00ffff;">return</span> i;
  }
  <span style="color: #00ffff;">return</span> -1;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return index of ROI if it exists, and -1 if it doesn't</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">existsInROImanagerStartsWith</span>(<span style="color: #63b8ff;">aStr</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(existsInROImanagerStartsWith): Function Entry: "</span>, aStr);
  <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>) &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiManager(<span style="color: #fa8072;">"count"</span>); i++)
      <span style="color: #00ffff;">if</span> (startsWith(RoiManager.getName(i), aStr))
        <span style="color: #00ffff;">return</span> i;
  }
  <span style="color: #00ffff;">return</span> -1;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return index of ROI if it exists, and -1 if it doesn't</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">bulkROImanagerRename</span>(<span style="color: #63b8ff;">oldString</span>, <span style="color: #63b8ff;">newString</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(bulkROImanagerRename): Function Entry: "</span>, oldString, newString);

  <span style="color: #00ffff;">if</span> ((oldString == <span style="color: #fa8072;">""</span>) || (newString == <span style="color: #fa8072;">""</span>)) {
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: ROI Manager Name Search &amp; Replace"</span>);
    Dialog.setInsets(5, 0, 0);
    Dialog.addMessage(<span style="color: #fa8072;">"Apply the string replace function on each"</span>);
    Dialog.setInsets(0, 0, 0);
    Dialog.addMessage(<span style="color: #fa8072;">"ROI name.  Read the macro docs for details."</span>);
    Dialog.setInsets(0, 0, 20);
    Dialog.addMessage(<span style="color: #fa8072;">"Backup ROIs just in case!"</span>);
    Dialog.addString(<span style="color: #fa8072;">"Search:"</span>,  <span style="color: #fa8072;">""</span>, 25);
    Dialog.addString(<span style="color: #fa8072;">"Replace:"</span>, <span style="color: #fa8072;">""</span>, 25);
    Dialog.show();
    oldString = Dialog.getString();
    newString = Dialog.getString();
  }

  numRenamed = 0;
  <span style="color: #00ffff;">if</span> (roiManager(<span style="color: #fa8072;">"count"</span>) &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiManager(<span style="color: #fa8072;">"count"</span>); i++) {
      oldName = RoiManager.getName(i);
      newName = replace(oldName, oldString, newString);
      <span style="color: #00ffff;">if</span> (newName != oldName) {
        roiManager(<span style="color: #fa8072;">"select"</span>, i);
        roiManager(<span style="color: #fa8072;">"rename"</span>, newName);
        numRenamed++;
      }
    }
  }
  <span style="color: #00ffff;">return</span> numRenamed;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Activate or create named ROI</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">activateOrCreateNamedROI</span>(<span style="color: #63b8ff;">name</span>, <span style="color: #63b8ff;">title</span>, <span style="color: #63b8ff;">message</span>, <span style="color: #63b8ff;">loadIfNeeded</span>, <span style="color: #63b8ff;">multiROI</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(activateOrCreateNamedROI): Function Entry: "</span>, name, title, message, loadIfNeeded, multiROI);
  exitIfNoImages(<span style="color: #fa8072;">"activateOrCreateNamedROI"</span>);

  run(<span style="color: #fa8072;">"Select None"</span>);

  <span style="color: #00ffff;">if</span> (name == <span style="color: #fa8072;">"ALL"</span>) {
    makeALLroi();
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">do</span> {
      <span style="color: #00ffff;">if</span> (multiROI) {
        roiList = matchingROInames(<span style="color: #fa8072;">"(^"</span> + name + <span style="color: #fa8072;">"_.*$)"</span>);
        <span style="color: #00ffff;">if</span> (roiList.length &gt; 0) {
          Dialog.create(<span style="color: #fa8072;">"PhilaJ: Select "</span> + name + <span style="color: #fa8072;">" ROI"</span>);
          Dialog.addChoice(<span style="color: #fa8072;">"ROI:"</span>, roiList, roiList[0]);
          Dialog.show();
          activateNamedROI(Dialog.getChoice());
          <span style="color: #00ffff;">return</span>;
        }
      }
      <span style="color: #00ffff;">if</span> (activateNamedROI(name) &gt;= 0)
        <span style="color: #00ffff;">return</span>;
      <span style="color: #00ffff;">if</span> (loadIfNeeded) {
        loadAssociatedROIs(<span style="color: #fa8072;">"Need '"</span> + name + <span style="color: #fa8072;">"' ROI!"</span>, <span style="color: #fa8072;">"Clear existing ROIs before loading ROIs from disk?"</span>);
        loadIfNeeded = <span style="color: #8470ff; font-weight: bold;">false</span>;
      } <span style="color: #00ffff;">else</span> {
        waitForUserWithOptCancel(title, message, <span style="color: #8470ff; font-weight: bold;">true</span>);
        <span style="color: #00ffff;">if</span> (selectionType &gt;= 0) {
          Roi.setName(name);
          setKeyDown(<span style="color: #fa8072;">"none"</span>); <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">The ALT key can show as down if we used ALT-TAB to switch to the dialog just before clicking OK</span>
          roiManager(<span style="color: #fa8072;">"add"</span>);
          <span style="color: #00ffff;">return</span>;
        }
      }
    } <span style="color: #00ffff;">while</span> (<span style="color: #8470ff; font-weight: bold;">true</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure angle between two line selections</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">measureEdgeAngle</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(measureEdgeAngle): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"measureEdgeAngle"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
  plu = getImageScaleUnits(<span style="color: #fa8072;">"WARN"</span>);
  waitForUserToMakeSelection(<span style="color: #fa8072;">"measureEdgeAngle"</span>, <span style="color: #fa8072;">"Indicate first edge with line selection"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, 5);
  getLine(x1, y1, x2, y2, lineWidth);
  run(<span style="color: #fa8072;">"Select None"</span>);
  waitForUserToMakeSelection(<span style="color: #fa8072;">"measureEdgeAngle"</span>, <span style="color: #fa8072;">"Indicate second edge with line selection"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, 5);
  getLine(x3, y3, x4, y4, lineWidth);
  run(<span style="color: #fa8072;">"Select None"</span>);
  toScaled(x1, y1);
  toScaled(x2, y2);
  toScaled(x3, y3);
  toScaled(x4, y4);
  lineAngle1 = lineAngle(x1, y1, x2, y2);
  lineAngle2 = lineAngle(x3, y3, x4, y4);
  minAngle   = minAngleBetween(x1, y1, x2, y2, x3, y3, x4, y4);
  minDist    = distSegmentSegment(x1, y1, x2, y2, x3, y3, x4, y4);
  Quantity = newArray(<span style="color: #fa8072;">"Distance Between Edges"</span>,     <span style="color: #fa8072;">"Edge 1 Angle"</span>,     <span style="color: #fa8072;">"Edge 2 Angle"</span>,    <span style="color: #fa8072;">"Angle Between"</span>);
  Value    = newArray(        d2s(minDist,  3), d2s(lineAngle1, 3), d2s(lineAngle2, 3),  d2s(minAngle,  3));
  Units    = newArray(                     plu,          <span style="color: #fa8072;">"degrees"</span>,          <span style="color: #fa8072;">"degrees"</span>,          <span style="color: #fa8072;">"degrees"</span>);
  Array.show(<span style="color: #fa8072;">"PhilaJ: Edge Angle Report"</span>, Quantity, Value, Units);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure angle between coil edges</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">coilEdgeReport</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(coilEdgeReport): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"coilEdgeReport"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  roiNames = newArray(<span style="color: #fa8072;">"L_coil_edge"</span>, <span style="color: #fa8072;">"R_coil_edge"</span>, <span style="color: #fa8072;">"T_coil_edge"</span>, <span style="color: #fa8072;">"B_coil_edge"</span>);

  foundROI = -1;
  lookCount = 0;
  <span style="color: #00ffff;">do</span> {
    lookCount++;
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiNames.length; i++) {
      tmp = existsInROImanagerEqual(roiNames[i]);
      <span style="color: #00ffff;">if</span> (tmp &gt;= 0) {
        foundROI = i;
        <span style="color: #00ffff;">break</span>;
      }
    }
    <span style="color: #00ffff;">if</span> ((foundROI &lt; 0) &amp;&amp; (lookCount == 1))
      loadAssociatedROIs(<span style="color: #fa8072;">"No edge ROIs found."</span>, <span style="color: #fa8072;">"Clear existing ROIs?"</span>);
  } <span style="color: #00ffff;">while</span> ((foundROI &lt; 0) &amp;&amp; (lookCount &lt; 2));

  <span style="color: #00ffff;">if</span> (foundROI &gt;= 0) {
    <span style="color: #00ffff;">if</span> (foundROI &lt; 2)
      gbl_cer_edges = <span style="color: #fa8072;">"Vertical"</span>;
    <span style="color: #00ffff;">else</span>
      gbl_cer_edges = <span style="color: #fa8072;">"Horizontal"</span>;
  } <span style="color: #00ffff;">else</span> {
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Coil Edge Report"</span>);
    Dialog.addChoice(<span style="color: #fa8072;">"Edges:"</span>, newArray(<span style="color: #fa8072;">"Vertical"</span>, <span style="color: #fa8072;">"Horizontal"</span>), gbl_cer_edges);
    Dialog.show();
    gbl_cer_edges = Dialog.getChoice();
  }

  <span style="color: #00ffff;">if</span> (gbl_cer_edges == <span style="color: #fa8072;">"Vertical"</span>) {
    setTool(4);
    activateOrCreateNamedROI(<span style="color: #fa8072;">"L_coil_edge"</span>, <span style="color: #fa8072;">"Identify Left Paper Edge"</span>, <span style="color: #fa8072;">"Select Left Paper Edge"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    getLine(x1, y1, x2, y2, lineWidth);
    run(<span style="color: #fa8072;">"Measure"</span>);
    setTool(4);
    activateOrCreateNamedROI(<span style="color: #fa8072;">"R_coil_edge"</span>, <span style="color: #fa8072;">"Identify Right Paper Edge"</span>, <span style="color: #fa8072;">"Select Right Paper Edge"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    getLine(x3, y3, x4, y4, lineWidth);
    run(<span style="color: #fa8072;">"Measure"</span>);
  } <span style="color: #00ffff;">else</span> {
    setTool(4);
    activateOrCreateNamedROI(<span style="color: #fa8072;">"T_coil_edge"</span>, <span style="color: #fa8072;">"Identify Top Paper Edge"</span>, <span style="color: #fa8072;">"Select Top Paper Edge"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    getLine(x1, y1, x2, y2, lineWidth);
    run(<span style="color: #fa8072;">"Measure"</span>);
    setTool(4);
    activateOrCreateNamedROI(<span style="color: #fa8072;">"B_coil_edge"</span>, <span style="color: #fa8072;">"Identify Bottom Paper Edge"</span>, <span style="color: #fa8072;">"Select Bottom Paper Edge"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    getLine(x3, y3, x4, y4, lineWidth);
    run(<span style="color: #fa8072;">"Measure"</span>);
  }

  toScaled(x1, y1);
  toScaled(x2, y2);
  toScaled(x3, y3);
  toScaled(x4, y4);

  minAngle = minAngleBetween(x1, y1, x2, y2, x3, y3, x4, y4);
  minDist  = distSegmentSegment(x1, y1, x2, y2, x3, y3, x4, y4);

  <span style="color: #00ffff;">if</span> (minAngle &lt; gbl_cer_parThr)
    goodAngle = <span style="color: #fa8072;">"Parallel (&lt;"</span> + gbl_cer_parThr + <span style="color: #fa8072;">")"</span>;
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (minAngle &lt; gbl_cer_nParThr)
    goodAngle = <span style="color: #fa8072;">"Near Parallel (&lt;"</span> + gbl_cer_nParThr + <span style="color: #fa8072;">")"</span>;
  <span style="color: #00ffff;">else</span>
    goodAngle = <span style="color: #fa8072;">"Not Parallel (&gt;="</span> + gbl_cer_nParThr + <span style="color: #fa8072;">")"</span>;

  <span style="color: #00ffff;">if</span> (gbl_cer_edges == <span style="color: #fa8072;">"Vertical"</span>) {
    minSize = gbl_cer_minWid;
    tooSmSt = <span style="color: #fa8072;">"Narrow"</span>;
  } <span style="color: #00ffff;">else</span> {
    minSize = gbl_cer_minTal;
    tooSmSt = <span style="color: #fa8072;">"Short"</span>;
  }

  <span style="color: #00ffff;">if</span>(minDist &lt; minSize)
    goodDist = tooSmSt + <span style="color: #fa8072;">" (&lt;"</span> + minSize + <span style="color: #fa8072;">")"</span>;
  <span style="color: #00ffff;">else</span>
    goodDist = <span style="color: #fa8072;">"Good (&gt;="</span> + minSize + <span style="color: #fa8072;">")"</span>;

  run(<span style="color: #fa8072;">"Select None"</span>);
  selectNamedROIsInManager(<span style="color: #fa8072;">"(.*_coil_edge$)"</span>);
  roiManager(<span style="color: #fa8072;">"Combine"</span>);

  Quantity = newArray(  <span style="color: #fa8072;">"Coil Type"</span>, <span style="color: #fa8072;">"Distance Between Edges"</span>, <span style="color: #fa8072;">"Width Check"</span>, <span style="color: #fa8072;">"Angle Between Edges"</span>,  <span style="color: #fa8072;">"Angle Check"</span>);
  Value    = newArray(gbl_cer_edges,         d2s(minDist,  2),      goodDist,      d2s(minAngle, 2),      goodAngle);
  Units    = newArray(           <span style="color: #fa8072;">""</span>,                     <span style="color: #fa8072;">"mm"</span>,            <span style="color: #fa8072;">""</span>,             <span style="color: #fa8072;">"degrees"</span>,             <span style="color: #fa8072;">""</span>);
  Array.show(<span style="color: #fa8072;">"PhilaJ: Coil Edge Report"</span>, Quantity, Value, Units);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Toggle zoom</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">toggleZoom100</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(toggleZoom100): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"toggleZoom100"</span>);
  <span style="color: #00ffff;">if</span> (abs(getZoom()-1)&lt;0.01) {
    run(<span style="color: #fa8072;">"Original Scale"</span>);
  } <span style="color: #00ffff;">else</span> {
    getCursorLoc(x, y, z, modifiers);
    run(<span style="color: #fa8072;">"Set... "</span>, <span style="color: #fa8072;">"zoom=100 x="</span> + x + <span style="color: #fa8072;">" y="</span> + y);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Zoom to selection</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">zoomToSelection</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(zoomToSelection): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"zoomToSelection"</span>);
  checkSelection(<span style="color: #fa8072;">"zoomToSelection"</span>, <span style="color: #fa8072;">"ANY"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  run(<span style="color: #fa8072;">"To Selection"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Remove overlay and rotate 90</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">rotateRight90</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(rotateRight90): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"rotateRight90"</span>);
  clearOverlay();
  run(<span style="color: #fa8072;">"Rotate 90 Degrees Right"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Check the selection</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">checkSelection</span>(<span style="color: #63b8ff;">srcStr</span>, <span style="color: #63b8ff;">reqSelTypeStr</span>, <span style="color: #63b8ff;">reqArea</span>, <span style="color: #63b8ff;">reqBoxArea</span>, <span style="color: #63b8ff;">exitOnError</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(checkSelection): Function Entry: "</span>, srcStr, reqSelTypeStr, reqArea, reqBoxArea, exitOnError);
  msg = <span style="color: #fa8072;">""</span>;
  <span style="color: #00ffff;">if</span> (selectionType&lt;0) {
    msg += <span style="color: #fa8072;">"ERROR: Selection Required!"</span>;
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> ((reqSelTypeStr != <span style="color: #fa8072;">"ANY"</span>) &amp;&amp; (Roi.getType != reqSelTypeStr))
      msg += <span style="color: #fa8072;">"ERROR: Selection of type "</span> + reqSelTypeStr + <span style="color: #fa8072;">" Required!"</span>;
    <span style="color: #00ffff;">if</span> (reqArea &amp;&amp; ( !(is(<span style="color: #fa8072;">"area"</span>))))
      msg += <span style="color: #fa8072;">"ERROR: Selection must contain an area."</span>;
    <span style="color: #00ffff;">if</span> (reqBoxArea) {
      Roi.getBounds(x, y, width, height);
      <span style="color: #00ffff;">if</span> ((width &lt;= 0) || (height &lt;= 0))
        msg += <span style="color: #fa8072;">"ERROR: Selection must contain an area."</span>;
    }
  }
  <span style="color: #00ffff;">if</span> (msg != <span style="color: #fa8072;">""</span>) {
    <span style="color: #00ffff;">if</span> (exitOnError) {
      exit(msg);
    } <span style="color: #00ffff;">else</span> {
      showMessage(srcStr, msg);
      <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">false</span>;
    }
  }
  <span style="color: #00ffff;">return</span> <span style="color: #8470ff; font-weight: bold;">true</span>;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Select ROIs matching the pattern in the ROI manager.  Return the number of ROIs selected.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">activateNamedROI</span>(<span style="color: #63b8ff;">name</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(activateNamedROI): Function Entry: "</span>, name);
  exitIfNoImages(<span style="color: #fa8072;">"activateNamedROI"</span>);
  tmp = existsInROImanagerEqual(name);
  <span style="color: #00ffff;">if</span> (tmp &gt;= 0) {
    roiManager(<span style="color: #fa8072;">"select"</span>, tmp);
    <span style="color: #00ffff;">return</span> 2;
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">return</span> -1;
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return list of ROI names from the ROI manager that match the pattern</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">matchingROInames</span>(<span style="color: #63b8ff;">strPattern</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(matchingROInames): Function Entry: "</span>, strPattern);
  numROIs = roiManager(<span style="color: #fa8072;">"count"</span>);
  roiList = newArray(numROIs);
  <span style="color: #00ffff;">if</span> (numROIs &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;numROIs; i++)
      roiList[i] = RoiManager.getName(i);
    roiList = Array.filter(roiList, strPattern);
    roiList = Array.sort(roiList);
  }
  <span style="color: #00ffff;">return</span> roiList;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Select ROIs in ROI manager with names matching the the pattern</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Returns the number of ROIs selected</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">selectNamedROIsInManager</span>(<span style="color: #63b8ff;">strPattern</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(selectNamedROIsInManager): Function Entry: "</span>, strPattern);
  numFoundROIs = 0;
  numROIs = roiManager(<span style="color: #fa8072;">"count"</span>);
  roiIndexList = newArray(numROIs);
  <span style="color: #00ffff;">if</span> (numROIs &gt; 0) {
    <span style="color: #00ffff;">for</span>(i=0; i&lt;numROIs; i++)
      <span style="color: #00ffff;">if</span> (matches(RoiManager.getName(i), strPattern))
        roiIndexList[i] = i;
      <span style="color: #00ffff;">else</span>
        roiIndexList[i] = -1;
    roiIndexList = Array.deleteValue(roiIndexList, -1);
    numFoundROIs = roiIndexList.length;
    <span style="color: #00ffff;">if</span> (numFoundROIs &gt; 0)
      roiManager(<span style="color: #fa8072;">"select"</span>, roiIndexList);
  }
  <span style="color: #00ffff;">return</span> numFoundROIs;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for point sets in ROI manager, query the user to select a set, and return the set.  Exits on failure.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">choosePointROIsetName</span>(<span style="color: #63b8ff;">title</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(choosePointROIsetName): Function Entry: "</span>, title);
  roiList = matchingROInames(<span style="color: #fa8072;">"(^pt_.*$)"</span>);
  <span style="color: #00ffff;">if</span> (roiList.length &gt; 0)
    <span style="color: #00ffff;">for</span>(i=0; i&lt;roiList.length; i++)
      roiList[i] = substring(roiList[i], 0, lastIndexOf(roiList[i], <span style="color: #fa8072;">"_"</span>));
  <span style="color: #00ffff;">else</span>
    exit(<span style="color: #fa8072;">"ERROR(choosePointROIsetName): No points found in the ROI manager!"</span>);
  roiList = Array.sort(roiList);
  roiList = arrayRemoveDuplicates(roiList);
  <span style="color: #00ffff;">if</span> (roiList.length &gt; 0) {
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: "</span> + title);
    Dialog.addChoice(<span style="color: #fa8072;">"Point Set:"</span>, roiList, roiList[0]);
    Dialog.show();
    <span style="color: #00ffff;">return</span> Dialog.getChoice();
  } <span style="color: #00ffff;">else</span>
    exit(<span style="color: #fa8072;">"ERROR(choosePointROIsetName): No point sets found in the ROI manager!"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for point sets in ROI manager, query the user to select a set, compute a bounding box for the selected set</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">bulkDeletePointSetROIs</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(bulkDeletePointSetROIs): Function Entry"</span>);
  pointSet = choosePointROIsetName(<span style="color: #fa8072;">"Select a point set"</span>);
  <span style="color: #00ffff;">if</span> (selectNamedROIsInManager(<span style="color: #fa8072;">"(^"</span> + pointSet + <span style="color: #fa8072;">"_.*)"</span>) &gt; 0)
    roiManager(<span style="color: #fa8072;">"delete"</span>);
  <span style="color: #00ffff;">else</span>
    exit(<span style="color: #fa8072;">"ERROR(bulkDeletePointSetROIs): Unable to select points in ROI manager (this is probably a bug)!"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for point sets in ROI manager, query the user to select a set, compute a bounding box for the selected set</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">boundingBoxForPoints</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(boundingBoxForPoints): Function Entry"</span>);
  pointSet = choosePointROIsetName(<span style="color: #fa8072;">"Select a point set"</span>);
  <span style="color: #00ffff;">if</span> (selectNamedROIsInManager(<span style="color: #fa8072;">"(^"</span> + pointSet + <span style="color: #fa8072;">"_.*)"</span>) &gt; 0) {
    roiManager(<span style="color: #fa8072;">"Combine"</span>);
    run(<span style="color: #fa8072;">"To Bounding Box"</span>);
    Roi.setName(<span style="color: #fa8072;">"psBB_"</span> + substring(pointSet, indexOf(pointSet, <span style="color: #fa8072;">"_"</span>)+1));
    roiManager(<span style="color: #fa8072;">"add"</span>);
  } <span style="color: #00ffff;">else</span>
    exit(<span style="color: #fa8072;">"ERROR(boundingBoxForPoints): Unable to select points in ROI manager (this is probably a bug)!"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Slice up a stamp sheet into individual stamps.  Each stamp is placed into a slice in a new image.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">sliceUpSheet</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(sliceUpSheet): Function Entry"</span>);
  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Slice Up Sheet"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Number of Columns:"</span>, gbl_sus_cols, 0, 6, <span style="color: #fa8072;">""</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Number of Rows:"</span>,    gbl_sus_rows, 0, 6, <span style="color: #fa8072;">""</span>);
  Dialog.show();

  gbl_sus_cols = Dialog.getNumber();
  gbl_sus_rows = Dialog.getNumber();

  IID = getImageID();

  <span style="color: #00ffff;">do</span> {
    setTool(0);
    clearOverlay();
    waitForUserWithOptCancel(<span style="color: #fa8072;">"PhilaJ: sliceUpSheet"</span>, <span style="color: #fa8072;">"Adjust Sheet ROI"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    Roi.getBounds(x0, y0, totalWidth, totalHeight);

    width = totalWidth   / gbl_sus_cols;
    height = totalHeight / gbl_sus_rows;

    clearOverlay();
    <span style="color: #00ffff;">for</span>(yi=0; yi&lt;gbl_sus_rows; yi++) {
      <span style="color: #00ffff;">for</span>(xi=0; xi&lt;gbl_sus_cols; xi++) {
        xc = x0 + xi * width;
        yc = y0 + yi * height;
        makeRectangle(xc, yc, width, height);
        Overlay.addSelection(<span style="color: #fa8072;">"red"</span>);
      }
    }
    makeRectangle(x0, y0, width, height);
  } <span style="color: #00ffff;">while</span>( !(getBoolean(<span style="color: #fa8072;">"Good separation?"</span>)));

  newImage(<span style="color: #fa8072;">"stamps"</span>, <span style="color: #fa8072;">"RGB"</span>, width, height, gbl_sus_rows * gbl_sus_cols);
  SIID = getImageID();

  selectImage(IID);
  ovrSize = Overlay.size;
  <span style="color: #00ffff;">for</span> (i=0; i&lt;ovrSize; i++) {
    selectImage(IID);
    Overlay.activateSelection(i);
    Roi.getBounds(xc, yc, width, height);
    Image.copy();
    selectImage(SIID);
    setSlice(i+1);
    Image.paste(0, 0);
  }
  selectImage(SIID);
  setSlice(1);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Shrink the image to make pixels square -- or at least as square as possible.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">shrinkImageToMakeSquarePixels</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(shrinkImageToMakeSquarePixels): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"shrinkImageToMakeSquarePixels"</span>);

  iWidth  = getWidth();
  iHeight = getHeight();

  getPixelSize(scaleUnit, pixelWidth, pixelHeight);

  pixelAspectRatio = pixelWidth / pixelHeight;

  iWidthNew  = iWidth;
  iHeightNew = iHeight;
  <span style="color: #00ffff;">if</span> (pixelWidth &gt; pixelHeight) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Pixels are wider than tall =&gt; Keep width constant and shrink height</span>
    iHeightNew = floor(iHeight * pixelHeight / pixelWidth);
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (pixelWidth &lt; pixelHeight) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Pixels are taller than wide =&gt; Keep height constant and shrink width</span>
    iWidthNew = floor(iWidth * pixelWidth / pixelHeight);

  pixelWidthProj  = iWidth  * pixelWidth  / iWidthNew;
  pixelHeightProj = iHeight * pixelHeight / iHeightNew;

  pixelAspectRatioProj = pixelWidthProj / pixelHeightProj;

  <span style="color: #00ffff;">if</span> (abs(1 - pixelAspectRatio) &gt; abs(1 - pixelAspectRatioProj)) { <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">We have work to do</span>
    scaleReport(<span style="color: #fa8072;">"Before shrinkImageToMakeSquarePixels"</span>);
    run(<span style="color: #fa8072;">"Size..."</span>, <span style="color: #fa8072;">"width="</span> + iWidthNew + <span style="color: #fa8072;">" height="</span> + iHeightNew + <span style="color: #fa8072;">" depth=1 average interpolation=Bilinear"</span>);
    scaleReport(<span style="color: #fa8072;">"After shrinkImageToMakeSquarePixels"</span>);
  } <span style="color: #00ffff;">else</span> {
    showMessage(<span style="color: #fa8072;">"PhilaJ: shrinkImageToMakeSquarePixels"</span>,
                <span style="color: #fa8072;">"Shrink To Square Pixels"</span>,
                <span style="color: #fa8072;">"Pixel Aspect Ratio could not be improved"</span> + <span style="color: #fa8072;">"\n"</span> +
                <span style="color: #fa8072;">"Current pixel aspect ratio: "</span> + d2s(pixelAspectRatio, 10));
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Resize image so that it has the requested DPI.</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Note: Image aspect ratio maintained only if pixels are square.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">resizeToDPI</span>(<span style="color: #63b8ff;">targetDPI</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(resizeToDPI): Function Entry: "</span>, targetDPI);
  exitIfNoImages(<span style="color: #fa8072;">"resizeToDPI"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);

  <span style="color: #00ffff;">if</span> (targetDPI &lt; 0) {
    Dialog.create(<span style="color: #fa8072;">"PhilaJ: Resize To Target DPI"</span>);
    Dialog.addNumber(<span style="color: #fa8072;">"Target DPI:"</span>, gbl_r2d_targDPI, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
    Dialog.show();
    gbl_r2d_targDPI = Dialog.getNumber();
    targetDPI = gbl_r2d_targDPI;
  }

  iWidth  = getWidth();
  iHeight = getHeight();

  getPixelSize(scaleUnit, pixelWidth, pixelHeight);

  pixelWidthTarget  = 25.4 / targetDPI;
  pixelHeightTarget = 25.4 / targetDPI;

  iWidthNew  = round(iWidth  * pixelWidth / pixelWidthTarget);
  iHeightNew = round(iHeight * pixelHeight / pixelHeightTarget);

  <span style="color: #00ffff;">if</span> ((iWidthNew != iWidth) || (iHeightNew != iHeight)) {
    scaleReport(<span style="color: #fa8072;">"Before resizeToDPI"</span>);
    run(<span style="color: #fa8072;">"Size..."</span>, <span style="color: #fa8072;">"width="</span> + iWidthNew + <span style="color: #fa8072;">" height="</span> + iHeightNew + <span style="color: #fa8072;">" depth=1 average interpolation=Bilinear"</span>);
    scaleReport(<span style="color: #fa8072;">"After resizeToDPI"</span>);
  } <span style="color: #00ffff;">else</span> {
    showMessage(<span style="color: #fa8072;">"PhilaJ: resizeToDPI"</span>, <span style="color: #fa8072;">"WARNING: Image was already at requested DPI"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Report data about current image</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">scaleReport</span>(<span style="color: #63b8ff;">strTag</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(scaleReport): Function Entry: "</span>, strTag);
  exitIfNoImages(<span style="color: #fa8072;">"scaleReport"</span>);
  getPixelSize(pixelLengthUnit, hps, vps);
  <span style="color: #00ffff;">if</span> (pixelLengthUnit == <span style="color: #fa8072;">"mm"</span>) {
    ar   = hps/vps;
    hppm = 1/hps;
    vppm = 1/vps;
    hppi = hppm * 25.4;
    vppi = vppm * 25.4;
    hpx  = getWidth();
    vpx  = getHeight();
    his  = hps * hpx;
    vis  = vps * vpx;
    <span style="color: #00ffff;">if</span> (floatEqualish(ar, 1)) {
      Quantity = newArray( <span style="color: #fa8072;">"Pixel Size"</span>,                 <span style="color: #fa8072;">"Pixel Aspect Ratio"</span>,         <span style="color: #fa8072;">"DPI"</span>,                       <span style="color: #fa8072;">"PPMM"</span>,                <span style="color: #fa8072;">"Image Width"</span>, <span style="color: #fa8072;">"Image Height"</span>, <span style="color: #fa8072;">"Image Width"</span>, <span style="color: #fa8072;">"Image Height"</span>);
      Value    = newArray( d2s(hps, 10),                          d2s(ar, 10), d2s(hppi, 10),                d2s(hppm, 10),                 d2s(his, 10),   d2s(vis, 10),  d2s(hpx, 10),   d2s(vpx, 10));
      Units    = newArray(         <span style="color: #fa8072;">"mm"</span>,                                   <span style="color: #fa8072;">""</span>,       <span style="color: #fa8072;">"px/in"</span>,                      <span style="color: #fa8072;">"px/mm"</span>,                         <span style="color: #fa8072;">"mm"</span>,           <span style="color: #fa8072;">"mm"</span>,          <span style="color: #fa8072;">"px"</span>,           <span style="color: #fa8072;">"px"</span>);
    } <span style="color: #00ffff;">else</span> {
      Quantity = newArray(<span style="color: #fa8072;">"Pixel Width"</span>, <span style="color: #fa8072;">"Pixel Height"</span>, <span style="color: #fa8072;">"Pixel Aspect Ratio"</span>,    <span style="color: #fa8072;">"Horz DPI"</span>,    <span style="color: #fa8072;">"Vert DPI"</span>,   <span style="color: #fa8072;">"Horz PPMM"</span>,   <span style="color: #fa8072;">"Vert PPMM"</span>, <span style="color: #fa8072;">"Image Width"</span>, <span style="color: #fa8072;">"Image Height"</span>, <span style="color: #fa8072;">"Image Width"</span>, <span style="color: #fa8072;">"Image Height"</span>);
      Value    = newArray( d2s(hps, 10),   d2s(vps, 10),          d2s(ar, 10), d2s(hppi, 10), d2s(vppi, 10), d2s(hppm, 10), d2s(vppm, 10),  d2s(his, 10),   d2s(vis, 10),  d2s(hpx, 10),   d2s(vpx, 10));
      Units    = newArray(         <span style="color: #fa8072;">"mm"</span>,           <span style="color: #fa8072;">"mm"</span>,                   <span style="color: #fa8072;">""</span>,       <span style="color: #fa8072;">"px/in"</span>,       <span style="color: #fa8072;">"px/in"</span>,       <span style="color: #fa8072;">"px/mm"</span>,       <span style="color: #fa8072;">"px/mm"</span>,          <span style="color: #fa8072;">"mm"</span>,           <span style="color: #fa8072;">"mm"</span>,          <span style="color: #fa8072;">"px"</span>,           <span style="color: #fa8072;">"px"</span>);
    }
    repTitle = <span style="color: #fa8072;">"PhilaJ: Scale Report"</span>;
    <span style="color: #00ffff;">if</span>(strTag != <span style="color: #fa8072;">""</span>)
      repTitle = repTitle + <span style="color: #fa8072;">": "</span> + strTag;
    Array.show(repTitle, Quantity, Value, Units);
  } <span style="color: #00ffff;">else</span> {
    showMessage(scaleReport, <span style="color: #fa8072;">"WARNING: Image has no scale set!"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">This is *VERY* specific to my scanner processing flow.  It queries for a direcotry, finds all *.tif files without</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">corrisponding *.png files (a _&lt;X&gt;dpi.png &amp; _&lt;Y&gt;dpi.png).  It loads each file, sets the scale, scales the image to</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">have square pixles if X!=Y, prompts for a line to rotate the image horizontal, prompts for a crop rectangle, then</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">saves the corrisponding *.png files.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">processScanDirectory</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(processScanDirectory): Function Entry"</span>);
  dirToProc = getDirectory(<span style="color: #fa8072;">"Select a Directory"</span>);
  filesToProc = getFileList(dirToProc);
  <span style="color: #00ffff;">if</span> (filesToProc.length &gt; 0) {
    filesToProc = Array.filter(filesToProc, <span style="color: #fa8072;">"(\\.(tif)$)"</span>);
    <span style="color: #00ffff;">if</span> (filesToProc.length &gt; 0) {
      Dialog.create(<span style="color: #fa8072;">"PhilaJ: Batch Scan Processing"</span>);
      Dialog.addNumber(<span style="color: #fa8072;">"Incoming Horz DPI:"</span>, 2410, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
      Dialog.addNumber(<span style="color: #fa8072;">"Incoming Vert DPI:"</span>, 2398, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
      Dialog.addNumber(<span style="color: #fa8072;">"Thumbnail DPI"</span>,       300, 0, 6, <span style="color: #fa8072;">"DPI"</span>);
      Dialog.show();
      inHdpi  = Dialog.getNumber();
      inVdpi  = Dialog.getNumber();
      thmbDPI = Dialog.getNumber();
      fullString = <span style="color: #fa8072;">"_"</span> + minOf(inHdpi, inVdpi) + <span style="color: #fa8072;">"dpi.png"</span>;
      thmbString = <span style="color: #fa8072;">"_"</span> + thmbDPI               + <span style="color: #fa8072;">"dpi.png"</span>;
      <span style="color: #00ffff;">for</span>(i=0; i&lt;filesToProc.length; i++) {
        currentFile = pathJoin(newArray(dirToProc, filesToProc[i]));
        newBigFileName = replace(currentFile, <span style="color: #fa8072;">".tif"</span>, fullString);
        newThmFileName = replace(currentFile, <span style="color: #fa8072;">".tif"</span>, thmbString);
        <span style="color: #00ffff;">if</span> ( !(File.exists(newBigFileName)) || !(File.exists(newThmFileName))) {
          open(currentFile);
          IID = getImageID();
          setScaleFromDPI(inHdpi, inVdpi);
          <span style="color: #00ffff;">if</span> ( !(floatEqualish(inHdpi, inVdpi)))
            shrinkImageToMakeSquarePixels();
          selectImage(IID);
          waitForUserToMakeSelection(<span style="color: #fa8072;">"processScanDirectory"</span>, <span style="color: #fa8072;">"Make a line selection to rotate horiz"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, 5);
          rotateToHorizontal();
          selectImage(IID);
          waitForUserToMakeSelection(<span style="color: #fa8072;">"processScanDirectory"</span>, <span style="color: #fa8072;">"Make a rectangle selection to crop"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>, 0);
          run(<span style="color: #fa8072;">"Crop"</span>);
          saveAs(<span style="color: #fa8072;">"PNG"</span>, newBigFileName);
          resizeToDPI(300);
          saveAs(<span style="color: #fa8072;">"PNG"</span>, newThmFileName);
          selectImage(IID);
          close();
        }
      }
    }
  }
  showMessage(<span style="color: #fa8072;">"PhilaJ: processScanDirectory"</span>, <span style="color: #fa8072;">"Complete"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Keep shoing a non-modal dialog box with a title/message and optional cancel button till the user makes a selection.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">waitForUserToMakeSelection</span>(<span style="color: #63b8ff;">title</span>, <span style="color: #63b8ff;">message</span>, <span style="color: #63b8ff;">withCancel</span>, <span style="color: #63b8ff;">selType</span>) {
  <span style="color: #00ffff;">if</span> (selType &lt; 0) {
    <span style="color: #00ffff;">if</span> (selectionType &lt; 0) {
      <span style="color: #00ffff;">do</span> {
        waitForUserWithOptCancel(title, message, withCancel);
      } <span style="color: #00ffff;">while</span> (selectionType &lt; 0);
    }
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> (selectionType != selType)   {
      daTool = -1;
      <span style="color: #00ffff;">if</span>     (selType &lt;= 1) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Rectangle, oval, or "ANY"</span>
        daTool = selType;
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span>(selType == 5) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">straight line</span>
        daTool = 4;
      <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span>(selType == 10) <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">point</span>
        daTool = 7;
      <span style="color: #00ffff;">do</span> {
        <span style="color: #00ffff;">if</span> (daTool &gt;= 0)
          setTool(daTool);
        waitForUserWithOptCancel(title, message, withCancel);
      } <span style="color: #00ffff;">while</span> (selectionType != selType);
    }
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">sqrt((x1-x2)^2+(y1-y2)^2)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">hypot2</span>(<span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">y2</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(hypot2): Function Entry: "</span>, x1, y1, x2, y2);
  <span style="color: #00ffff;">return</span> hypot1(x1-x2, y1-y2);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">sqrt(x^2+y^2)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">hypot1</span>(<span style="color: #63b8ff;">x</span>, <span style="color: #63b8ff;">y</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(hypot1): Function Entry: "</span>, x, y);
  <span style="color: #00ffff;">return</span> Math.sqrt(Math.sqr(x)+Math.sqr(y));
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Intersection between two lines: (discriminant, x, y, t1, t2));</span>
<span style="color: #ffa500;">//  </span><span style="color: #ff7f24;">- discriminant . Real number != 0 if lines intersect</span>
<span style="color: #ffa500;">//  </span><span style="color: #ff7f24;">- (x, y) ....... Coordinates of intersection (NaNs if none)</span>
<span style="color: #ffa500;">//  </span><span style="color: #ff7f24;">- t1 &amp; t2 ...... Parametric values for intersection (NaNs if none)</span>
<span style="color: #ffa500;">//                   </span><span style="color: #ff7f24;">i.e. l1(0)=(x1,y1), l1(t1)=(x,y), l1(1)=(x2,y2)</span>
<span style="color: #ffa500;">//                   </span><span style="color: #ff7f24;">i.e. if t1\in[0, 1] =&gt; intersection is in segment 1</span>
<span style="color: #ffa500;">//                   </span><span style="color: #ff7f24;">i.e. if t2\in[0, 1] =&gt; intersection is in segment 2</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">intersectLineLine</span>(<span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y2</span>, <span style="color: #63b8ff;">x3</span>, <span style="color: #63b8ff;">y3</span>, <span style="color: #63b8ff;">x4</span>, <span style="color: #63b8ff;">y4</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(intersectLineLine): Function Entry: "</span>, x1, y1, x2, y2, x3, y3, x4, y4);
  dx12 = (x1 - x2);
  dx13 = (x1 - x3);
  dx34 = (x3 - x4);
  dy12 = (y1 - y2);
  dy13 = (y1 - y3);
  dy34 = (y3 - y4);
  c1212 = (x1 * y2 - y1 * x2);
  c3434 = (x3 * y4 - y3 * x4);
  discriminant = dx12 * dy34 - dy12 * dx34;
  <span style="color: #00ffff;">if</span> (floatEqualish(discriminant, 0)) {
    t1 = NaN;
    t2 = NaN;
    ix = NaN;
    iy = NaN;
  } <span style="color: #00ffff;">else</span> {
    t1 = ( dx13 * dy34 -  dy13 * dx34) / discriminant;
    t2 = ( dx13 * dy12 -  dy13 * dx12) / discriminant;
    ix = (c1212 * dx34 - c3434 * dx12) / discriminant;
    iy = (c1212 * dy34 - c3434 * dy12) / discriminant;
  }
  <span style="color: #00ffff;">return</span> newArray(discriminant, ix, iy, t1, t2);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Boolean.  Is x in [x1-eps, x2+eps]</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">floatClosedIntervalInish</span>(<span style="color: #63b8ff;">x</span>, <span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">x2</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(intersectLineLine): Function Entry: "</span>, x, x1, x2);
  <span style="color: #00ffff;">return</span> (((x1 - 0.00001) &lt;= x) &amp;&amp; ((x2 + 0.00001) &gt;= x));
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Distance between a point (x0, y0) and the line contaiing the two points (x1, y1) &amp; (x2, y2)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">distPtLine</span>(<span style="color: #63b8ff;">x0</span>, <span style="color: #63b8ff;">y0</span>, <span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y2</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(distPtLine): Function Entry: "</span>, x0, y0, x1, y1, x2, y2);
  <span style="color: #00ffff;">return</span> (Math.abs((x2-x1)*(y1-y0)-(x1-x0)*(y2-y1))/hypot2(x1, x2, y1, y2));
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Distance between two segments (x1, y1) -- (x2, y2) &amp;  (x3, y3) -- (x4, y4)</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Distance defininitino: Minimum distance from any segment endpoint to the *line* containing the other segment, or 0 if any *segment* intersects the other *line*</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">This is a usefull definition when segments define alaternate sides of an object -- stamp design, stamp paper edges, etc...</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">distSegmentSegment</span>(<span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y2</span>, <span style="color: #63b8ff;">x3</span>, <span style="color: #63b8ff;">y3</span>, <span style="color: #63b8ff;">x4</span>, <span style="color: #63b8ff;">y4</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(distSegmentSegment): Function Entry: "</span>, x1, y1, x2, y2, x3, y3, x4, y4);
  minDist  = minOf(minOf(distPtLine(x1, y1, x3, y3, x4, y4), distPtLine(x2, y2, x3, y3, x4, y4)),
                   minOf(distPtLine(x3, y3, x1, y1, x2, y2), distPtLine(x4, y4, x1, y1, x2, y2)));

  ip = intersectLineLine(x1, y1, x2, y2, x3, y3, x4, y4);

  <span style="color: #00ffff;">if</span> ( !(floatEqualish(ip[0], 0)))
    <span style="color: #00ffff;">if</span> (floatClosedIntervalInish(ip[3], 0, 1) || floatClosedIntervalInish(ip[4], 0, 1))
      minDist = 0;

  <span style="color: #00ffff;">return</span> minDist;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure angle between the x-axis and the line contaiing the two points (x1, y1) &amp; (x2, y2)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">lineAngle</span>(<span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y2</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(lineAngle): Function Entry: "</span>, x1, y1, x2, y2);
  <span style="color: #00ffff;">return</span> Math.atan2(y1-y2, x2-x1) * 180 / 3.141592653589793;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure minimum angle between the line contaiing the two points (x1, y1) &amp; (x2, y2)</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">and the line contaiing the two points (x3, y3) &amp; (x4, y4)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">minAngleBetween</span>(<span style="color: #63b8ff;">x1</span>, <span style="color: #63b8ff;">y1</span>, <span style="color: #63b8ff;">x2</span>, <span style="color: #63b8ff;">y2</span>, <span style="color: #63b8ff;">x3</span>, <span style="color: #63b8ff;">y3</span>, <span style="color: #63b8ff;">x4</span>, <span style="color: #63b8ff;">y4</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(minAngleBetween): Function Entry: "</span>, x1, y1, x2, y2, x3, y3, x4, y4);
  v1x = x2-x1;
  v1y = y2-y1;
  v2x = x4-x3;
  v2y = y4-y3;
  b   = hypot1(v1x, v1y) * hypot1(v2x, v2y);
  <span style="color: #00ffff;">if</span> (floatEqualish(b, 0)) {
    exit(<span style="color: #fa8072;">"ERROR(minAngleBetween): Division by zero!"</span>);
  } <span style="color: #00ffff;">else</span> {
    a1 = Math.abs(Math.acos((v1x * v2x + v1y * v2y) / b)) * 180 / 3.141592653589793;
    a2 = 180 - a1;
    minAngle = minOf(a1, a2);
    <span style="color: #00ffff;">return</span> minAngle;
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">true if x is near zero, and false otherwise</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">floatEqualish</span>(<span style="color: #63b8ff;">x</span>, <span style="color: #63b8ff;">y</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(floatEqualish): Function Entry: "</span>, x, y);
  <span style="color: #00ffff;">return</span> (Math.abs(x-y) &lt; 0.00001);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Measure angle between two line selections</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">roiOffset</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(roiOffset): Function Entry"</span>);
  exitIfNoImages(<span style="color: #fa8072;">"roiOffset"</span>);
  checkImageScalePhil(<span style="color: #8470ff; font-weight: bold;">false</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
  plu = getImageScaleUnits(<span style="color: #fa8072;">"WARN"</span>);
  waitForUserToMakeSelection(<span style="color: #fa8072;">"roiOffset"</span>, <span style="color: #fa8072;">"Indicate first ROI"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, -1);
  Roi.getBounds(x1, y1, width1, height1);
  run(<span style="color: #fa8072;">"Select None"</span>);
  waitForUserToMakeSelection(<span style="color: #fa8072;">"roiOffset"</span>, <span style="color: #fa8072;">"Indicate second ROI"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>, -1);
  Roi.getBounds(x2, y2, width2, height2);
  run(<span style="color: #fa8072;">"Select None"</span>);
  toScaled(x1, y1);
  toScaled(x2, y2);
  Ox = x2 - x1;
  Oy = y2 - y1;
  d = hypot1(Ox, Oy);
  Quantity = newArray(  <span style="color: #fa8072;">"Distance"</span>, <span style="color: #fa8072;">"X Offset"</span>, <span style="color: #fa8072;">"Y Offset"</span>);
  Value    = newArray(   d2s(d, 3), d2s(Ox, 3), d2s(Oy, 3));
  Units    = newArray(         plu,        plu,       plu);
  Array.show(<span style="color: #fa8072;">"PhilaJ: ROI Offset Report"</span>, Quantity, Value, Units);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Convert length measurement units.  Returns NaN if unit is unknown or input value was NaN!</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertLengthToMM</span>(<span style="color: #63b8ff;">value</span>, <span style="color: #63b8ff;">units</span>) {
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">TODO: Add support for micrometers using getInfo("micrometer.abbreviation")</span>
  <span style="color: #00ffff;">if</span> (units==<span style="color: #fa8072;">"mm"</span>)
    <span style="color: #00ffff;">return</span> (value);
  <span style="color: #00ffff;">else</span> {
    List.clear();
    List.fromArrays(newArray(   <span style="color: #fa8072;">"m"</span>, <span style="color: #fa8072;">"meters"</span>, <span style="color: #fa8072;">"meter"</span>, <span style="color: #fa8072;">"mm"</span>, <span style="color: #fa8072;">"millimeter"</span>, <span style="color: #fa8072;">"millimeters"</span>, <span style="color: #fa8072;">"centimeter"</span>, <span style="color: #fa8072;">"centimeters"</span>, <span style="color: #fa8072;">"cm"</span>, <span style="color: #fa8072;">"inch"</span>, <span style="color: #fa8072;">"inches"</span>,   <span style="color: #fa8072;">"in"</span>,    <span style="color: #fa8072;">"mil"</span>,    <span style="color: #fa8072;">"mils"</span>),
                    newArray(<span style="color: #fa8072;">"1000"</span>,   <span style="color: #fa8072;">"1000"</span>,  <span style="color: #fa8072;">"1000"</span>,  <span style="color: #fa8072;">"1"</span>,          <span style="color: #fa8072;">"1"</span>,           <span style="color: #fa8072;">"1"</span>,         <span style="color: #fa8072;">"10"</span>,          <span style="color: #fa8072;">"10"</span>, <span style="color: #fa8072;">"10"</span>, <span style="color: #fa8072;">"25.4"</span>,   <span style="color: #fa8072;">"25.4"</span>, <span style="color: #fa8072;">"25.4"</span>, <span style="color: #fa8072;">"0.0254"</span>,  <span style="color: #fa8072;">"0.0254"</span>));
    cf = parseFloat(List.get(units));
    <span style="color: #00ffff;">return</span> (cf * value);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Convert perferation measurement units</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertPerfToMM</span>(<span style="color: #63b8ff;">value</span>, <span style="color: #63b8ff;">units</span>) {
  <span style="color: #00ffff;">if</span> (units==<span style="color: #fa8072;">"mm"</span>)
    <span style="color: #00ffff;">return</span> (value);
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (units==<span style="color: #fa8072;">"perfs/2cm"</span>)
    <span style="color: #00ffff;">return</span> (20.0/value);
  <span style="color: #00ffff;">else</span>
    <span style="color: #00ffff;">return</span> (convertLengthToMM(value, units));
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Close all the windows PhilaJ is likely to open -- includeing Measurement Results and the ROI Manager</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">closeAllPhilaJWindows</span>(<span style="color: #63b8ff;">closeBuiltInWindows</span>, <span style="color: #63b8ff;">closeImages</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(closeAllPhilaJWindows): Function Entry: "</span>, closeBuiltInWindows, closeImages);
  <span style="color: #00ffff;">if</span> (closeImages)
    close(<span style="color: #fa8072;">"*"</span>);
  <span style="color: #00ffff;">if</span> (closeBuiltInWindows) {
    close(<span style="color: #fa8072;">"Results"</span>);
    close(<span style="color: #fa8072;">"Roi Manager"</span>);
  }
  close(<span style="color: #fa8072;">"PhilaJ: Centering Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Coil Edge Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Edge Angle Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Grill Data"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: KSP"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Length Conversion"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Perforation Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: ROI Offset Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Scale Report"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Scale Report: After resizeToDPI"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Scale Report: After shrinkImageToMakeSquarePixels"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Scale Report: Before resizeToDPI"</span>);
  close(<span style="color: #fa8072;">"PhilaJ: Scale Report: Before shrinkImageToMakeSquarePixels"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Capture an image.  See piSnap.sh filename conventions.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">configureRPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(configureRPI): Function Entry"</span>);
  <span style="color: #00ffff;">do</span> {
    needMoreData = <span style="color: #8470ff; font-weight: bold;">false</span>;
    Dialog.create(<span style="color: #fa8072;">"Configure RPI Capture Settings"</span>);
    Dialog.addString(<span style="color: #fa8072;">"File group name:"</span>,                               gbl_pic_group, 5);
    Dialog.addString(<span style="color: #fa8072;">"File annotation:"</span>,                               gbl_pic_anno,  15);
    Dialog.addChoice(<span style="color: #fa8072;">"Image Format:"</span>, newArray(<span style="color: #fa8072;">"jpg"</span>, <span style="color: #fa8072;">"png"</span>),          gbl_pic_ifmt);
    Dialog.addChoice(<span style="color: #fa8072;">"Image Size:"</span>, newArray(<span style="color: #fa8072;">"100%"</span>, <span style="color: #fa8072;">"50%"</span>),           gbl_pic_res);
    Dialog.addChoice(<span style="color: #fa8072;">"Capture Preview Scale (1/n):"</span>, gbl_OLT_pviewScl, gbl_pic_pviewScl);
    Dialog.addChoice(<span style="color: #fa8072;">"Live Video Scale (1/n):"</span>, gbl_OLT_pviewScl,      gbl_vid_pviewScl);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Change settings before capture"</span>,               gbl_pic_doSet);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Repeated capture mode"</span>,                        gbl_pic_repeat);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Video preview before capture"</span>,                 gbl_pic_pviewDo);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Load image after capture"</span>,                     gbl_pic_loadem);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Set scale after capture/load"</span>,                 gbl_ALL_doScl);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Debugging"</span>,                                    gbl_ALL_debug);

    Dialog.show();
    gbl_pic_group    = Dialog.getString();
    gbl_pic_anno     = Dialog.getString();
    gbl_pic_ifmt     = Dialog.getChoice();
    gbl_pic_res      = Dialog.getChoice();
    gbl_pic_pviewScl = Dialog.getChoice();
    gbl_vid_pviewScl = Dialog.getChoice();
    gbl_pic_doSet    = Dialog.getCheckbox();
    gbl_pic_repeat   = Dialog.getCheckbox();
    gbl_pic_pviewDo  = Dialog.getCheckbox();
    gbl_pic_loadem   = Dialog.getCheckbox();
    gbl_ALL_doScl    = Dialog.getCheckbox();
    gbl_ALL_debug    = Dialog.getCheckbox();
    <span style="color: #00ffff;">if</span> ( (lengthOf(gbl_pic_group)&gt;0) &amp;&amp; !(matches(gbl_pic_group, <span style="color: #fa8072;">"(^\\p{Alnum}+$)"</span>))) {
      showMessage(<span style="color: #fa8072;">"PhilaJ: configureRPI"</span>, <span style="color: #fa8072;">"ERROR: Group name must contain only alphanumeric characters!"</span>);
      needMoreData = <span style="color: #8470ff; font-weight: bold;">true</span>;
    }
    <span style="color: #00ffff;">if</span> ( (lengthOf(gbl_pic_anno)&gt;0) &amp;&amp; !(matches(gbl_pic_anno, <span style="color: #fa8072;">"(^\\p{Alnum}+$)"</span>))) {
      showMessage(<span style="color: #fa8072;">"PhilaJ: configureRPI"</span>, <span style="color: #fa8072;">"ERROR: Annotation name must contain only alphanumeric characters!"</span>);
      needMoreData = <span style="color: #8470ff; font-weight: bold;">true</span>;
    }
  } <span style="color: #00ffff;">while</span> (needMoreData);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Live video preview</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">videoPreviewFromRPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(videoPreviewFromRPI): Function Entry"</span>);
  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Make sure we have libcamera-still installed -- if we don't, then we are probably</span>
  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">not running on a RPI..</span>
  <span style="color: #00ffff;">if</span> (gbl_pic_useCam)
    <span style="color: #00ffff;">if</span> (!(File.exists(<span style="color: #fa8072;">"/usr/bin/libcamera-still"</span>)))
      exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Could not find /usr/bin/libcamera-still!"</span>);

  <span style="color: #00ffff;">if</span> (gbl_pic_useCam) {
    pList = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"ps -eo pid,comm | grep libcamera- | grep -v grep"</span>);
    <span style="color: #00ffff;">if</span> (lengthOf(pList) &gt; 10)
      exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): libcamera processes are already running!  Can't start video preview.\n\nProcess List:\n"</span> + pList);
  }

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Ask for camera settings</span>
  <span style="color: #00ffff;">if</span> (gbl_pic_doSet) {
    Dialog.create(<span style="color: #fa8072;">"Configure RPI Live Video Settings"</span>);
    Dialog.addChoice(<span style="color: #fa8072;">"Live Video Scale (1/n):"</span>, gbl_OLT_pviewScl, gbl_vid_pviewScl);
    Dialog.addCheckbox(<span style="color: #fa8072;">"Change settings before preview"</span>,          gbl_pic_doSet);
    Dialog.show();
    gbl_vid_pviewScl = Dialog.getChoice();
    gbl_pic_doSet    = Dialog.getCheckbox();
  }

  psv = parseInt(gbl_vid_pviewScl);
  pww = round(4056/psv);
  pwh = round(3040/psv);

  <span style="color: #00ffff;">if</span> (gbl_pic_useCam) {
    setOption(<span style="color: #fa8072;">"WaitForCompletion"</span>, <span style="color: #8470ff; font-weight: bold;">false</span>);
    exec(<span style="color: #fa8072;">"/usr/bin/libcamera-still"</span>, <span style="color: #fa8072;">"-t"</span>, <span style="color: #fa8072;">"0"</span>, <span style="color: #fa8072;">"-p"</span>, <span style="color: #fa8072;">"0,0,"</span> + pww + <span style="color: #fa8072;">","</span> + pwh, <span style="color: #fa8072;">"--info-text"</span>, <span style="color: #fa8072;">"fps:%fps/exp:%exp/a_gain:%ag/d_gain:%dg/focus:%focus"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Capture an image.  See piSnap.sh filename conventions.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">captureImageFromRPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(captureImageFromRPI): Function Entry"</span>);
  needOne = <span style="color: #8470ff; font-weight: bold;">true</span>;
  <span style="color: #00ffff;">while</span> (needOne || gbl_pic_repeat) {
    needOne = <span style="color: #8470ff; font-weight: bold;">false</span>;
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Make sure we have libcamera-still installed -- if we don't, then we are probably</span>
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">not running on a RPI..</span>
    <span style="color: #00ffff;">if</span> (gbl_pic_useCam)
      <span style="color: #00ffff;">if</span> (!(File.exists(<span style="color: #fa8072;">"/usr/bin/libcamera-still"</span>)))
        exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Could not find /usr/bin/libcamera-still!"</span>);

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Make sure we can find the user home directory</span>
    piImagePath = getDirectory(<span style="color: #fa8072;">"home"</span>);
    <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath)))
      exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Could not find home directory!"</span>);

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for ~/Pictures.  Try to create it if it is missing.</span>
    piImagePath = pathJoin(newArray(piImagePath, <span style="color: #fa8072;">"Pictures"</span>));
    <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath))) {
      <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
        print(<span style="color: #fa8072;">"DEBUG(captureImageFromRPI): Attempting to create directory: "</span> + piImagePath);
      File.makeDirectory(piImagePath);
      <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath))) {
        exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Directory creation failed: "</span> + piImagePath);
      }
    }

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Look for ~/Pictures/pi-cam.  Try to create it if it is missing.</span>
    piImagePath = pathJoin(newArray(piImagePath, <span style="color: #fa8072;">"pi-cam"</span>));
    <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath))) {
      <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
        print(<span style="color: #fa8072;">"DEBUG(captureImageFromRPI): Attempting to create directory: "</span> + piImagePath);
      File.makeDirectory(piImagePath);
      <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath))) {
        exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Directory creation failed: "</span> + piImagePath);
      }
    }

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Check again that piImagePath really exists...</span>
    <span style="color: #00ffff;">if</span> (!(File.exists(piImagePath))) {
      exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Could not find/create image directory: "</span> + piImagePath);
    }

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Ask for camera settings</span>
    <span style="color: #00ffff;">if</span> (gbl_pic_doSet)
      configureRPI();

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct filename: timestamp</span>
    piImageFileName = makeDateString();
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct filename: group</span>
    <span style="color: #00ffff;">if</span> (gbl_pic_group != <span style="color: #fa8072;">""</span>)
      piImageFileName = piImageFileName + <span style="color: #fa8072;">"_"</span> + gbl_pic_group;
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct filename: anno</span>
    <span style="color: #00ffff;">if</span> (lengthOf(gbl_pic_anno)&gt;0)
      piImageFileName = piImageFileName + <span style="color: #fa8072;">"-"</span> + gbl_pic_anno;
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct filename: ext</span>
    piImageFileName = piImageFileName + <span style="color: #fa8072;">"."</span> + gbl_pic_ifmt;

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Construct full file name path</span>
    piImageFullFileName = pathJoin(newArray(piImagePath, piImageFileName));
    <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
      print(<span style="color: #fa8072;">"DEBUG(captureImageFromRPI): Image file: "</span> + piImageFullFileName);

    resOpt = <span style="color: #fa8072;">""</span>;
    <span style="color: #00ffff;">if</span> (gbl_pic_res == <span style="color: #fa8072;">"50%"</span>)
      resOpt = <span style="color: #fa8072;">"--width 2028 --height 1520"</span>;

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Run libcamera-still</span>
    <span style="color: #00ffff;">if</span> (gbl_pic_useCam) {

      pList = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"ps -eo pid,comm | grep libcamera- | grep -v grep"</span>);
      <span style="color: #00ffff;">while</span> (lengthOf(pList) &gt; 10) {
        waitForUserWithOptCancel(<span style="color: #fa8072;">"captureImageFromRPI"</span>, <span style="color: #fa8072;">"ERROR: libcamera processes are running.  Please close them.\n\nProcess List:\n"</span> + pList, <span style="color: #8470ff; font-weight: bold;">true</span>);
        pList = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"ps -eo pid,comm | grep libcamera- | grep -v grep"</span>);
      }

      <span style="color: #00ffff;">if</span> (gbl_pic_pviewDo) {
        psv = parseInt(gbl_pic_pviewScl);
        pww = round(4056/psv);
        pwh = round(3040/psv);

        pid = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"libcamera-still -t 0 --info-text 'fps:%fps/exp:%exp/a_gain:%ag/d_gain:%dg/focus:%focus'"</span> + <span style="color: #fa8072;">" -p 0,0,"</span> + pww + <span style="color: #fa8072;">","</span> + pwh + <span style="color: #fa8072;">" -s "</span> + resOpt + <span style="color: #fa8072;">" -e "</span> + gbl_pic_ifmt + <span style="color: #fa8072;">" -o '"</span> + piImageFullFileName + <span style="color: #fa8072;">"' &gt;/dev/null 2&gt;&amp;1 &amp; echo $!"</span>, <span style="color: #fa8072;">"&amp;"</span>);

        pid = String.trim(pid);

        <span style="color: #00ffff;">if</span> ( !(matches(pid, <span style="color: #fa8072;">"(^[0-9][0-9]*$)"</span>)))
          exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Can't get PID of libcamera-still process -- it may not have started!"</span>);

        showMessage(<span style="color: #fa8072;">"PhilaJ: captureImageFromRPI"</span>, <span style="color: #fa8072;">"Click OK to Capture Image"</span>);

        procList = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"ps -eo pid,comm | grep '^ *"</span> + pid + <span style="color: #fa8072;">"  *libcamera-still'"</span>);
        <span style="color: #00ffff;">if</span> (lengthOf(procList) &lt; 10)
          exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Unable to trigger capture (Can't find libcamera-still process)!"</span>);
        showStatus(<span style="color: #fa8072;">"Waiting for capture process"</span>);
        exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"kill -SIGUSR1 "</span> + pid);
        c=1;
        <span style="color: #00ffff;">do</span> {
          showProgress(c, 30);
          wait(40);
          procList = exec(<span style="color: #fa8072;">"/bin/bash"</span>, <span style="color: #fa8072;">"-c"</span>, <span style="color: #fa8072;">"ps -eo pid,cmd | grep '^ *"</span> + pid + <span style="color: #fa8072;">"  *libcamera-still'"</span>);
          c++;
        } <span style="color: #00ffff;">while</span> ( (c&lt;30) &amp;&amp; (lengthOf(procList) &gt; 10));
        wait(100);
      } <span style="color: #00ffff;">else</span> {
        exec(<span style="color: #fa8072;">"libcamera-still -t 1 -n -q 100 "</span> + resOpt + <span style="color: #fa8072;">" -e "</span> + gbl_pic_ifmt + <span style="color: #fa8072;">" -o "</span> + piImageFullFileName);
      }
    } <span style="color: #00ffff;">else</span> {
      <span style="color: #00ffff;">if</span> (gbl_pic_pviewDo)
        showMessage(<span style="color: #fa8072;">"PhilaJ: captureImageFromRPI"</span>, <span style="color: #fa8072;">"Click OK to Capture Image"</span>);
      File.append(<span style="color: #fa8072;">"FAKE RPI CAPTURE"</span>, piImageFullFileName);
    }

    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">If we got an image, then we load it</span>
    <span style="color: #00ffff;">if</span> (File.exists(piImageFullFileName)) {
      <span style="color: #00ffff;">if</span> (gbl_pic_useCam &amp;&amp; gbl_pic_loadem) {
        open(piImageFullFileName);
        <span style="color: #00ffff;">if</span> (gbl_ALL_doScl &amp;&amp; !(isImageScaled()))
          setScaleForMicrograph(<span style="color: #8470ff; font-weight: bold;">true</span>);
      }
    } <span style="color: #00ffff;">else</span> {
      exit(<span style="color: #fa8072;">"ERROR(captureImageFromRPI): Image file not found!: "</span> + piImageFullFileName);
    }

    <span style="color: #00ffff;">if</span> (gbl_pic_repeat &amp;&amp; !(gbl_pic_doSet))
      waitForUserWithOptCancel(<span style="color: #fa8072;">"PhilaJ: captureImageFromRPI"</span>, <span style="color: #fa8072;">"Capture another image?"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Get a list of group names for captured files</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getCaptureGroupsRPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getCaptureGroupsRPI): Function Entry"</span>);
  piFilesDir = pathJoin(newArray(getDirectory(<span style="color: #fa8072;">"home"</span>), <span style="color: #fa8072;">"Pictures"</span>, <span style="color: #fa8072;">"pi-cam"</span>));

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Make sure the pi-cam directory exists</span>
  files = newArray(0);
  <span style="color: #00ffff;">if</span> ( !(File.exists(piFilesDir)))
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">List of files in pi-cam directory</span>
  files = getFileList(piFilesDir);
  <span style="color: #00ffff;">if</span> (files.length == 0)
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Filter out non-image files</span>
  files = Array.filter(files, <span style="color: #fa8072;">"(\\.(png|jpg)$)"</span>);
  <span style="color: #00ffff;">if</span> (files.length == 0)
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Transform to group names</span>
  <span style="color: #00ffff;">for</span>(i=0; i&lt;files.length; i++) {
    <span style="color: #00ffff;">if</span> (matches(files[i], <span style="color: #fa8072;">"(^.............._..*[.-].*)"</span>)) {
      grpEndIndex = indexOf(files[i], <span style="color: #fa8072;">"-"</span>);
      <span style="color: #00ffff;">if</span> (grpEndIndex &lt; 0)
        grpEndIndex = indexOf(files[i], <span style="color: #fa8072;">"."</span>);
      files[i] = substring(files[i], 15, grpEndIndex);
    } <span style="color: #00ffff;">else</span> {
      files[i] = <span style="color: #fa8072;">"_NONE_"</span>;
    }
  }

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Sort group list &amp; remove duplicates</span>
  files = Array.sort(files);
  files = arrayRemoveDuplicates(files);

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Find last file</span>
  <span style="color: #00ffff;">return</span> files;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return the list of captured files in the given groupName</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">"_ANY_" &amp; "_NONE_" are special groups...</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getCaptureFileNamesRPI</span>(<span style="color: #63b8ff;">groupName</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getCaptureFileNamesRPI): Function Entry: "</span>, groupName);
  piFilesDir = pathJoin(newArray(getDirectory(<span style="color: #fa8072;">"home"</span>), <span style="color: #fa8072;">"Pictures"</span>, <span style="color: #fa8072;">"pi-cam"</span>));

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Make sure the pi-cam directory exists</span>
  files = newArray(0);
  <span style="color: #00ffff;">if</span> ( !(File.exists(piFilesDir)))
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">List of files in pi-cam directory</span>
  files = getFileList(piFilesDir);
  <span style="color: #00ffff;">if</span> (files.length == 0)
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Filter out non-image files</span>
  files = Array.filter(files, <span style="color: #fa8072;">"(\\.(png|jpg)$)"</span>);
  <span style="color: #00ffff;">if</span> (files.length == 0)
    <span style="color: #00ffff;">return</span> files;

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Filter out files not in requested group</span>
  <span style="color: #00ffff;">if</span> (groupName == <span style="color: #fa8072;">"_ANY_"</span>) {
    <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Do nothing. ;)</span>
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (groupName == <span style="color: #fa8072;">"_NONE_"</span>) {
    files = Array.filter(files, <span style="color: #fa8072;">"(^..............[.-].*)"</span>);
    <span style="color: #00ffff;">if</span> (files.length == 0)
      <span style="color: #00ffff;">return</span> files;
  } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (lengthOf(groupName)&gt;0) {
    files = Array.filter(files, <span style="color: #fa8072;">"(^.............._"</span> + groupName + <span style="color: #fa8072;">"[-.].*)"</span>);
    <span style="color: #00ffff;">if</span> (files.length == 0)
      <span style="color: #00ffff;">return</span> files;
  }

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Sort file list</span>
  files = Array.sort(files);

  <span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Find last file</span>
  <span style="color: #00ffff;">return</span> files;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Return the filename for the most recent pi-cam capture.  See piSnap.sh filename conventions.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">getCaptureRPI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(getCaptureRPI): Function Entry"</span>);
  allGroups = getCaptureGroupsRPI();
  tmp = newArray(1);
  tmp[0] = <span style="color: #fa8072;">"_ANY_"</span>;
  allGroups = Array.concat(tmp, allGroups);
  <span style="color: #00ffff;">if</span> (gbl_lil_group == <span style="color: #fa8072;">""</span>) {
    <span style="color: #00ffff;">if</span> (gbl_pic_group != <span style="color: #fa8072;">""</span>) {
      gbl_lil_group = gbl_pic_group;
    } <span style="color: #00ffff;">else</span> {
      gbl_lil_group = <span style="color: #fa8072;">"_ALL_"</span>;
    }
  }
  Dialog.create(<span style="color: #fa8072;">"Load Previous RPI Capture(s)"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Capture Group:"</span>, allGroups, gbl_lil_group);
  Dialog.addChoice(<span style="color: #fa8072;">"Which images:"</span>, newArray(<span style="color: #fa8072;">"First"</span>, <span style="color: #fa8072;">"First 10"</span>, <span style="color: #fa8072;">"All"</span>, <span style="color: #fa8072;">"Last 10"</span>, <span style="color: #fa8072;">"Last"</span>), gbl_lil_which);
  Dialog.show();

  gbl_lil_group = Dialog.getChoice();
  gbl_lil_which = Dialog.getChoice();

  files = getCaptureFileNamesRPI(gbl_lil_group);
  len   = files.length;
  <span style="color: #00ffff;">if</span> (indexOf(gbl_lil_which, <span style="color: #fa8072;">" "</span>) &gt; 0)
    num = parseInt(substring(gbl_lil_which, indexOf(gbl_lil_which, <span style="color: #fa8072;">" "</span>)+1));
  <span style="color: #00ffff;">else</span>
    num = 1;
  num = minOf(num, len);
  <span style="color: #00ffff;">if</span> (num &gt; 0) {
    piPath = pathJoin(newArray(getDirectory(<span style="color: #fa8072;">"home"</span>), <span style="color: #fa8072;">"Pictures"</span>, <span style="color: #fa8072;">"pi-cam"</span>));
    <span style="color: #00ffff;">if</span>      (startsWith(gbl_lil_which, <span style="color: #fa8072;">"First"</span>))
      files = Array.slice(files, 0, num);
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (startsWith(gbl_lil_which, <span style="color: #fa8072;">"Last"</span>))
      files = Array.slice(files, len-num, len);
    <span style="color: #00ffff;">for</span>(i=0; i&lt;files.length; i++) {
      open(pathJoin(newArray(piPath, files[i])));
      <span style="color: #00ffff;">if</span> (gbl_ALL_doScl)
        <span style="color: #00ffff;">if</span> ( !(isImageScaled()))
          setScaleForMicrograph(<span style="color: #8470ff; font-weight: bold;">false</span>);
    }
  } <span style="color: #00ffff;">else</span> {
    exit(<span style="color: #fa8072;">"ERROR(getCaptureRPI): No images found!"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Set image scale for RPI Microscope Camera</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">setScaleForMicrograph</span>(<span style="color: #63b8ff;">freshFromCamera</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(setScaleForMicrograph): Function Entry: "</span>, freshFromCamera);
  exitIfNoImages(<span style="color: #fa8072;">"setScaleForMicrograph"</span>);

  Dialog.create(<span style="color: #fa8072;">"Set Scale for Stereo Microscope Photograph"</span>);
  Dialog.addChoice(<span style="color: #fa8072;">"Microscope:"</span>, newArray(<span style="color: #fa8072;">"Leica S8API"</span>),   gbl_ssm_scope);
  Dialog.addChoice(<span style="color: #fa8072;">"Zoom Stop:"</span>,  newArray(<span style="color: #fa8072;">"1.00"</span>, <span style="color: #fa8072;">"8.00"</span>),  gbl_ssm_zoom);
  Dialog.addChoice(<span style="color: #fa8072;">"Auxiliary:"</span>,  newArray(<span style="color: #fa8072;">"0.63"</span>, <span style="color: #fa8072;">"1.00"</span>),  gbl_ssm_aux);
  Dialog.addChoice(<span style="color: #fa8072;">"Video Obj:"</span>,  newArray(<span style="color: #fa8072;">"0.32"</span>, <span style="color: #fa8072;">"0.50"</span>),  gbl_ssm_vobj);
  Dialog.addChoice(<span style="color: #fa8072;">"Camera:"</span>,     newArray(<span style="color: #fa8072;">"RPI"</span>, <span style="color: #fa8072;">"OLY"</span>),    gbl_ssm_cam );
  <span style="color: #00ffff;">if</span> (freshFromCamera)
    Dialog.addMessage(<span style="color: #fa8072;">"Adjust for Resolution: YES"</span>);
  <span style="color: #00ffff;">else</span>
    Dialog.addCheckbox(<span style="color: #fa8072;">"Adjust for Resolution"</span>, gbl_ssm_res);
  Dialog.addCheckbox(<span style="color: #fa8072;">"Global Scale"</span>, gbl_ssm_gbl);
  Dialog.show();

  gbl_ssm_scope = Dialog.getChoice();
  gbl_ssm_zoom  = Dialog.getChoice();
  gbl_ssm_aux   = Dialog.getChoice();
  gbl_ssm_vobj  = Dialog.getChoice();
  gbl_ssm_cam   = Dialog.getChoice();
  <span style="color: #00ffff;">if</span> ( !(freshFromCamera))
    gbl_ssm_res   = Dialog.getCheckbox();
  gbl_ssm_gbl   = Dialog.getCheckbox();

  List.clear();
  List.set(<span style="color: #fa8072;">"Leica S8API"</span>, d2s(0.994507340589, 15));
  scopeCalFactor = parseFloat(List.get(gbl_ssm_scope));

  List.clear();
  List.set(<span style="color: #fa8072;">"OLY"</span>, d2s(5184.0 / 17.4,   10));
  List.set(<span style="color: #fa8072;">"RPI"</span>, d2s(4056.0 / 6.2868, 10));
  ijPixHorzScale = parseFloat(List.get(gbl_ssm_cam)) * parseFloat(gbl_ssm_aux) * parseFloat(gbl_ssm_zoom) * parseFloat(gbl_ssm_vobj) * scopeCalFactor;

  <span style="color: #00ffff;">if</span> (freshFromCamera || gbl_ssm_res) {
    List.clear();
    List.set(<span style="color: #fa8072;">"OLY"</span>, 5184);
    List.set(<span style="color: #fa8072;">"RPI"</span>, 4056);
    sensorRes = parseInt(List.get(gbl_ssm_cam));
    imgWidth  = getWidth();
    <span style="color: #00ffff;">if</span> (sensorRes != imgWidth)
      ijPixHorzScale = ijPixHorzScale * imgWidth / sensorRes;
  }

  ijPixHorzScale = d2s(ijPixHorzScale, 10);

  List.clear();
  List.set(<span style="color: #fa8072;">"OLY"</span>, d2s(5184.0 * 13.0 / 17.4 / 3888.0, 10));
  List.set(<span style="color: #fa8072;">"RPI"</span>, d2s(1.0,                           10));
  ijPixAspectRatio = List.get(gbl_ssm_cam);

  setScaleOptions = <span style="color: #fa8072;">" known=1 unit=mm distance="</span> + ijPixHorzScale + <span style="color: #fa8072;">" pixel="</span> + ijPixAspectRatio;
  <span style="color: #00ffff;">if</span> (gbl_ssm_gbl) {
    setScaleOptions = setScaleOptions + <span style="color: #fa8072;">" global"</span>;
  }

  run(<span style="color: #fa8072;">"Set Scale..."</span>, setScaleOptions);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Takes an integer and returns a zero padded string</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">intToZeroPadString</span>(<span style="color: #63b8ff;">anInt</span>, <span style="color: #63b8ff;">width</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(intToZeroPadString): Function Entry: "</span>, anInt, width);
  result = d2s(anInt, 0);
  <span style="color: #00ffff;">while</span> (lengthOf(result) &lt; width) {
    result = <span style="color: #fa8072;">"0"</span> + result;
  }
  <span style="color: #00ffff;">return</span> result;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Returns a string for the current date/time YYYYMMDDhhmmss</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">makeDateString</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(makeDateString): Function Entry "</span>);
  getDateAndTime(year, month, dayOfWeek, dayOfMonth, hour, minute, second, msec);
  dateBitVal = newArray(year, month+1, dayOfMonth, hour, minute, second);
  dateBitWid = newArray(4, 2, 2, 2, 2, 2);
  dateString = <span style="color: #fa8072;">""</span>;
  <span style="color: #00ffff;">for</span>(i=0; i&lt;6; i++) {
    dateString = dateString + intToZeroPadString(dateBitVal[i], dateBitWid[i]);
  }
  <span style="color: #00ffff;">return</span> dateString;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Check if image has scale.  If not, try to set it or query if RPI iamge.</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">isImageScaled</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(isImageScaled): Function Entry"</span>);
  getPixelSize(pixelLengthUnit, pixelWidth, pixelHeight);
  <span style="color: #00ffff;">return</span> (is(<span style="color: #fa8072;">"global scale"</span>) || ( !(startsWith(pixelLengthUnit, <span style="color: #fa8072;">"pixel"</span>))) || (pixelHeight != 1));
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Takes a SORTED array, and returns a new array with duplicates removed</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">arrayRemoveDuplicates</span>(<span style="color: #63b8ff;">anArray</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(arrayRemoveDuplicates): Function Entry: ("</span> + String.join(anArray, <span style="color: #fa8072;">","</span>) + <span style="color: #fa8072;">")"</span>);
  dedupedArray = newArray(anArray.length);
  dedupedArray[0] = anArray[0];
  <span style="color: #00ffff;">if</span> (anArray.length &gt; 1) {
    j=0;
    <span style="color: #00ffff;">for</span>(i=1; i&lt;anArray.length; i++) {
      <span style="color: #00ffff;">if</span> (dedupedArray[j] != anArray[i]) {
        j++;
        dedupedArray[j] = anArray[i];
      }
    }
    dedupedArray = Array.slice(dedupedArray, 0, j+1);
  }
  <span style="color: #00ffff;">return</span> dedupedArray;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Like waitForUser() but has a cancel button (note: the docs say waitForUser has a cancel button... Bug?)</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">waitForUserWithOptCancel</span>(<span style="color: #63b8ff;">title</span>, <span style="color: #63b8ff;">message</span>, <span style="color: #63b8ff;">withCancel</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(waitForUserWithOptCancel): Function Entry: "</span>, title, message, withCancel);
  <span style="color: #00ffff;">if</span> (withCancel) {
    Dialog.createNonBlocking(title);
    Dialog.addMessage(message);
    Dialog.show();
  } <span style="color: #00ffff;">else</span> {
    waitForUser(title, message);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Exit a macro if no images are open</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">exitIfNoImages</span>(<span style="color: #63b8ff;">srcStr</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(exitIfNoImages): Function Entry: "</span>, srcStr);
  <span style="color: #00ffff;">if</span> (nImages == 0)
    exit(<span style="color: #fa8072;">"ERROR("</span> + srcStr + <span style="color: #fa8072;">"): No open images found!"</span>);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Join path components</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">pathJoin</span>(<span style="color: #63b8ff;">pathComponents</span>) {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(pathJoin): Function Entry: "</span> + String.join(pathComponents, <span style="color: #fa8072;">","</span>));
  anArray = newArray(pathComponents.length);
  <span style="color: #00ffff;">for</span>(i=0; i&lt;anArray.length; i++) {
    tmp = pathComponents[i];
    <span style="color: #00ffff;">do</span> {
      stringDirty = <span style="color: #8470ff; font-weight: bold;">false</span>;
      tmpIdx = lastIndexOf(tmp, File.separator);
      tmpLen = lengthOf(tmp);
      <span style="color: #00ffff;">if</span> (tmpLen &gt; 1) {
        <span style="color: #00ffff;">if</span> ((tmpIdx &gt;= 0) &amp;&amp; (tmpIdx == (tmpLen-1))) {
          tmp = substring(tmp, 0, tmpIdx);
          stringDirty = <span style="color: #8470ff; font-weight: bold;">true</span>;
        }
      }
      <span style="color: #00ffff;">if</span> (i &gt; 0) {
        tmpIdx = indexOf(tmp, File.separator);
        <span style="color: #00ffff;">if</span> (tmpIdx == 0) {
          tmp = substring(tmp, 1);
          stringDirty = <span style="color: #8470ff; font-weight: bold;">true</span>;
        }
      }
    } <span style="color: #00ffff;">while</span>(stringDirty);
    anArray[i] = tmp;
  }
  anArray = Array.deleteValue(anArray, <span style="color: #fa8072;">""</span>);
  <span style="color: #00ffff;">if</span> (anArray.length &gt; 0)
    <span style="color: #00ffff;">return</span> String.join(anArray, File.separator);
  <span style="color: #00ffff;">else</span>
    <span style="color: #00ffff;">return</span> <span style="color: #fa8072;">""</span>;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Delete image file and sidecar file associated with current image window</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">deleteImageAndSidecarFiles</span>(<span style="color: #63b8ff;">closeWindow</span>) {
  exitIfNoImages(<span style="color: #fa8072;">"deleteImageAndSidecarFiles"</span>);

  imageFileName = getInfo(<span style="color: #fa8072;">"image.filename"</span>);
  dirName  = getInfo(<span style="color: #fa8072;">"image.directory"</span>);
  imageFileFullPath = pathJoin(newArray(dirName, imageFileName));

  sidecarFileName = imageFileName;
  tmp = lastIndexOf(sidecarFileName, <span style="color: #fa8072;">"."</span>);
  <span style="color: #00ffff;">if</span>(tmp &gt; 0)
    sidecarFileName = substring(sidecarFileName, 0, tmp);
  sidecarFileName = sidecarFileName + <span style="color: #fa8072;">".roi.zip"</span>;
  sidecarFullPath = pathJoin(newArray(dirName, sidecarFileName));

  filesToDelete = <span style="color: #fa8072;">"Delete Files:"</span>;
  imageExists = <span style="color: #8470ff; font-weight: bold;">false</span>;
  sideExists = <span style="color: #8470ff; font-weight: bold;">false</span>;

  imageWindowTitle = getInfo(<span style="color: #fa8072;">"image.title"</span>);
  <span style="color: #00ffff;">if</span> (closeWindow)
    close(imageWindowTitle);

  <span style="color: #00ffff;">if</span> (File.exists(imageFileFullPath)) {
    filesToDelete = filesToDelete + <span style="color: #fa8072;">"\n   "</span> + imageFileName;
    imageExists = <span style="color: #8470ff; font-weight: bold;">true</span>;
  }

  <span style="color: #00ffff;">if</span> (File.exists(sidecarFullPath)) {
    filesToDelete = filesToDelete + <span style="color: #fa8072;">"\n   "</span> + sidecarFileName;
    sideExists = <span style="color: #8470ff; font-weight: bold;">true</span>;
  }

  <span style="color: #00ffff;">if</span> (imageExists || sideExists) {
    doDelete = getBoolean(filesToDelete);
    <span style="color: #00ffff;">if</span> (doDelete) {
      <span style="color: #00ffff;">if</span> (imageExists)
        File.delete(imageFileFullPath);
      <span style="color: #00ffff;">if</span> (sideExists)
        File.delete(sidecarFullPath);
    }
  } <span style="color: #00ffff;">else</span> {
    showMessage(<span style="color: #fa8072;">"PhilaJ: deleteImageAndSidecarFiles"</span>, <span style="color: #fa8072;">"ERROR: Nothing to delete!"</span>);
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">redraw Last Overlay if no overlay is currently drawn</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">resetOrToggleOverlay</span>() {
  exitIfNoImages(<span style="color: #fa8072;">"resetOrToggleOverlay"</span>);
  <span style="color: #00ffff;">if</span> (Overlay.size &gt; 0) {
    clearOverlay();
  } <span style="color: #00ffff;">else</span> {
    <span style="color: #00ffff;">if</span> (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"dynamicPerfDraw"</span>)
      dynamicPerfDraw(-1, -1, -1, -1, -1, -1);
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"philGrillAction"</span>)
      philGrillAction();
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"instaPerfGaugeAction"</span>)
      instaPerfGaugeAction();
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"philPosFinderAction"</span>)
      philPosFinderAction();
    <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (gbl_ALL_lastPhOvr == <span style="color: #fa8072;">"specializedGaugeAction"</span>)
      specializedGaugeAction();
  }
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Simple tool to compute perfs from distance &amp; hole count</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">convertLengthUI</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(convertLengthUI): Function Entry"</span>);

  Dialog.create(<span style="color: #fa8072;">"PhilaJ: Convert distance to millimeters"</span>);
  Dialog.addNumber(<span style="color: #fa8072;">"Distance:"</span>, gbl_l2l_len, 4, 10, <span style="color: #fa8072;">""</span>);
  Dialog.addToSameRow();
  Dialog.addChoice(<span style="color: #fa8072;">""</span>,          gbl_OLT_lnUnits, gbl_l2l_units);
  Dialog.show();
  gbl_l2l_len    = Dialog.getNumber();
  gbl_l2l_units  = Dialog.getChoice();

  lenInMM = convertLengthToMM(gbl_l2l_len, gbl_l2l_units);

  Value    = newArray(   d2s(gbl_l2l_len, 3), d2s(lenInMM, 3));
  Units    = newArray(         gbl_l2l_units,            <span style="color: #fa8072;">"mm"</span>);
  Array.show(<span style="color: #fa8072;">"PhilaJ: Length Conversion"</span>, Value, Units);
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Options for overlay interaction tool</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">overlayInteractionOptions</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(overlayInteractionAction): Function Entry"</span>);
  overlayType = getOverlayCapPointName();
  <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"dynamicPerfDraw"</span>)
    dynamicPerfOptions(<span style="color: #8470ff; font-weight: bold;">false</span>);
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"philGrillAction"</span>)
    philGrillOptions(<span style="color: #fa8072;">"KEEP"</span>);
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"instaPerfGaugeAction"</span>)
    instaPerfGaugeOptions();
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"philPosFinderAction"</span>)
    philPosFinderOptions();
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"specializedGaugeAction"</span>)
    specializedGaugeOptions();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Process clicks for overlay interaction tool</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">overlayInteractionClicks</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(overlayInteractionClicks): Function Entry"</span>);
  setOption(<span style="color: #fa8072;">"DisablePopupMenu"</span>, <span style="color: #8470ff; font-weight: bold;">true</span>);
  overlayType = getOverlayCapPointName();
  <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"dynamicPerfDraw"</span>)
    dynamicPerfClicks(<span style="color: #8470ff; font-weight: bold;">false</span>);
  <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (overlayType == <span style="color: #fa8072;">"philPosFinderAction"</span>)
    philPosFinderClicks();
  <span style="color: #00ffff;">else</span>
    moveOverlayClicks();
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Remove overlay &amp; clear gbl_ALL_lastPhOvr</span>
<span style="color: #63b8ff;">function</span> <span style="color: #00fa9a; font-weight: bold;">clearOverlay</span>() {
  <span style="color: #00ffff;">if</span> (gbl_ALL_debug)
    print(<span style="color: #fa8072;">"DEBUG(clearOverlay): Function Entry"</span>);
  <span style="color: #00ffff;">if</span> (nImages &gt; 0)
    Overlay.remove;
  gbl_ALL_lastPhOvr = <span style="color: #fa8072;">""</span>;
}

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//// </span><span style="color: #ff7f24;">Code to run when we load</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Nothing here yet... ;)</span>

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//// </span><span style="color: #ff7f24;">Keyboard Macros</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

<span style="color: #ffa500;">// </span><span style="color: #ff7f24;">Nothing here yet... ;)</span>

<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">//// </span><span style="color: #ff7f24;">Toolbar Macros</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span style="color: #ffa500;">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>

macro <span style="color: #fa8072;">"Capture From RPI Camera Action Tool - Cc11 F06fa F16fa F4472 F6333 Ld2e3 Le0e3 Lf2e3 Cfff V5866"</span> {
  captureImageFromRPI();
}

macro <span style="color: #fa8072;">"Setup RPI Camera Action Tool - Cc11 F06fa F16fa F4472 F6333 C000 T5f14s"</span> {
  configureRPI();
}

macro <span style="color: #fa8072;">"Live RPI Video Preview Action Tool - Cc11 L7730 L77f0 F26d9 Cfff F4993 F5875"</span> {
  videoPreviewFromRPI();
}

macro <span style="color: #fa8072;">"Set Scale Action Tool - Cc11 L1cfc L1a1e Lfafe L8b8d L5b5d Lbbbd T4707R T9707P Te707I"</span> {
  setScaleForMicrograph(<span style="color: #8470ff; font-weight: bold;">false</span>);
}

macro <span style="color: #fa8072;">"Open Previous RPI Capture(s) Action Tool - Cc11 L000f L0fff Lfff3 Lf363 L6340 L4000 T3c07R T8c07P Tdc07I"</span> {
  getCaptureRPI();
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
Created by Mitch Richling <<a href="mailto:http://www.mitchr.me/">http://www.mitchr.me/</a>>.  Rendered on 2022-01-24 Mon 11:52 via <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="https://orgmode.org">Org</a> mode 9.4.4)
</div>
</body>
</html>
